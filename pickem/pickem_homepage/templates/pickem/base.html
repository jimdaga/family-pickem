<!DOCTYPE html>
<html lang="en" data-bs-theme="{% if user_theme_preference %}{{ user_theme_preference }}{% else %}light{% endif %}">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LJ2FN8G22Z"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-LJ2FN8G22Z');
    </script>

    <title>{% block title %}Family Pickem{% endblock %}</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="user-authenticated" content="{% if user_authenticated %}true{% else %}false{% endif %}">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <meta name="description" content="Family Pickem - Your ultimate NFL pick 'em league experience">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Heebo:300,400,500,600,700&display=swap">
    
    {% load static %}
    <link rel="shortcut icon" type="image/png" href="{% static 'images/windowlogo.png' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/dark-mode.css' %}">
</head>

<body>
    {% load socialaccount %}
    
    <!-- Main Navigation -->
    <nav class="navbar navbar-expand-lg fixed-top modern-navbar" role="navigation" aria-label="Main navigation">
        <div class="container">
            <!-- Brand Logo -->
            <a class="navbar-brand d-flex align-items-center modern-brand" href="/" aria-label="Family Pickem Home">
                <img src="{% static 'images/logo.png' %}" alt="Family Pickem Logo" class="navbar-logo">
                <span class="brand-text d-none d-sm-inline ms-2">Family Pickem</span>
            </a>

            <!-- Mobile Page Title -->
            <div class="navbar-mobile-title d-lg-none">
                {% block mobile_title %}{% endblock %}
            </div>

            <!-- Mobile Toggle Button -->
            <button class="navbar-toggler modern-toggler" type="button" 
                    data-bs-toggle="collapse" 
                    data-bs-target="#navbarContent" 
                    aria-controls="navbarContent" 
                    aria-expanded="false" 
                    aria-label="Toggle navigation">
                <i class="fas fa-bars"></i>
            </button>

                         <!-- Collapsible Content -->
             <div class="collapse navbar-collapse" id="navbarContent">
                 <!-- Left spacer for centering -->
                 <div class="navbar-nav me-auto"></div>
                 
                 <!-- Centered Main Navigation Links -->
                 <ul class="navbar-nav navbar-nav-center">
                     <li class="nav-item">
                         <a class="nav-link" href="/" aria-label="Home">
                             <i class="fas fa-home"></i>
                         </a>
                     </li>

                     <!-- Scores Dropdown -->
                     <li class="nav-item dropdown">
                         <a class="nav-link dropdown-toggle" href="#" role="button" 
                            data-bs-toggle="dropdown" aria-expanded="false" aria-label="Scores menu">
                             <i class="fas fa-chart-line"></i>
                         </a>
                         <ul class="dropdown-menu">
                             <li><a class="dropdown-item" href="/scores">Current Week</a></li>
                             <li><hr class="dropdown-divider"></li>
                             <li><a class="dropdown-item" href="/scores/competition/1/season/{{ gameseason }}/week/1">Week 1</a></li>
                             <li><a class="dropdown-item" href="/scores/competition/1/season/{{ gameseason }}/week/2">Week 2</a></li>
                             <li><a class="dropdown-item" href="/scores/competition/1/season/{{ gameseason }}/week/3">Week 3</a></li>
                             <li><a class="dropdown-item" href="/scores/competition/1/season/{{ gameseason }}/week/4">Week 4</a></li>
                             <li><a class="dropdown-item" href="/scores/competition/1/season/{{ gameseason }}/week/5">Week 5</a></li>
                             <li><a class="dropdown-item" href="/scores/competition/1/season/{{ gameseason }}/week/6">Week 6</a></li>
                             <li><a class="dropdown-item" href="/scores/competition/1/season/{{ gameseason }}/week/7">Week 7</a></li>
                             <li><a class="dropdown-item" href="/scores/competition/1/season/{{ gameseason }}/week/8">Week 8</a></li>
                             <li><a class="dropdown-item" href="/scores/competition/1/season/{{ gameseason }}/week/9">Week 9</a></li>
                             <li><a class="dropdown-item" href="/scores/competition/1/season/{{ gameseason }}/week/10">Week 10</a></li>
                             <li><a class="dropdown-item" href="/scores/competition/1/season/{{ gameseason }}/week/11">Week 11</a></li>
                             <li><a class="dropdown-item" href="/scores/competition/1/season/{{ gameseason }}/week/12">Week 12</a></li>
                             <li><a class="dropdown-item" href="/scores/competition/1/season/{{ gameseason }}/week/13">Week 13</a></li>
                             <li><a class="dropdown-item" href="/scores/competition/1/season/{{ gameseason }}/week/14">Week 14</a></li>
                             <li><a class="dropdown-item" href="/scores/competition/1/season/{{ gameseason }}/week/15">Week 15</a></li>
                             <li><a class="dropdown-item" href="/scores/competition/1/season/{{ gameseason }}/week/16">Week 16</a></li>
                             <li><a class="dropdown-item" href="/scores/competition/1/season/{{ gameseason }}/week/17">Week 17</a></li>
                             <li><a class="dropdown-item" href="/scores/competition/1/season/{{ gameseason }}/week/18">Week 18</a></li>
                         </ul>
                     </li>

                     <li class="nav-item">
                         <a class="nav-link" href="/standings/" aria-label="Standings">
                             <i class="fas fa-medal"></i>
                         </a>
                     </li>

                     <li class="nav-item">
                         <a class="nav-link" href="/stats/" aria-label="Statistics">
                             <i class="fas fa-chart-bar"></i>
                         </a>
                     </li>

                    <li class="nav-item">
                        <a class="nav-link" href="/rules/" aria-label="Rules">
                            <i class="fas fa-gavel"></i>
                        </a>
                    </li>
                    
                    {% if user_is_commissioner %}
                    <li class="nav-item">
                        <a class="nav-link commissioner-link" href="{% url 'commissioners' %}" aria-label="Commissioners Dashboard">
                            <i class="fas fa-crown"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>

                 <!-- Right Side Navigation -->
                 <ul class="navbar-nav ms-auto nav-right-mobile-center">
                    {% if user.is_authenticated %}
                        <!-- Submit Picks Button -->
                        <li class="nav-item me-3">
                            <a class="btn btn-gradient-primary btn-sm modern-btn" href="/picks" role="button">
                                <i class="fas fa-edit me-1"></i>
                                <span class="d-none d-md-inline">Submit Weekly Picks</span>
                                <span class="d-inline d-md-none">Submit Weekly Picks</span>
                            </a>
                        </li>

                        <!-- User Profile Dropdown -->
                        <li class="nav-item dropdown">
                            <button class="btn btn-outline-light dropdown-toggle d-flex align-items-center modern-user-btn" 
                                    type="button" 
                                    data-bs-toggle="dropdown" 
                                    aria-expanded="false"
                                    aria-label="User menu">
                                <img src="{{ user.socialaccount_set.all.0.get_avatar_url }}" 
                                     alt="Profile picture" 
                                     class="user-avatar me-2">
                                <span class="d-none d-lg-inline user-name-text">
                                    {{ user.socialaccount_set.all.0.extra_data.given_name|default:user.username }}
                                </span>
                            </button>
                            
                            <ul class="dropdown-menu dropdown-menu-end modern-dropdown">
                                <li>
                                    <a class="dropdown-item modern-dropdown-item" href="{% url 'user_profile' user.id %}">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-user-circle me-2"></i>
                                            <div>
                                                <div class="fw-bold">
                                                    {{ user.socialaccount_set.all.0.extra_data.given_name|default:user.username }} 
                                                    {{ user.socialaccount_set.all.0.extra_data.family_name }}
                                                </div>
                                                <small class="text-muted">{{ user.email }}</small>
                                            </div>
                                        </div>
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item modern-dropdown-item" href="{% url 'profile' %}">
                                        <i class="fas fa-edit me-2"></i>Settings
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item modern-dropdown-item" href="/logout">
                                        <i class="fas fa-sign-out-alt me-2"></i>Sign Out
                                    </a>
                                </li>
                            </ul>
                        </li>
                    {% else %}
                        <!-- Login Button -->
                        <li class="nav-item">
                            <a class="btn btn-gradient-primary btn-sm modern-btn" 
                               href="{% provider_login_url 'google' %}" 
                               role="button">
                                <i class="fab fa-google me-1"></i>
                                <span class="d-none d-sm-inline">Sign In with Google</span>
                                <span class="d-inline d-sm-none">Sign In</span>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

      <!-- Banner Section (Optional) -->
      {% block banner %}
      {% if active_banner %}
      <div class="site-banner banner-{{ active_banner.banner_type }}" id="site-banner">
          <div class="container">
              <div class="banner-content">
                  <div class="banner-icon">
                      <i class="{{ active_banner.icon }}"></i>
                  </div>
                  <div class="banner-text">
                      {{ active_banner.title }}
                      {% if active_banner.description %}
                          <div class="banner-description">{{ active_banner.description }}</div>
                      {% endif %}
                  </div>
                  {% if active_banner.show_close_button %}
                  <button type="button" class="banner-close" aria-label="Close banner">
                      <i class="fas fa-times"></i>
                  </button>
                  {% endif %}
              </div>
          </div>
      </div>
      {% elif banner_message or banner_type %}
      <div class="site-banner {% if banner_type %}banner-{{ banner_type }}{% else %}banner-info{% endif %}" id="site-banner">
          <div class="container">
              <div class="banner-content">
                  {% if banner_icon %}
                  <div class="banner-icon">
                      <i class="{{ banner_icon }}"></i>
                  </div>
                  {% endif %}
                  <div class="banner-text">
                      {{ banner_message|safe }}
                  </div>
                  {% if banner_dismissible %}
                  <button type="button" class="banner-close" aria-label="Close banner">
                      <i class="fas fa-times"></i>
                  </button>
                  {% endif %}
              </div>
          </div>
      </div>
      {% endif %}
      {% endblock %}

     <!-- Main Content -->
     <main class="main-content" role="main">
        {% block content %}
            <div class="container">
                <div class="text-center py-5">
                    <p class="text-muted">No content available</p>
                </div>
            </div>
        {% endblock %}
    </main>

    <!-- Bottom Navigation Bar -->
    <nav class="navbar navbar-expand-sm bg-dark navbar-dark fixed-bottom justify-content-center">
    </nav>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.min.js" 
            integrity="sha384-Atwg2Pkwv9vp0ygtn1JAojH0nYbwNJLPhwyoVbhoPwBhjQPR5VtM2+xf0Uwh9KtT" 
            crossorigin="anonymous"></script>
    
    <!-- Custom script for navbar behavior -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const navbar = document.querySelector('.navbar.fixed-top');
        const navbarCollapse = document.getElementById('navbarContent');

        if (navbar && navbarCollapse) {
            navbarCollapse.addEventListener('show.bs.collapse', function () {
                navbar.classList.add('navbar-menu-expanded');
            });
            navbarCollapse.addEventListener('hide.bs.collapse', function () {
                navbar.classList.remove('navbar-menu-expanded');
            });
        }
    });
    </script>
    
    <!-- Banner Functionality -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Check if banner was dismissed this session
        const banner = document.querySelector('.site-banner');
        if (banner) {
            // Create a global banner key - use banner ID or a global key for site-wide dismissal
            const bannerId = banner.id || 'site-banner';
            const bannerKey = 'banner_dismissed_' + bannerId;
            
            console.log('Banner found:', banner);
            console.log('Banner key:', bannerKey);
            console.log('Storage value:', sessionStorage.getItem(bannerKey));
            
            // Choose storage type: sessionStorage (session-only) or localStorage (persistent)
            // sessionStorage = banner reappears after browser restart (recommended for announcements)
            // localStorage = banner stays dismissed permanently until manually cleared
            const storage = sessionStorage; // Change to localStorage for permanent dismissal
            
            // Hide banner if previously dismissed (site-wide)
            if (storage.getItem(bannerKey) === 'true') {
                console.log('Banner hidden due to storage');
                banner.classList.add('banner-hidden');
            } else {
                console.log('Banner should be visible');
                banner.classList.remove('banner-hidden');
            }
            
            // Handle banner dismissal
            const bannerCloseBtn = banner.querySelector('.banner-close');
            if (bannerCloseBtn) {
                bannerCloseBtn.addEventListener('click', function() {
                    // Save dismissal state globally (site-wide)
                    storage.setItem(bannerKey, 'true');
                    console.log('Banner dismissed and stored globally');
                    
                    // Add slide up animation
                    banner.style.animation = 'bannerSlideUp 0.3s ease-out forwards';
                    
                    setTimeout(() => {
                        banner.classList.add('banner-hidden');
                    }, 300);
                });
            }
        }
        
        // Add function to show banner again (for testing/admin)
        window.showBanner = function() {
            const banner = document.querySelector('.site-banner');
            if (banner) {
                const bannerId = banner.id || 'site-banner';
                const bannerKey = 'banner_dismissed_' + bannerId;
                const storage = sessionStorage; // Match the storage type used above
                storage.removeItem(bannerKey);
                banner.classList.remove('banner-hidden');
                banner.style.animation = 'bannerSlideDown 0.3s ease-out';
                console.log('Banner manually shown');
            }
        };
    });
    
    // CSS animation for closing - works with existing styles
    const style = document.createElement('style');
    style.textContent = `
        @keyframes bannerSlideUp {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(-100%);
                opacity: 0;
            }
        }
        
        /* Ensure smooth transitions while respecting existing fixed positioning */
        .site-banner {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        
        /* Override the existing display: none to use transform instead for smoother animation */
        .site-banner.banner-hidden {
            transform: translateY(-100%) !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
    `;
    document.head.appendChild(style);
    </script>

    <!-- Dark Mode JavaScript - Load early for FOUC prevention -->
    <script src="{% static 'css/dark-mode.js' %}"></script>
    
    <!-- Initialize theme from Django backend for authenticated users -->
    {% if user_authenticated %}
    <script>
        // Initialize dark mode from Django backend
        window.DarkMode.init({{ user_dark_mode|yesno:"true,false,null" }});
    </script>
    {% endif %}
</body>
</html>