{% extends 'pickem/base.html' %}
{% load static %}
{% load pickem_homepage_extras %}

{% block title %}Commissioners Dashboard - Family Pickem{% endblock %}

{% block mobile_title %}Commissioners{% endblock %}

{% block content %}
<div class="container commissioners-main-container">
    
    <!-- Page Header -->
    <div class="page-header-section text-center mb-5">
        <div class="row">
            <div class="col-12">
                <div class="page-header-content">
                    {% if user.is_authenticated %}
                        <div class="welcome-section mb-4">
                            <h2 class="welcome-message">
                                Welcome, Agent {{ user.socialaccount_set.all.0.extra_data.given_name|default:user.username }}
                            </h2>
                            <p class="mission-brief">
                                Your mission: Command the league with precision and authority. 
                                The fate of weekly standings rests in your capable hands.
                            </p>
                        </div>
                    {% endif %}
                    <i class="fas fa-crown page-header-icon"></i>
                    <h1 class="page-title">Commissioners Dashboard</h1>
                    <p class="page-subtitle">Classified operations center - authorized personnel only</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
                <i class="fas fa-{{ message.tags|default:'info'|message_icon }} me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Main Dashboard Grid -->
    <div class="row g-4">
        
        <!-- Week Winner Selection -->
        <div class="col-12 col-lg-6">
            <div class="card commissioner-card h-100">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-trophy me-2"></i>
                        Week {{ current_week }} Winner Selection
                    </h3>
                </div>
                <div class="card-body">
                    {% if current_week_winner %}
                        <div class="alert alert-success" role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Week {{ current_week }} Winner Already Set:</strong>
                            {% with current_week_winner.userEmail|lookupname as winner_name %}
                                {{ winner_name }}
                            {% endwith %}
                        </div>
                    {% elif week_candidates %}
                        <div class="week-winner-section">
                            <p class="section-description">
                                Select the winner for Week {{ current_week }}. They will receive 2 bonus points.
                            </p>
                            
                            <!-- Candidates Table -->
                            <div class="candidates-table-container mb-4">
                                <h5 class="mb-3">Top Performers for Week {{ current_week }}:</h5>
                                <div class="table-responsive">
                                    <table class="table table-striped candidates-table">
                                        <thead>
                                            <tr>
                                                <th>Player</th>
                                                <th>Correct Picks</th>
                                                <th>Tiebreaker</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for candidate in week_candidates %}
                                                <tr>
                                                    <td>
                                                        {% with candidate.uid|lookupname as player_name %}
                                                            <strong>{{ player_name }}</strong>
                                                        {% endwith %}
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-primary">{{ candidate.wins }}</span>
                                                    </td>
                                                    <td>
                                                        {% if candidate.tiebreaker_score %}
                                                            {{ candidate.tiebreaker_score }} pts
                                                            {% if candidate.tiebreaker_yards %}
                                                                , {{ candidate.tiebreaker_yards }} yds
                                                            {% endif %}
                                                        {% else %}
                                                            <span class="text-muted">None</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <button type="button" 
                                                                class="btn btn-success btn-sm set-winner-btn"
                                                                data-uid="{{ candidate.uid }}"
                                                                data-week="{{ current_week }}"
                                                                data-gameseason="{{ gameseason }}"
                                                                data-username="{% with candidate.uid|lookupname as player_name %}{{ player_name }}{% endwith %}">
                                                            <i class="fas fa-crown me-1"></i>
                                                            Set Winner
                                                        </button>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-info" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            No candidates available for Week {{ current_week }}. Games may not be completed yet.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Banner Management -->
        <div class="col-12 col-lg-6">
            <div class="card commissioner-card h-100">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-bullhorn me-2"></i>
                        Site Banner Management
                    </h3>
                </div>
                <div class="card-body">
                    
                    <!-- Current Banner Status -->
                    {% if active_banner %}
                        <div class="current-banner-section mb-4">
                            <h5 class="mb-3">Current Active Banner:</h5>
                            <div class="alert alert-{{ active_banner.banner_type }} d-flex align-items-center" role="alert">
                                <i class="{{ active_banner.icon }} me-2"></i>
                                <div class="flex-grow-1">
                                    <strong>{{ active_banner.title }}</strong>
                                    {% if active_banner.description %}
                                        <br><small>{{ active_banner.description }}</small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="banner-actions mb-3">
                                <button type="button" class="btn btn-secondary btn-sm" id="edit-banner-btn">
                                    <i class="fas fa-edit me-1"></i>
                                    Edit Banner
                                </button>
                                <form method="post" action="{% url 'deactivate_banner' %}" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-outline-secondary btn-sm" 
                                            onclick="return confirm('Are you sure you want to deactivate the current banner?')">
                                        <i class="fas fa-times me-1"></i>
                                        Deactivate
                                    </button>
                                </form>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-info mb-4" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            No active banner currently displayed.
                        </div>
                    {% endif %}

                    <!-- Banner Form -->
                    <div class="banner-form-section" id="banner-form-section" {% if not banner_form.errors and active_banner %}style="display: none;"{% endif %}>
                        <h5 class="mb-3">
                            {% if active_banner %}Edit Banner{% else %}Create New Banner{% endif %}
                        </h5>
                        
                        <form method="post" action="{% url 'manage_banner' %}" id="banner-form">
                            {% csrf_token %}
                            {% if active_banner %}
                                <input type="hidden" name="banner_id" value="{{ active_banner.id }}">
                            {% endif %}
                            
                            <div class="row g-3">
                                <!-- Title -->
                                <div class="col-12">
                                    <label for="{{ banner_form.title.id_for_label }}" class="form-label">
                                        {{ banner_form.title.label }}
                                    </label>
                                    {{ banner_form.title }}
                                    {% if banner_form.title.help_text %}
                                        <small class="form-text text-muted">{{ banner_form.title.help_text }}</small>
                                    {% endif %}
                                    {% if banner_form.title.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ banner_form.title.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Description -->
                                <div class="col-12">
                                    <label for="{{ banner_form.description.id_for_label }}" class="form-label">
                                        {{ banner_form.description.label }}
                                    </label>
                                    {{ banner_form.description }}
                                    {% if banner_form.description.help_text %}
                                        <small class="form-text text-muted">{{ banner_form.description.help_text }}</small>
                                    {% endif %}
                                </div>

                                <!-- Banner Type and Icon -->
                                <div class="col-md-6">
                                    <label for="{{ banner_form.banner_type.id_for_label }}" class="form-label">
                                        {{ banner_form.banner_type.label }}
                                    </label>
                                    {{ banner_form.banner_type }}
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ banner_form.icon.id_for_label }}" class="form-label">
                                        {{ banner_form.icon.label }}
                                    </label>
                                    {{ banner_form.icon }}
                                    {% if banner_form.icon.help_text %}
                                        <small class="form-text text-muted">{{ banner_form.icon.help_text }}</small>
                                    {% endif %}
                                </div>

                                <!-- Dates -->
                                <div class="col-md-6">
                                    <label for="{{ banner_form.start_date.id_for_label }}" class="form-label">
                                        {{ banner_form.start_date.label }}
                                    </label>
                                    {{ banner_form.start_date }}
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ banner_form.end_date.id_for_label }}" class="form-label">
                                        {{ banner_form.end_date.label }}
                                    </label>
                                    {{ banner_form.end_date }}
                                </div>

                                <!-- Options -->
                                <div class="col-md-6">
                                    <label for="{{ banner_form.priority.id_for_label }}" class="form-label">
                                        {{ banner_form.priority.label }}
                                    </label>
                                    {{ banner_form.priority }}
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mt-4">
                                        {{ banner_form.show_close_button }}
                                        <label class="form-check-label" for="{{ banner_form.show_close_button.id_for_label }}">
                                            {{ banner_form.show_close_button.label }}
                                        </label>
                                    </div>
                                </div>

                                <!-- Submit Button -->
                                <div class="col-12">
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-1"></i>
                                            {% if active_banner %}Update Banner{% else %}Create Banner{% endif %}
                                        </button>
                                        {% if active_banner %}
                                            <button type="button" class="btn btn-secondary" id="cancel-edit-btn">
                                                <i class="fas fa-times me-1"></i>
                                                Cancel
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Commissioner Features (Future) -->
    <div class="row g-4 mt-2">
        <div class="col-12">
            <div class="card commissioner-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-cogs me-2"></i>
                        Additional Features
                    </h3>
                </div>
                <div class="card-body">
                    <div class="feature-suggestions">
                        <p class="mb-3">Suggested additional commissioner features:</p>
                        <ul class="list-unstyled feature-list">
                            <li><i class="fas fa-users me-2 text-primary"></i>User management and role assignment</li>
                            <li><i class="fas fa-chart-bar me-2 text-primary"></i>Advanced analytics and reporting</li>
                            <li><i class="fas fa-calendar-alt me-2 text-primary"></i>Season schedule management</li>
                            <li><i class="fas fa-envelope me-2 text-primary"></i>Email notification system</li>
                            <li><i class="fas fa-trophy me-2 text-primary"></i>Custom scoring rules configuration</li>
                            <li><i class="fas fa-download me-2 text-primary"></i>Data export and backup tools</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const setWinnerButtons = document.querySelectorAll('.set-winner-btn');
    const editBannerBtn = document.getElementById('edit-banner-btn');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    const bannerFormSection = document.getElementById('banner-form-section');

    // Set Week Winner
    setWinnerButtons.forEach(button => {
        button.addEventListener('click', function() {
            const uid = this.dataset.uid;
            const week = this.dataset.week;
            const gameseason = this.dataset.gameseason;
            const username = this.dataset.username;

            if (confirm(`Are you sure you want to set ${username} as the Week ${week} winner? They will receive 2 bonus points.`)) {
                // Disable all buttons during request
                setWinnerButtons.forEach(btn => btn.disabled = true);

                fetch('{% url "set_week_winner" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        week_number: week,
                        winner_uid: uid,
                        gameseason: gameseason
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message and reload page
                        alert(data.message);
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.error);
                        // Re-enable buttons on error
                        setWinnerButtons.forEach(btn => btn.disabled = false);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while setting the winner.');
                    // Re-enable buttons on error
                    setWinnerButtons.forEach(btn => btn.disabled = false);
                });
            }
        });
    });

    // Banner form toggle
    if (editBannerBtn) {
        editBannerBtn.addEventListener('click', function() {
            bannerFormSection.style.display = 'block';
            this.style.display = 'none';
        });
    }

    if (cancelEditBtn) {
        cancelEditBtn.addEventListener('click', function() {
            bannerFormSection.style.display = 'none';
            if (editBannerBtn) {
                editBannerBtn.style.display = 'inline-block';
            }
        });
    }

    // Auto-format datetime inputs for better UX
    const datetimeInputs = document.querySelectorAll('input[type="datetime-local"]');
    datetimeInputs.forEach(input => {
        if (!input.value) {
            // Set default start date to now
            if (input.name.includes('start_date')) {
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                input.value = now.toISOString().slice(0, 16);
            }
        }
    });
});
</script>

<!-- Custom Styles -->
<style>
.commissioners-main-container {
    padding-top: 2rem;
    padding-bottom: 2rem;
}

.page-header-section {
    border-radius: 1rem;
    padding: 3rem 2rem;
    margin-bottom: 2rem;
    border: 2px solid var(--bs-border-color);
    background: var(--bs-body-bg);
    position: relative;
    overflow: hidden;
}

.page-header-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bs-light);
    opacity: 0.3;
    pointer-events: none;
}

.page-header-content {
    position: relative;
    z-index: 1;
}

.page-header-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: var(--bs-warning);
    opacity: 0.9;
}

.welcome-message {
    font-size: 1.8rem;
    font-weight: 600;
    color: var(--bs-primary);
    margin-bottom: 0.5rem;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.mission-brief {
    font-size: 1rem;
    color: var(--bs-body-color);
    opacity: 0.8;
    font-style: italic;
    margin-bottom: 0;
}

.page-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: var(--bs-body-color);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.page-subtitle {
    font-size: 1.2rem;
    color: var(--bs-body-color);
    opacity: 0.7;
    margin-bottom: 0;
}

.commissioner-card {
    border: none;
    border-radius: 1rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.commissioner-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.commissioner-card .card-header {
    background: var(--bs-light);
    border-bottom: 1px solid var(--bs-border-color);
    border-radius: 1rem 1rem 0 0 !important;
    padding: 1.25rem;
}

.commissioner-card .card-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0;
    color: var(--bs-dark);
}

.commissioner-card .card-body {
    padding: 1.5rem;
}

.candidates-table {
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.candidates-table thead th {
    background: var(--bs-primary);
    color: white;
    border: none;
    font-weight: 600;
    padding: 0.75rem;
}

.candidates-table tbody td {
    padding: 0.75rem;
    vertical-align: middle;
}

.set-winner-btn {
    border-radius: 0.375rem;
    font-weight: 500;
    transition: all 0.15s ease;
}

.set-winner-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(25, 135, 84, 0.3);
}

.feature-list li {
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--bs-border-color);
}

.feature-list li:last-child {
    border-bottom: none;
}

.section-description {
    color: var(--bs-secondary);
    margin-bottom: 1.5rem;
}

.banner-actions .btn {
    margin-right: 0.5rem;
}

/* Dark mode adjustments */
[data-bs-theme="dark"] .page-header-section {
    background: var(--bs-dark);
    border-color: var(--bs-gray-600);
}

[data-bs-theme="dark"] .page-header-section::before {
    background: var(--bs-gray-800);
    opacity: 0.5;
}

[data-bs-theme="dark"] .welcome-message {
    color: var(--bs-info);
}

[data-bs-theme="dark"] .mission-brief {
    color: var(--bs-light);
    opacity: 0.9;
}

[data-bs-theme="dark"] .page-title {
    color: var(--bs-light);
}

[data-bs-theme="dark"] .page-subtitle {
    color: var(--bs-light);
    opacity: 0.8;
}

[data-bs-theme="dark"] .page-header-icon {
    color: var(--bs-warning);
}

[data-bs-theme="dark"] .commissioner-card {
    background: var(--bs-dark);
    border: 1px solid var(--bs-gray-600);
}

[data-bs-theme="dark"] .commissioner-card .card-header {
    background: var(--bs-gray-800);
    border-bottom-color: var(--bs-gray-600);
}

[data-bs-theme="dark"] .commissioner-card .card-title {
    color: var(--bs-light);
}

[data-bs-theme="dark"] .candidates-table thead th {
    background: var(--bs-primary);
}

[data-bs-theme="dark"] .candidates-table tbody td {
    border-color: var(--bs-gray-600);
    color: var(--bs-light);
}

[data-bs-theme="dark"] .feature-list li {
    border-bottom-color: var(--bs-gray-600);
    color: var(--bs-light);
}

[data-bs-theme="dark"] .section-description {
    color: var(--bs-light);
    opacity: 0.8;
}

[data-bs-theme="dark"] .alert-info {
    background-color: var(--bs-gray-800);
    border-color: var(--bs-gray-600);
    color: var(--bs-light);
}

[data-bs-theme="dark"] .alert-info .fas {
    color: var(--bs-info);
}

/* Active banner display styling */
.current-banner-section .alert {
    color: white !important;
}

.current-banner-section .alert strong,
.current-banner-section .alert small {
    color: white !important;
}

[data-bs-theme="dark"] .current-banner-section .alert {
    color: white !important;
}

[data-bs-theme="dark"] .current-banner-section .alert strong,
[data-bs-theme="dark"] .current-banner-section .alert small {
    color: white !important;
}

/* Success/Error message styling */
.alert-success,
.alert-error,
.alert-warning,
.alert-danger {
    color: white !important;
}

[data-bs-theme="dark"] .alert-success,
[data-bs-theme="dark"] .alert-error,
[data-bs-theme="dark"] .alert-warning,
[data-bs-theme="dark"] .alert-danger {
    color: white !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .page-title {
        font-size: 2rem;
    }
    
    .page-subtitle {
        font-size: 1rem;
    }
    
    .page-header-icon {
        font-size: 2.5rem;
    }
    
    .page-header-section {
        padding: 2rem 1rem;
    }
    
    .commissioners-main-container {
        padding-top: 1rem;
        padding-bottom: 1rem;
    }
}
</style>
{% endblock %}
