{% extends 'pickem/base.html' %}
{% load static %}
{% load pickem_homepage_extras %}

{% block title %}Commissioners Dashboard - Family Pickem{% endblock %}

{% block mobile_title %}
    <div class="mobile-subtitle">
        <i class="fas fa-shield-alt mr-2"></i>Commissioners
    </div>
{% endblock %}

{% block content %}
    <!-- Hero Section -->
    <div class="relative text-center mb-6 px-4 py-8 lg:py-12 overflow-hidden bg-gradient-to-br from-blue-600 via-blue-700 to-indigo-700 dark:from-blue-600/30 dark:via-purple-600/20 dark:to-red-600/30 border-2 border-yellow-500 dark:border-yellow-600 shadow-xl rounded-2xl">
        <!-- Subtle background pattern -->
        <div class="absolute inset-0 opacity-20 dark:opacity-5 pointer-events-none"></div>

        <!-- Content -->
        <div class="relative z-10">
            <!-- Commissioner Badge -->
            <img src="{% static 'images/comish.png' %}" alt="Commissioner's Badge" class="w-48 h-48 lg:w-64 lg:h-64 mx-auto mb-4 drop-shadow-lg opacity-95">

            <!-- Title -->
            <h1 class="text-3xl lg:text-5xl font-black tracking-tight mb-2"
                style="font-family: 'Urbanist', sans-serif; text-transform: uppercase; letter-spacing: -0.02em; color: white; -webkit-text-stroke: 3px #FF6B1A; paint-order: stroke fill;">
                Commissioners Dashboard
            </h1>

            <!-- Subtitle -->
            <p class="text-base lg:text-xl text-white/90 dark:text-text-secondary font-medium mb-4">
                Classified operations center - authorized personnel only
            </p>

            <!-- Welcome Message -->
            {% if user.is_authenticated %}
            <div class="mt-6">
                <h2 class="text-2xl lg:text-3xl font-bold text-primary dark:text-blue-400 mb-2">
                    Welcome, Agent {{ user.socialaccount_set.all.0.extra_data.given_name|default:user.username }}
                </h2>
                <p class="text-sm lg:text-base text-white/90 dark:text-text-secondary italic">
                    Your mission: Command the league with precision and authority.
                    The fate of weekly standings rests in your capable hands.
                </p>
            </div>
            {% endif %}
        </div>
    </div>

<div class="max-w-7xl mx-auto px-6 py-6">
    <!-- Alert Messages -->
    {% if messages %}
        <div class="mb-6 space-y-3">
            {% for message in messages %}
                <div class="relative px-4 py-3 rounded-xl border {% if message.tags == 'success' %}bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800 text-green-800 dark:text-green-200{% elif message.tags == 'error' or message.tags == 'danger' %}bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800 text-red-800 dark:text-red-200{% elif message.tags == 'warning' %}bg-yellow-50 dark:bg-yellow-900/20 border-yellow-200 dark:border-yellow-800 text-yellow-800 dark:text-yellow-200{% else %}bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800 text-blue-800 dark:text-blue-200{% endif %}" role="alert">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' or message.tags == 'danger' %}exclamation-triangle{% elif message.tags == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
                        <span class="flex-1">{{ message }}</span>
                        <button type="button" class="text-current opacity-50 hover:opacity-100 transition-opacity" onclick="this.closest('[role=alert]').remove()" aria-label="Close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Main Dashboard Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- Week Winner Selection -->
        <div class="bg-surface-light dark:bg-surface rounded-2xl shadow-card border border-border-light dark:border-border-subtle overflow-hidden hover:shadow-lg transition-all">
            <div class="px-6 py-4 bg-gray-100 dark:bg-gray-800 border-b border-border-light dark:border-border-subtle">
                <h3 class="text-lg font-bold text-text-dark dark:text-white flex items-center gap-2">
                    <i class="fas fa-trophy text-primary"></i>
                    Winner Selection: Week {{ current_week }}
                </h3>
            </div>
            <div class="p-6">
                {% if current_week_winner %}
                    <div class="px-4 py-3 rounded-xl border bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800 text-green-800 dark:text-green-200" role="alert">
                        <i class="fas fa-check-circle mr-2"></i>
                        <strong>Week {{ current_week }} Winner Already Set:</strong>
                        {% with current_week_winner.userID|safe_username as winner_name %}
                            {{ winner_name }}
                        {% endwith %}
                    </div>
                {% elif week_candidates %}
                    <p class="text-text-secondary-light dark:text-text-secondary mb-4">
                        Select the winner for Week {{ current_week }}. They will receive 2 bonus points.
                    </p>

                    <!-- Candidates Table -->
                    <div class="mb-4">
                        <h5 class="mb-3 font-semibold text-text-dark dark:text-white">Top Performers for Week {{ current_week }}:</h5>
                        <div class="overflow-x-auto rounded-xl shadow-md">
                            <table class="w-full">
                                <thead>
                                    <tr class="bg-primary text-white">
                                        <th class="px-4 py-3 text-left font-semibold">Player</th>
                                        <th class="px-4 py-3 text-left font-semibold">Correct Picks</th>
                                        <th class="px-4 py-3 text-left font-semibold">Tiebreaker</th>
                                        <th class="px-4 py-3 text-left font-semibold">Action</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white dark:bg-surface divide-y divide-border-light dark:divide-border-subtle">
                                    {% for candidate in week_candidates %}
                                        <tr class="hover:bg-gray-50 dark:hover:bg-surface-hover transition-colors">
                                            <td class="px-4 py-3">
                                                {% with candidate.uid|lookupname as player_name %}
                                                    <strong class="text-text-dark dark:text-white">{{ player_name }}</strong>
                                                {% endwith %}
                                            </td>
                                            <td class="px-4 py-3">
                                                <span class="inline-block px-2 py-1 bg-primary text-white rounded-md text-sm font-semibold">{{ candidate.wins }}</span>
                                            </td>
                                            <td class="px-4 py-3 text-text-dark dark:text-white">
                                                {% if candidate.tiebreaker_score %}
                                                    {{ candidate.tiebreaker_score }} pts
                                                    {% if candidate.tiebreaker_yards %}
                                                        , {{ candidate.tiebreaker_yards }} yds
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-text-secondary-light dark:text-text-secondary">None</span>
                                                {% endif %}
                                            </td>
                                            <td class="px-4 py-3">
                                                <button type="button"
                                                        class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-semibold transition-all hover:shadow-md flex items-center gap-1 set-winner-btn"
                                                        data-uid="{{ candidate.uid }}"
                                                        data-week="{{ current_week }}"
                                                        data-gameseason="{{ gameseason }}"
                                                        data-username="{% with candidate.uid|lookupname as player_name %}{{ player_name }}{% endwith %}">
                                                    <i class="fas fa-crown"></i>
                                                    Set Winner
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% else %}
                    <div class="px-4 py-3 rounded-xl border bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800 text-blue-800 dark:text-blue-200" role="alert">
                        <i class="fas fa-info-circle mr-2"></i>
                        No candidates available for Week {{ current_week }}. Games may not be completed yet.
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Banner Management -->
        <div class="bg-surface-light dark:bg-surface rounded-2xl shadow-card border border-border-light dark:border-border-subtle overflow-hidden hover:shadow-lg transition-all">
            <div class="px-6 py-4 bg-gray-100 dark:bg-gray-800 border-b border-border-light dark:border-border-subtle">
                <h3 class="text-lg font-bold text-text-dark dark:text-white flex items-center gap-2">
                    <i class="fas fa-bullhorn text-primary"></i>
                    Site Banner Management
                </h3>
            </div>
            <div class="p-6">

                <!-- Current Banner Status -->
                {% if active_banner %}
                    <div class="mb-4">
                        <h5 class="mb-3 font-semibold text-text-dark dark:text-white">Current Active Banner:</h5>
                        <div class="flex items-center gap-2 px-4 py-3 rounded-xl border {% if active_banner.banner_type == 'success' %}bg-green-600 border-green-700{% elif active_banner.banner_type == 'danger' %}bg-red-600 border-red-700{% elif active_banner.banner_type == 'warning' %}bg-yellow-600 border-yellow-700{% else %}bg-blue-600 border-blue-700{% endif %} text-white" role="alert">
                            <i class="{{ active_banner.icon }}"></i>
                            <div class="flex-1">
                                <strong>{{ active_banner.title }}</strong>
                                {% if active_banner.description %}
                                    <br><small class="opacity-90">{{ active_banner.description }}</small>
                                {% endif %}
                            </div>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button type="button" class="px-3 py-1.5 bg-gray-500 hover:bg-gray-600 text-white rounded-lg text-sm font-semibold transition-colors flex items-center gap-1" id="edit-banner-btn">
                                <i class="fas fa-edit"></i>
                                Edit Banner
                            </button>
                            <form method="post" action="{% url 'deactivate_banner' %}" class="inline">
                                {% csrf_token %}
                                <button type="submit" class="px-3 py-1.5 border-2 border-gray-400 dark:border-gray-500 text-text-dark dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-sm font-semibold transition-colors flex items-center gap-1"
                                        onclick="return confirm('Are you sure you want to deactivate the current banner?')">
                                    <i class="fas fa-times"></i>
                                    Deactivate
                                </button>
                            </form>
                        </div>
                    </div>
                {% else %}
                    <div class="px-4 py-3 rounded-xl border bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800 text-blue-800 dark:text-blue-200 mb-4" role="alert">
                        <i class="fas fa-info-circle mr-2"></i>
                        No active banner currently displayed.
                    </div>
                {% endif %}

                <!-- Banner Form -->
                <div id="banner-form-section" {% if not banner_form.errors and active_banner %}class="hidden"{% endif %}>
                    <h5 class="mb-3 font-semibold text-text-dark dark:text-white">
                        {% if active_banner %}Edit Banner{% else %}Create New Banner{% endif %}
                    </h5>

                    <form method="post" action="{% url 'manage_banner' %}" id="banner-form">
                        {% csrf_token %}
                        {% if active_banner %}
                            <input type="hidden" name="banner_id" value="{{ active_banner.id }}">
                        {% endif %}

                        <div class="space-y-4">
                            <!-- Title -->
                            <div>
                                <label for="{{ banner_form.title.id_for_label }}" class="block text-sm font-semibold text-text-dark dark:text-white mb-2">
                                    {{ banner_form.title.label }}
                                </label>
                                {{ banner_form.title }}
                                {% if banner_form.title.help_text %}
                                    <small class="block mt-1 text-xs text-text-secondary-light dark:text-text-secondary">{{ banner_form.title.help_text }}</small>
                                {% endif %}
                                {% if banner_form.title.errors %}
                                    <div class="mt-1 text-sm text-red-600 dark:text-red-400">
                                        {{ banner_form.title.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Description -->
                            <div>
                                <label for="{{ banner_form.description.id_for_label }}" class="block text-sm font-semibold text-text-dark dark:text-white mb-2">
                                    {{ banner_form.description.label }}
                                </label>
                                {{ banner_form.description }}
                                {% if banner_form.description.help_text %}
                                    <small class="block mt-1 text-xs text-text-secondary-light dark:text-text-secondary">{{ banner_form.description.help_text }}</small>
                                {% endif %}
                            </div>

                            <!-- Banner Type and Icon -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="{{ banner_form.banner_type.id_for_label }}" class="block text-sm font-semibold text-text-dark dark:text-white mb-2">
                                        {{ banner_form.banner_type.label }}
                                    </label>
                                    {{ banner_form.banner_type }}
                                </div>
                                <div>
                                    <label for="{{ banner_form.icon.id_for_label }}" class="block text-sm font-semibold text-text-dark dark:text-white mb-2">
                                        {{ banner_form.icon.label }}
                                    </label>
                                    {{ banner_form.icon }}
                                    {% if banner_form.icon.help_text %}
                                        <small class="block mt-1 text-xs text-text-secondary-light dark:text-text-secondary">{{ banner_form.icon.help_text }}</small>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Dates -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="{{ banner_form.start_date.id_for_label }}" class="block text-sm font-semibold text-text-dark dark:text-white mb-2">
                                        {{ banner_form.start_date.label }}
                                    </label>
                                    {{ banner_form.start_date }}
                                </div>
                                <div>
                                    <label for="{{ banner_form.end_date.id_for_label }}" class="block text-sm font-semibold text-text-dark dark:text-white mb-2">
                                        {{ banner_form.end_date.label }}
                                    </label>
                                    {{ banner_form.end_date }}
                                </div>
                            </div>

                            <!-- Options -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="{{ banner_form.priority.id_for_label }}" class="block text-sm font-semibold text-text-dark dark:text-white mb-2">
                                        {{ banner_form.priority.label }}
                                    </label>
                                    {{ banner_form.priority }}
                                </div>
                                <div class="flex items-center pt-8">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        {{ banner_form.show_close_button }}
                                        <span class="text-sm font-medium text-text-dark dark:text-white">{{ banner_form.show_close_button.label }}</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="flex gap-2 pt-2">
                                <button type="submit" class="px-6 py-2.5 bg-primary hover:bg-primary/80 text-white rounded-lg font-semibold transition-colors flex items-center gap-2">
                                    <i class="fas fa-save"></i>
                                    {% if active_banner %}Update Banner{% else %}Create Banner{% endif %}
                                </button>
                                {% if active_banner %}
                                    <button type="button" class="px-6 py-2.5 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-semibold transition-colors flex items-center gap-2" id="cancel-edit-btn">
                                        <i class="fas fa-times"></i>
                                        Cancel
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Manual Pick Submission -->
        <div class="lg:col-span-2 bg-surface-light dark:bg-surface rounded-2xl shadow-card border border-border-light dark:border-border-subtle overflow-hidden">
            <div class="px-6 py-4 bg-gray-100 dark:bg-gray-800 border-b border-border-light dark:border-border-subtle">
                <h3 class="text-lg font-bold text-text-dark dark:text-white flex items-center gap-2">
                    <i class="fas fa-user-edit text-primary"></i>
                    Manual Pick Submission
                </h3>
            </div>
            <div class="p-6">
                <p class="text-text-secondary-light dark:text-text-secondary mb-6">
                    Submit picks on behalf of users who missed the deadline or can't get online.
                    Commissioners can submit picks even for locked games.
                </p>

                <!-- User Selection -->
                <div class="mb-4">
                    <label for="userSelect" class="block text-sm font-semibold text-text-dark dark:text-white mb-2">
                        <i class="fas fa-user mr-1"></i>
                        Select User:
                    </label>
                    <select id="userSelect" class="w-full px-4 py-2.5 bg-white dark:bg-surface border border-border-light dark:border-border-subtle rounded-lg text-text-dark dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
                        <option value="">Choose a user...</option>
                        {% for user in active_users %}
                            <option value="{{ user.id }}" data-username="{{ user.username }}" data-email="{{ user.email }}">
                                {{ user.username }}
                                {% if user.first_name or user.last_name %}
                                    ({{ user.first_name }} {{ user.last_name }})
                                {% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Current User Info -->
                <div id="currentUserInfo" class="hidden mb-4">
                    <div class="px-4 py-3 rounded-xl border bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800 text-blue-800 dark:text-blue-200">
                        <i class="fas fa-info-circle mr-2"></i>
                        <strong>Submitting picks for:</strong> <span id="selectedUserName"></span>
                        <br><small>Week {{ current_week }} - {{ current_competition|title }}</small>
                    </div>
                </div>

                <!-- Games List -->
                <div id="gamesList" class="hidden">
                    <h5 class="mb-3 font-semibold text-text-dark dark:text-white">Week {{ current_week }} Games:</h5>

                    {% if current_week_games %}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            {% for game in current_week_games %}
                            <div class="manual-game-card border border-border-light dark:border-border-subtle rounded-xl p-4 bg-white dark:bg-surface hover:shadow-md transition-shadow" data-game-id="{{ game.id }}">
                                <div class="flex justify-between items-center mb-3 pb-2 border-b border-border-light dark:border-border-subtle">
                                    <div class="text-sm font-medium text-text-secondary-light dark:text-text-secondary">
                                        {{ game.startTimestamp|date:"M d @ g:i A" }}
                                    </div>
                                    {% if game.statusType != 'notstarted' %}
                                    <div class="text-xs text-yellow-600 dark:text-yellow-500 bg-yellow-100 dark:bg-yellow-900/30 px-2 py-1 rounded">
                                        <i class="fas fa-lock mr-1"></i>
                                        Started
                                    </div>
                                    {% endif %}
                                </div>

                                <div class="flex items-center gap-3 mb-3">
                                    <!-- Away Team -->
                                    <div class="team-option-manual flex-1 flex items-center gap-2 p-3 border-2 border-border-light dark:border-border-subtle rounded-lg cursor-pointer hover:border-primary dark:hover:border-primary transition-all relative" data-team="{{ game.awayTeamSlug }}" data-team-name="{{ game.awayTeamName }}">
                                        <div class="flex items-center gap-2 flex-1">
                                            {% with game.awayTeamSlug|lookuplogo as logo_url %}
                                            <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}"
                                                 alt="{{ game.awayTeamName }} logo"
                                                 class="w-8 h-8 object-contain">
                                            {% endwith %}
                                            <div class="flex-1">
                                                <div class="text-sm font-semibold text-text-dark dark:text-white leading-tight">{{ game.awayTeamName }}</div>
                                                <div class="text-xs text-text-secondary-light dark:text-text-secondary">
                                                    {% for team in team_records %}
                                                        {% if team.teamNameSlug == game.awayTeamSlug %}
                                                            {% if team.teamTies > 0 %}
                                                                ({{ team.teamWins }}-{{ team.teamLosses }}-{{ team.teamTies }})
                                                            {% else %}
                                                                ({{ team.teamWins }}-{{ team.teamLosses }})
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="pick-indicator-manual absolute -top-2 -right-2 w-5 h-5 bg-green-600 text-white rounded-full hidden items-center justify-center text-xs">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    </div>

                                    <div class="text-xs font-semibold text-text-secondary-light dark:text-text-secondary">@</div>

                                    <!-- Home Team -->
                                    <div class="team-option-manual flex-1 flex items-center gap-2 p-3 border-2 border-border-light dark:border-border-subtle rounded-lg cursor-pointer hover:border-primary dark:hover:border-primary transition-all relative" data-team="{{ game.homeTeamSlug }}" data-team-name="{{ game.homeTeamName }}">
                                        <div class="flex items-center gap-2 flex-1">
                                            {% with game.homeTeamSlug|lookuplogo as logo_url %}
                                            <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}"
                                                 alt="{{ game.homeTeamName }} logo"
                                                 class="w-8 h-8 object-contain">
                                            {% endwith %}
                                            <div class="flex-1">
                                                <div class="text-sm font-semibold text-text-dark dark:text-white leading-tight">{{ game.homeTeamName }}</div>
                                                <div class="text-xs text-text-secondary-light dark:text-text-secondary">
                                                    {% for team in team_records %}
                                                        {% if team.teamNameSlug == game.homeTeamSlug %}
                                                            {% if team.teamTies > 0 %}
                                                                ({{ team.teamWins }}-{{ team.teamLosses }}-{{ team.teamTies }})
                                                            {% else %}
                                                                ({{ team.teamWins }}-{{ team.teamLosses }})
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="pick-indicator-manual absolute -top-2 -right-2 w-5 h-5 bg-green-600 text-white rounded-full hidden items-center justify-center text-xs">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tiebreaker Section -->
                                {% if game.tieBreakerGame %}
                                <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-3 mb-3">
                                    <div class="text-sm font-semibold text-primary mb-2 flex items-center gap-1">
                                        <i class="fas fa-balance-scale"></i>
                                        Tiebreakers Required
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs font-medium text-text-dark dark:text-white mb-1">Total Points:</label>
                                            <input type="number"
                                                   class="w-full px-3 py-1.5 text-sm bg-white dark:bg-surface border border-border-light dark:border-border-subtle rounded-lg text-text-dark dark:text-white focus:outline-none focus:ring-2 focus:ring-primary tiebreaker-score"
                                                   placeholder="e.g. 45"
                                                   min="0"
                                                   max="200">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-text-dark dark:text-white mb-1">Total Yards:</label>
                                            <input type="number"
                                                   class="w-full px-3 py-1.5 text-sm bg-white dark:bg-surface border border-border-light dark:border-border-subtle rounded-lg text-text-dark dark:text-white focus:outline-none focus:ring-2 focus:ring-primary tiebreaker-yards"
                                                   placeholder="e.g. 750"
                                                   min="0"
                                                   max="2000">
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Pick Status -->
                                <div class="text-center text-xs mt-2">
                                    <span class="no-pick-indicator text-text-secondary-light dark:text-text-secondary">No pick selected</span>
                                    <span class="pick-saved-indicator text-green-600 dark:text-green-400 font-medium hidden">
                                        <i class="fas fa-check-circle mr-1"></i>
                                        Pick saved
                                    </span>
                                </div>

                                <!-- Hidden data -->
                                <input type="hidden" class="game-slug" value="{{ game.slug }}">
                                <input type="hidden" class="game-competition" value="{{ game.competition }}">
                                <input type="hidden" class="game-week" value="{{ game.gameWeek }}">
                                <input type="hidden" class="game-year" value="{{ game.gameyear }}">
                                <input type="hidden" class="game-season" value="{{ game.gameseason }}">
                                <input type="hidden" class="is-tiebreaker" value="{{ game.tieBreakerGame|yesno:'true,false' }}">
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Submit All Button -->
                        <div class="flex items-center gap-3 pt-4 border-t border-border-light dark:border-border-subtle">
                            <button type="button" id="submitAllPicks" class="px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fas fa-save"></i>
                                Submit All Picks
                            </button>
                            <button type="button" id="clearAllPicks" class="px-6 py-2.5 border-2 border-gray-400 dark:border-gray-500 text-text-dark dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg font-semibold transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fas fa-times"></i>
                                Clear All
                            </button>
                            <div class="submission-status hidden ml-3">
                                <span class="submitting-indicator text-primary hidden">
                                    <i class="fas fa-spinner fa-spin mr-1"></i>
                                    Submitting picks...
                                </span>
                                <span class="success-indicator text-green-600 dark:text-green-400 hidden">
                                    <i class="fas fa-check-circle mr-1"></i>
                                    All picks submitted successfully!
                                </span>
                                <span class="error-indicator text-red-600 dark:text-red-400 hidden">
                                    <i class="fas fa-exclamation-circle mr-1"></i>
                                    Error submitting picks
                                </span>
                            </div>
                        </div>
                    {% else %}
                        <div class="px-4 py-3 rounded-xl border bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800 text-blue-800 dark:text-blue-200">
                            <i class="fas fa-info-circle mr-2"></i>
                            No games available for Week {{ current_week }}.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const setWinnerButtons = document.querySelectorAll('.set-winner-btn');
    const editBannerBtn = document.getElementById('edit-banner-btn');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    const bannerFormSection = document.getElementById('banner-form-section');

    // Set Week Winner
    setWinnerButtons.forEach(button => {
        button.addEventListener('click', function() {
            const uid = this.dataset.uid;
            const week = this.dataset.week;
            const gameseason = this.dataset.gameseason;
            const username = this.dataset.username;

            if (confirm(`Are you sure you want to set ${username} as the Week ${week} winner? They will receive 2 bonus points.`)) {
                // Disable all buttons during request
                setWinnerButtons.forEach(btn => btn.disabled = true);

                fetch('{% url "set_week_winner" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        week_number: week,
                        winner_uid: uid,
                        gameseason: gameseason
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message and reload page
                        alert(data.message);
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.error);
                        // Re-enable buttons on error
                        setWinnerButtons.forEach(btn => btn.disabled = false);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while setting the winner.');
                    // Re-enable buttons on error
                    setWinnerButtons.forEach(btn => btn.disabled = false);
                });
            }
        });
    });

    // Banner form toggle
    if (editBannerBtn) {
        editBannerBtn.addEventListener('click', function() {
            bannerFormSection.classList.remove('hidden');
            this.classList.add('hidden');
        });
    }

    if (cancelEditBtn) {
        cancelEditBtn.addEventListener('click', function() {
            bannerFormSection.classList.add('hidden');
            if (editBannerBtn) {
                editBannerBtn.classList.remove('hidden');
            }
        });
    }

    // Auto-format datetime inputs for better UX
    const datetimeInputs = document.querySelectorAll('input[type="datetime-local"]');
    datetimeInputs.forEach(input => {
        if (!input.value) {
            // Set default start date to now
            if (input.name.includes('start_date')) {
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                input.value = now.toISOString().slice(0, 16);
            }
        }
    });

    // Manual Pick Submission Functionality
    const userSelect = document.getElementById('userSelect');
    const currentUserInfo = document.getElementById('currentUserInfo');
    const selectedUserName = document.getElementById('selectedUserName');
    const gamesList = document.getElementById('gamesList');
    const submitAllPicks = document.getElementById('submitAllPicks');
    const clearAllPicks = document.getElementById('clearAllPicks');
    const submissionStatus = document.querySelector('.submission-status');

    let selectedUserId = null;
    let selectedUserData = null;
    let userPicks = {};

    // User selection handler
    if (userSelect) {
        userSelect.addEventListener('change', function() {
            selectedUserId = this.value;

            if (selectedUserId) {
                const selectedOption = this.options[this.selectedIndex];
                selectedUserData = {
                    id: selectedUserId,
                    username: selectedOption.dataset.username,
                    email: selectedOption.dataset.email
                };

                selectedUserName.textContent = selectedUserData.username;
                currentUserInfo.classList.remove('hidden');
                gamesList.classList.remove('hidden');

                // Load existing picks for this user
                loadUserPicks(selectedUserId);
            } else {
                currentUserInfo.classList.add('hidden');
                gamesList.classList.add('hidden');
                clearAllSelections();
            }
        });
    }

    // Load existing picks for a user
    function loadUserPicks(userId) {
        fetch(`{% url 'get_user_picks' %}?user_id=${userId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    userPicks = data.picks;
                    updateGameCardsWithPicks();
                } else {
                    console.error('Error loading user picks:', data.error);
                    userPicks = {};
                }
            })
            .catch(error => {
                console.error('Error loading user picks:', error);
                userPicks = {};
            });
    }

    // Update game cards with existing picks
    function updateGameCardsWithPicks() {
        document.querySelectorAll('.manual-game-card').forEach(card => {
            const gameId = card.dataset.gameId;
            const existingPick = userPicks[gameId];

            // Clear previous selections
            card.querySelectorAll('.team-option-manual').forEach(option => {
                option.classList.remove('border-green-600', 'bg-green-50', 'dark:bg-green-900/20');
                option.classList.add('border-border-light', 'dark:border-border-subtle');
                option.querySelector('.pick-indicator-manual').classList.add('hidden');
                option.querySelector('.pick-indicator-manual').classList.remove('flex');
            });

            if (existingPick) {
                // Select the team that was picked
                const teamOption = card.querySelector(`[data-team="${existingPick.pick}"]`);
                if (teamOption) {
                    teamOption.classList.remove('border-border-light', 'dark:border-border-subtle');
                    teamOption.classList.add('border-green-600', 'bg-green-50', 'dark:bg-green-900/20');
                    teamOption.querySelector('.pick-indicator-manual').classList.remove('hidden');
                    teamOption.querySelector('.pick-indicator-manual').classList.add('flex');
                }

                // Fill in tiebreaker values if they exist
                const tiebreakerScore = card.querySelector('.tiebreaker-score');
                const tiebreakerYards = card.querySelector('.tiebreaker-yards');

                if (tiebreakerScore && existingPick.tiebreaker_score) {
                    tiebreakerScore.value = existingPick.tiebreaker_score;
                }
                if (tiebreakerYards && existingPick.tiebreaker_yards) {
                    tiebreakerYards.value = existingPick.tiebreaker_yards;
                }

                updatePickStatus(card, true);
            } else {
                updatePickStatus(card, false);
            }
        });

        updateSubmitButtonState();
    }

    // Team selection handlers
    document.addEventListener('click', function(e) {
        if (e.target.closest('.team-option-manual') && selectedUserId) {
            const teamOption = e.target.closest('.team-option-manual');
            const gameCard = teamOption.closest('.manual-game-card');

            // Clear selection from other teams in this game
            gameCard.querySelectorAll('.team-option-manual').forEach(option => {
                option.classList.remove('border-green-600', 'bg-green-50', 'dark:bg-green-900/20');
                option.classList.add('border-border-light', 'dark:border-border-subtle');
                option.querySelector('.pick-indicator-manual').classList.add('hidden');
                option.querySelector('.pick-indicator-manual').classList.remove('flex');
            });

            // Select this team
            teamOption.classList.remove('border-border-light', 'dark:border-border-subtle');
            teamOption.classList.add('border-green-600', 'bg-green-50', 'dark:bg-green-900/20');
            teamOption.querySelector('.pick-indicator-manual').classList.remove('hidden');
            teamOption.querySelector('.pick-indicator-manual').classList.add('flex');

            // Update pick status
            updatePickStatus(gameCard, true);
            updateSubmitButtonState();
        }
    });

    // Tiebreaker input handlers
    document.addEventListener('input', function(e) {
        if (e.target.matches('.tiebreaker-score, .tiebreaker-yards')) {
            const gameCard = e.target.closest('.manual-game-card');
            const selectedTeam = gameCard.querySelector('.team-option-manual.border-green-600');

            if (selectedTeam) {
                updatePickStatus(gameCard, true);
                updateSubmitButtonState();
            }
        }
    });

    // Update pick status indicator
    function updatePickStatus(gameCard, hasPick) {
        const noPick = gameCard.querySelector('.no-pick-indicator');
        const pickSaved = gameCard.querySelector('.pick-saved-indicator');

        if (hasPick) {
            noPick.classList.add('hidden');
            pickSaved.classList.remove('hidden');
        } else {
            noPick.classList.remove('hidden');
            pickSaved.classList.add('hidden');
        }
    }

    // Update submit button state
    function updateSubmitButtonState() {
        const hasSelections = document.querySelectorAll('.team-option-manual.border-green-600').length > 0;
        submitAllPicks.disabled = !hasSelections;
        clearAllPicks.disabled = !hasSelections;
    }

    // Clear all selections
    function clearAllSelections() {
        document.querySelectorAll('.team-option-manual').forEach(option => {
            option.classList.remove('border-green-600', 'bg-green-50', 'dark:bg-green-900/20');
            option.classList.add('border-border-light', 'dark:border-border-subtle');
            option.querySelector('.pick-indicator-manual').classList.add('hidden');
            option.querySelector('.pick-indicator-manual').classList.remove('flex');
        });
        document.querySelectorAll('.tiebreaker-score, .tiebreaker-yards').forEach(input => {
            input.value = '';
        });
        document.querySelectorAll('.manual-game-card').forEach(card => {
            updatePickStatus(card, false);
        });
        updateSubmitButtonState();
    }

    // Clear all picks button
    if (clearAllPicks) {
        clearAllPicks.addEventListener('click', function() {
            if (confirm('Are you sure you want to clear all selections?')) {
                clearAllSelections();
            }
        });
    }

    // Submit all picks
    if (submitAllPicks) {
        submitAllPicks.addEventListener('click', function() {
            if (!selectedUserId) {
                alert('Please select a user first.');
                return;
            }

            const selectedGames = document.querySelectorAll('.team-option-manual.border-green-600');
            if (selectedGames.length === 0) {
                alert('Please make at least one pick.');
                return;
            }

            const picks = [];
            selectedGames.forEach(teamOption => {
                const gameCard = teamOption.closest('.manual-game-card');
                const gameId = gameCard.dataset.gameId;
                const pick = teamOption.dataset.team;
                const tiebreakerScore = gameCard.querySelector('.tiebreaker-score')?.value || '';
                const tiebreakerYards = gameCard.querySelector('.tiebreaker-yards')?.value || '';
                const isTiebreaker = gameCard.querySelector('.is-tiebreaker').value === 'true';

                // Validate tiebreaker if required
                if (isTiebreaker && (!tiebreakerScore || !tiebreakerYards)) {
                    alert(`Please fill in both tiebreaker fields for the ${teamOption.dataset.teamName} game.`);
                    return;
                }

                picks.push({
                    game_id: gameId,
                    pick: pick,
                    tiebreaker_score: tiebreakerScore,
                    tiebreaker_yards: tiebreakerYards
                });
            });

            if (picks.length === 0) return;

            // Show submitting status
            submissionStatus.classList.remove('hidden');
            submissionStatus.querySelector('.submitting-indicator').classList.remove('hidden');
            submissionStatus.querySelector('.success-indicator').classList.add('hidden');
            submissionStatus.querySelector('.error-indicator').classList.add('hidden');

            submitAllPicks.disabled = true;

            // Submit picks one by one
            submitPicksSequentially(picks, 0);
        });
    }

    // Submit picks sequentially
    function submitPicksSequentially(picks, index) {
        if (index >= picks.length) {
            // All picks submitted successfully
            submissionStatus.querySelector('.submitting-indicator').classList.add('hidden');
            submissionStatus.querySelector('.success-indicator').classList.remove('hidden');

            setTimeout(() => {
                submissionStatus.classList.add('hidden');
                submitAllPicks.disabled = false;
            }, 3000);

            return;
        }

        const pick = picks[index];
        const pickData = {
            user_id: selectedUserId,
            game_id: pick.game_id,
            pick: pick.pick,
            tiebreaker_score: pick.tiebreaker_score,
            tiebreaker_yards: pick.tiebreaker_yards
        };

        fetch('{% url "submit_manual_pick" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(pickData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Continue with next pick
                submitPicksSequentially(picks, index + 1);
            } else {
                throw new Error(data.error);
            }
        })
        .catch(error => {
            console.error('Error submitting pick:', error);
            submissionStatus.querySelector('.submitting-indicator').classList.add('hidden');
            submissionStatus.querySelector('.error-indicator').classList.remove('hidden');

            setTimeout(() => {
                submissionStatus.classList.add('hidden');
                submitAllPicks.disabled = false;
            }, 3000);
        });
    }
});
</script>
{% endblock %}
