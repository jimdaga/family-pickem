{% extends 'pickem/base.html' %}
{% load static %}
{% load pickem_homepage_extras %}

{% block mobile_title %}
    <div class="mobile-subtitle">
        <i class="fas fa-chart-line mr-2"></i>Scores
    </div>
{% endblock %}

{% block content %}

    <!-- Hero Header -->
    <div class="relative text-center mb-6 px-4 py-8 lg:py-12 overflow-hidden bg-gradient-to-br from-blue-600 via-blue-700 to-indigo-700 dark:from-blue-600/30 dark:via-purple-600/20 dark:to-red-600/30 border-b-2 border-blue-800 dark:border-blue-500/40 shadow-xl animate-fade-in">
        <!-- Subtle background pattern -->
        <div class="absolute inset-0 opacity-20 dark:opacity-5 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxwYXRoIGQ9Ik0zNiAxOGMzLjMxNCAwIDYgMi42ODYgNiA2cy0yLjY4NiA2LTYgNi02LTIuNjg2LTYtNiAyLjY4Ni02IDYtNiIgc3Ryb2tlPSIjRkZGIiBzdHJva2Utd2lkdGg9IjIiLz48L2c+PC9zdmc+')] pointer-events-none"></div>

        <!-- Content -->
        <div class="relative z-10">
            <!-- Icon -->
            <div class="flex items-center justify-center mb-3 lg:mb-4">
                <i class="fas fa-chart-line text-4xl lg:text-6xl text-primary"></i>
            </div>

            <!-- Title -->
            <h2 class="text-3xl lg:text-5xl font-black tracking-tight mb-2 lg:mb-3"
                style="font-family: 'Urbanist', sans-serif; text-transform: uppercase; letter-spacing: -0.02em; color: white; -webkit-text-stroke: 3px #FF6B1A; paint-order: stroke fill;">
                Live Scores
            </h2>

            <!-- Subtitle -->
            <p class="text-base lg:text-xl text-white/90 dark:text-text-secondary font-medium">
                {% if competition == 'nfl-preseason' %}
                    Preseason - Week {{ week }}
                {% else %}
                    Regular Season - Week {{ week }}
                {% endif %}
            </p>
        </div>
    </div>

<div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-6 py-6">


    <!-- Your Weekly Performance Section -->
    {% if user.is_authenticated and user_weekly_stats %}
    <div class="section-container mb-6">
        <div class="flex items-center gap-4">
            <img src="{{ user.socialaccount_set.all.0.get_avatar_url }}"
                 alt="Your profile picture"
                 class="w-16 h-16 rounded-full border-2 border-primary">
            <div class="flex-1 grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-4">
                <div>
                    <div class="text-xs text-text-secondary-light dark:text-text-secondary uppercase font-semibold">Picks Accuracy:</div>
                    <div class="text-lg font-bold text-text-dark dark:text-white">{{ user_weekly_stats.accuracy }}% <span class="text-sm font-normal text-text-secondary-light dark:text-text-secondary">({{ user_weekly_stats.correct_picks }}/{{ user_weekly_stats.total_graded_picks }} Graded)</span></div>
                </div>
                <div>
                    <div class="text-xs text-text-secondary-light dark:text-text-secondary uppercase font-semibold">Correct Picks:</div>
                    <div class="text-lg font-bold text-text-dark dark:text-white">{{ user_weekly_stats.correct_picks }}</div>
                </div>
                <div>
                    <div class="text-xs text-text-secondary-light dark:text-text-secondary uppercase font-semibold">Week {{ week }} Points:</div>
                    <div class="text-lg font-bold text-text-dark dark:text-white">{{ user_weekly_stats.weekly_points }}</div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Filter Controls -->
    <div class="section-container mb-6">
        <div class="flex flex-wrap gap-2 justify-center">
            <button class="px-4 py-2 rounded-xl text-sm font-medium transition-all border-2 filter-btn active bg-blue-600 border-blue-600 text-white hover:bg-blue-700" data-filter="all">
                <i class="fas fa-list mr-2"></i>All Games
            </button>
            <button class="px-4 py-2 rounded-xl text-sm font-medium transition-all border-2 filter-btn border-green-600 text-green-600 dark:text-green-400 hover:bg-green-600/10" data-filter="live">
                <i class="fas fa-circle mr-2 animate-pulse"></i>Live
            </button>
            <button class="px-4 py-2 rounded-xl text-sm font-medium transition-all border-2 filter-btn border-gray-600 text-gray-600 dark:text-gray-400 hover:bg-gray-600/10" data-filter="final">
                <i class="fas fa-flag-checkered mr-2"></i>Final
            </button>
            <button class="px-4 py-2 rounded-xl text-sm font-medium transition-all border-2 filter-btn border-blue-600 text-blue-600 dark:text-blue-400 hover:bg-blue-600/10" data-filter="upcoming">
                <i class="fas fa-clock mr-2"></i>Upcoming
            </button>
        </div>
    </div>

        

    <!-- Week Winner Card -->
    {% if show_week_stats_sidebar %}
    {% for player in week_winner %}
    {% if player.id != None %}
    <div class="section-container mb-6">
        <h3 class="section-title">
            <i class="fas fa-trophy mr-2"></i>Week Winner
        </h3>
        <div class="flex items-center justify-center gap-6 py-6">
            {% with player.userID|lookupname as username %}
            {% with player.userID|lookupavatar as avatar %}
            <a href="{% url 'user_profile' player.userID %}" class="group">
                <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}"
                     alt="Profile picture for {{ username }}"
                     class="w-24 h-24 rounded-full border-4 border-yellow-500 shadow-glow-primary group-hover:scale-110 transition-transform">
            </a>
            <div class="text-center">
                <h4 class="text-2xl font-bold text-text-dark dark:text-white mb-2">{{ username|default:"Unknown Player" }}</h4>
                <div class="inline-flex items-center gap-2 px-4 py-2 bg-yellow-500/20 dark:bg-yellow-600/20 border-2 border-yellow-500 rounded-xl">
                    <i class="fas fa-crown text-yellow-500"></i>
                    <span class="font-bold text-text-dark dark:text-white">Champion</span>
                </div>
            </div>
            {% endwith %}
            {% endwith %}
        </div>
    </div>
    {% endif %}
    {% endfor %}
        
        <!-- Week Points Leaderboard - Two Columns on Large Screens -->
        <div class="section-container mb-6" x-data="{ open: true }">
            <button @click="open = !open"
                    class="w-full flex items-center justify-between px-4 py-3 hover:bg-surface-light/50 dark:hover:bg-surface-hover/50 rounded-t-2xl transition-colors"
                    type="button">
                <h3 class="text-2xl font-bold text-text-dark dark:text-gray-100 flex items-center mb-0">
                    <i class="fas fa-list-ol mr-2"></i>Week Points
                </h3>
                <i class="fas fa-chevron-down transition-transform duration-200" :class="{ 'rotate-180': open }"></i>
            </button>
            <div x-show="open"
                 x-transition:enter="transition ease-out duration-100"
                 x-transition:enter-start="opacity-0 -translate-y-2"
                 x-transition:enter-end="opacity-100 translate-y-0"
                 class="points-leaderboard points-leaderboard-multi-column bg-transparent px-1 sm:px-2 lg:px-4 pb-4"
                 id="week-points-leaderboard">
                        {% for player in user_points %}
                        <div data-player-card class="w-full flex items-center justify-between p-3 bg-surface-light dark:bg-surface rounded-xl border border-border-light dark:border-border-subtle hover:border-primary/30 dark:hover:border-primary/30 transition-all mb-2">
                            {% with player.uid|lookupname as username %}
                            {% with player.uid|lookupavatar as avatar %}
                            <div class="flex items-center gap-3 min-w-0 flex-1">
                                <a href="{% url 'user_profile' player.uid %}" class="flex-shrink-0 group">
                                    <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}"
                                         alt="Profile picture for {{ username }}"
                                         class="w-12 h-12 rounded-full border-2 border-border-light dark:border-border-subtle group-hover:scale-110 transition-transform">
                                </a>
                                <div class="min-w-0 flex-1">
                                    <a href="{% url 'user_profile' player.uid %}" class="text-lg font-bold text-text-dark dark:text-white truncate hover:text-primary dark:hover:text-primary transition-colors block">{{ username|default:"Unknown Player" }}</a>
                                </div>
                            </div>
                            <div class="flex items-baseline gap-1 flex-shrink-0">
                                <span class="text-2xl font-black text-secondary-light dark:text-secondary">{{ player.wins }}</span>
                                <span class="text-xs text-text-secondary-light dark:text-text-secondary font-semibold uppercase">pts</span>
                            </div>
                            {% endwith %}
                            {% endwith %}
                        </div>
                        {% endfor %}

                        {% for player in players_names %}
                        {% if player not in users_w_points %}
                        <div data-player-card class="w-full flex items-center justify-between p-3 bg-surface-light dark:bg-surface rounded-xl border border-border-light dark:border-border-subtle hover:border-primary/30 dark:hover:border-primary/30 transition-all mb-2">
                            {% with player|lookupname as username %}
                            {% with player|lookupavatar as avatar %}
                            <div class="flex items-center gap-3 min-w-0 flex-1">
                                <a href="{% url 'user_profile' player %}" class="flex-shrink-0 group">
                                    <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}"
                                         alt="Profile picture for {{ username }}"
                                         class="w-12 h-12 rounded-full border-2 border-border-light dark:border-border-subtle group-hover:scale-110 transition-transform">
                                </a>
                                <div class="min-w-0 flex-1">
                                    <a href="{% url 'user_profile' player %}" class="text-lg font-bold text-text-dark dark:text-white truncate hover:text-primary dark:hover:text-primary transition-colors block">{{ username|default:"Unknown Player" }}</a>
                                </div>
                            </div>
                            <div class="flex items-baseline gap-1 flex-shrink-0">
                                <span class="text-2xl font-black text-secondary-light dark:text-secondary">0</span>
                                <span class="text-xs text-text-secondary-light dark:text-text-secondary font-semibold uppercase">pts</span>
                            </div>
                            {% endwith %}
                            {% endwith %}
                        </div>
                        {% endif %}
                        {% endfor %}
            </div>
        </div>
        <script>
            // Week Points Leaderboard Layout Manager - Updated for Tailwind
                window.weekPointsLayoutManager = (function() {
                    const CONTAINER_ID = 'week-points-leaderboard';
                    let originalCards = [];

                    function captureOriginalCards() {
                        try {
                            const container = document.getElementById(CONTAINER_ID);
                            if (!container) return;

                            // Capture cards if we haven't already or if container was reset
                            if (originalCards.length === 0 || !container.querySelector('.points-column')) {
                                const playerCards = container.querySelectorAll('[data-player-card]');
                                if (playerCards.length > 0) {
                                    originalCards = Array.from(playerCards).map(card => card.cloneNode(true));
                                }
                            }
                        } catch (error) {
                            console.error('Error capturing original cards:', error);
                        }
                    }

                    function applyColumnLayout() {
                        try {
                            const container = document.getElementById(CONTAINER_ID);
                            if (!container) return;

                            captureOriginalCards();
                            const totalCards = originalCards.length;

                            if (window.innerWidth >= 1024 && totalCards > 0) {
                                // Only rebuild if not already in column layout
                                if (!container.querySelector('.points-column')) {
                                    // Clear container
                                    container.innerHTML = '';

                                    // Create two columns with Tailwind classes
                                    const leftColumn = document.createElement('div');
                                    leftColumn.className = 'points-column flex-1 min-w-0';
                                    const rightColumn = document.createElement('div');
                                    rightColumn.className = 'points-column flex-1 min-w-0';

                                    // Calculate split point (first half goes to left, second half to right)
                                    const halfPoint = Math.ceil(totalCards / 2);

                                    // Distribute cards
                                    for (let i = 0; i < totalCards; i++) {
                                        if (i < halfPoint) {
                                            leftColumn.appendChild(originalCards[i].cloneNode(true));
                                        } else {
                                            rightColumn.appendChild(originalCards[i].cloneNode(true));
                                        }
                                    }

                                    // Create wrapper with flex
                                    const wrapper = document.createElement('div');
                                    wrapper.className = 'w-full flex gap-4';
                                    wrapper.appendChild(leftColumn);
                                    wrapper.appendChild(rightColumn);
                                    container.appendChild(wrapper);
                                }
                            } else {
                                // Mobile: restore original single-column layout
                                if (container.querySelector('.points-column')) {
                                    container.innerHTML = '';
                                    originalCards.forEach(card => {
                                        container.appendChild(card.cloneNode(true));
                                    });
                                }
                            }
                        } catch (error) {
                            console.error('Error applying column layout:', error);
                        }
                    }

                    function refreshLayout() {
                        // Reset to allow recapture of cards
                        originalCards = [];
                        applyColumnLayout();
                    }

                    // Public interface
                    return {
                        init: function() {
                            applyColumnLayout();
                            window.addEventListener('resize', applyColumnLayout);
                        },
                        refresh: refreshLayout,
                        apply: applyColumnLayout
                    };
                })();

            // Initialize on page load
            weekPointsLayoutManager.init();
        </script>
        {% endif %}

        <!-- Games by Start Time - Full Width -->
        {% if game_list %}
            {% regroup game_list by startTimestamp as games_by_time %}
            {% for time_group in games_by_time %}
            <div class="section-container mb-4 relative" x-data="{ open: true }">
                <button @click="open = !open"
                        class="w-full flex items-center justify-between px-4 py-2 hover:bg-surface-light/50 dark:hover:bg-surface-hover/50 rounded-t-2xl transition-colors"
                        type="button">
                    <div class="flex items-center text-lg font-bold text-text-dark dark:text-gray-100">
                        <i class="fas fa-calendar mr-2"></i>
                        <span>{{ time_group.grouper|date:"l, F j" }}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-sm font-semibold text-text-dark dark:text-white px-3 py-1 bg-primary/90 rounded-lg">
                            {{ time_group.grouper|date:"g:i A" }}
                        </span>
                        <i class="fas fa-chevron-down transition-transform duration-200" :class="{ 'rotate-180': open }"></i>
                    </div>
                </button>

                <div x-show="open"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0 -translate-y-2"
                     x-transition:enter-end="opacity-100 translate-y-0"
                     class="games-grid px-1 sm:px-2 lg:px-4 pt-1 pb-4 grid grid-cols-1 md:grid-cols-2 gap-6"
                     id="games-{{ time_group.grouper|date:'Y-m-d-Hi' }}">
                            {% for game in time_group.list %}
                            <div class="game-score-card bg-surface-light dark:bg-surface rounded-xl overflow-hidden border border-border-light dark:border-border-subtle hover:border-primary/30 dark:hover:border-primary/30 transition-all duration-200 flex flex-col" data-game-status="{{ game.statusType|lower }}">
                                <!-- Game Status Header -->
                                <div class="flex items-center justify-between px-3 py-1 text-sm font-semibold text-white {% if game.statusType == 'inprogress' %}bg-gradient-to-r from-green-600 to-green-700{% elif game.statusType == 'finished' %}bg-gradient-to-r from-blue-600 to-blue-700{% else %}bg-gradient-to-r from-gray-600 to-gray-700 dark:from-gray-700 dark:to-gray-800{% endif %}">
                                    <div class="flex items-center gap-2">
                                        <i class="fas {% if game.statusType == 'inprogress' %}fa-circle animate-pulse{% elif game.statusType == 'finished' %}fa-check-circle{% else %}fa-clock{% endif %}"></i>
                                        <span>{{ game.statusTitle }}</span>
                                    </div>
                                    <span class="text-xs opacity-90">{{ game.startTimestamp|date:"g:i A" }}</span>
                                </div>

                                <!-- Game Info (Spread, Weather, etc.) -->
                                {% if game.spread or game.overUnder or game.temperature or game.weatherCondition %}
                                <div class="flex flex-wrap items-center justify-center gap-3 px-3 py-1 text-xs text-text-dark dark:text-text-secondary border-b border-border-light dark:border-border-subtle bg-border-light dark:bg-surface-hover">
                                    {% if game.spread %}
                                    <div class="flex items-center gap-1">
                                        <i class="fas fa-chart-line"></i>
                                        <span class="font-medium">Spread:</span>
                                        <span class="flex items-center gap-1 font-semibold text-text-dark dark:text-white">
                                            {% if game.spread > 0 %}
                                                {% with game.homeTeamSlug|lookuplogo as logo_url %}
                                                <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}" alt="{{ game.homeTeamName }} logo" class="w-4 h-4 max-w-4 max-h-4 flex-shrink-0 object-contain" style="width: 16px; height: 16px;">
                                                {% endwith %}
                                                -{{ game.spread|floatformat:1 }}
                                            {% else %}
                                                {% with game.awayTeamSlug|lookuplogo as logo_url %}
                                                <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}" alt="{{ game.awayTeamName }} logo" class="w-4 h-4 max-w-4 max-h-4 flex-shrink-0 object-contain" style="width: 16px; height: 16px;">
                                                {% endwith %}
                                                -{{ game.spread|floatformat:1|cut:"-" }}
                                            {% endif %}
                                        </span>
                                    </div>
                                    {% endif %}
                                    {% if game.overUnder %}
                                    <div class="flex items-center gap-1">
                                        <i class="fas fa-calculator"></i>
                                        <span class="font-medium">O/U:</span>
                                        <span class="font-semibold text-text-dark dark:text-white">{{ game.overUnder|floatformat:1 }}</span>
                                    </div>
                                    {% endif %}
                                    {% if game.temperature and game.weatherCondition %}
                                    <div class="flex items-center gap-1">
                                        {% if 'Sun' in game.weatherCondition or 'Clear' in game.weatherCondition %}
                                            <i class="fas fa-sun text-yellow-500"></i>
                                        {% elif 'Cloud' in game.weatherCondition %}
                                            <i class="fas fa-cloud"></i>
                                        {% elif 'Rain' in game.weatherCondition or 'Shower' in game.weatherCondition %}
                                            <i class="fas fa-cloud-rain text-blue-500"></i>
                                        {% elif 'Snow' in game.weatherCondition %}
                                            <i class="fas fa-snowflake text-blue-300"></i>
                                        {% elif 'Storm' in game.weatherCondition or 'Thunder' in game.weatherCondition %}
                                            <i class="fas fa-bolt text-purple-500"></i>
                                        {% elif 'Wind' in game.weatherCondition %}
                                            <i class="fas fa-wind"></i>
                                        {% elif 'Fog' in game.weatherCondition %}
                                            <i class="fas fa-smog"></i>
                                        {% else %}
                                            <i class="fas fa-thermometer-half"></i>
                                        {% endif %}
                                        <span>{{ game.temperature }}°F</span>
                                    </div>
                                    {% endif %}
                                    {% if game.venueIndoor %}
                                    <div class="flex items-center gap-1">
                                        <i class="fas fa-home"></i>
                                        <span>Indoor</span>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}

                                <!-- Teams and Scores -->
                                <div class="teams-matchup">
                                    <!-- Away Team -->
                                    <div class="team-score-row {% if game.statusType == 'finished' and game.gameWinner == game.awayTeamSlug %}winning-team{% endif %}">
                                        <div class="team-info">
                                            {% with game.awayTeamSlug|lookuplogo as logo_url %}
                                            <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}"
                                                 alt="{{ game.awayTeamName }} logo"
                                                 class="team-logo w-12 h-12 flex-shrink-0">
                                            {% endwith %}
                                            <div class="team-details">
                                                <div class="team-name {% if game.statusType == 'finished' and game.gameWinner != game.awayTeamSlug %}text-muted{% endif %}">
                                                    {{ game.awayTeamName }}
                                                    {% if game.statusType == 'finished' and game.gameWinner == game.awayTeamSlug %}
                                                        <i class="fas fa-chevron-right ms-1 winner-indicator"></i>
                                                    {% endif %}
                                                </div>
                                                <div class="team-details">
                                                    <div class="team-record">
                                                        {% for team in wins_losses %}
                                                            {% if team.teamNameSlug == game.awayTeamSlug %}
                                                                {% if team.teamTies > 0 %}
                                                                    ({{ team.teamWins }}-{{ team.teamLosses }}-{{ team.teamTies }})
                                                                {% else %}
                                                                    ({{ team.teamWins }}-{{ team.teamLosses }})
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                    {% if game.awayTeamWinProbability %}
                                                    <div class="performance-item">
                                                        <span class="performance-label">Win Chance</span>
                                                        <div class="progress-container">
                                                            <div class="progress-bar">
                                                                <div class="progress-fill" style="width: {{ game.awayTeamWinProbability|floatformat:0 }}%"></div>
                                                            </div>
                                                            <span class="progress-text">{{ game.awayTeamWinProbability|floatformat:0 }}%</span>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {% if game.statusType != 'notstarted' %}
                                        <div class="score-breakdown">
                                            <div class="flex items-center gap-2">
                                                <div class="quarters">
                                                    <span class="quarter-score">{{ game.awayTeamPeriod1|default:"—" }}</span>
                                                    <span class="quarter-score">{{ game.awayTeamPeriod2|default:"—" }}</span>
                                                    <span class="quarter-score">{{ game.awayTeamPeriod3|default:"—" }}</span>
                                                    <span class="quarter-score">{{ game.awayTeamPeriod4|default:"—" }}</span>
                                                </div>
                                                <div class="total-score text-3xl md:text-4xl font-black text-primary pl-3">{{ game.awayTeamScore|default:"0" }}</div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>

                                    <!-- Home Team -->
                                    <div class="team-score-row {% if game.statusType == 'finished' and game.gameWinner == game.homeTeamSlug %}winning-team{% endif %}">
                                        <div class="team-info">
                                            {% with game.homeTeamSlug|lookuplogo as logo_url %}
                                            <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}"
                                                 alt="{{ game.homeTeamName }} logo"
                                                 class="team-logo w-12 h-12 flex-shrink-0">
                                            {% endwith %}
                                            <div class="team-details">
                                                <div class="team-name {% if game.statusType == 'finished' and game.gameWinner != game.homeTeamSlug %}text-muted{% endif %}">
                                                    {{ game.homeTeamName }}
                                                    {% if game.statusType == 'finished' and game.gameWinner == game.homeTeamSlug %}
                                                        <i class="fas fa-chevron-right ms-1 winner-indicator"></i>
                                                    {% endif %}
                                                </div>
                                                <div class="team-details">
                                                    <div class="team-record">
                                                        {% for team in wins_losses %}
                                                            {% if team.teamNameSlug == game.homeTeamSlug %}
                                                                {% if team.teamTies > 0 %}
                                                                    ({{ team.teamWins }}-{{ team.teamLosses }}-{{ team.teamTies }})
                                                                {% else %}
                                                                    ({{ team.teamWins }}-{{ team.teamLosses }})
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                    {% if game.homeTeamWinProbability %}
                                                    <div class="performance-item">
                                                        <span class="performance-label">Win Chance</span>
                                                        <div class="progress-container">
                                                            <div class="progress-bar">
                                                                <div class="progress-fill" style="width: {{ game.homeTeamWinProbability|floatformat:0 }}%"></div>
                                                            </div>
                                                            <span class="progress-text">{{ game.homeTeamWinProbability|floatformat:0 }}%</span>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {% if game.statusType != 'notstarted' %}
                                        <div class="score-breakdown">
                                            <div class="flex items-center gap-2">
                                                <div class="quarters">
                                                    <span class="quarter-score">{{ game.homeTeamPeriod1|default:"—" }}</span>
                                                    <span class="quarter-score">{{ game.homeTeamPeriod2|default:"—" }}</span>
                                                    <span class="quarter-score">{{ game.homeTeamPeriod3|default:"—" }}</span>
                                                    <span class="quarter-score">{{ game.homeTeamPeriod4|default:"—" }}</span>
                                                </div>
                                                <div class="total-score text-3xl md:text-4xl font-black text-primary pl-3">{{ game.homeTeamScore|default:"0" }}</div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Preview and Broadcast Info -->
                                {% if game.broadcast or game.gamecastUrl %}
                                <div class="flex items-center justify-between px-4 py-3 border-t border-border-light dark:border-border-subtle bg-border-light dark:bg-surface-hover">
                                    {% if game.gamecastUrl %}
                                    <a href="{{ game.gamecastUrl }}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 px-3 py-1 bg-primary/10 hover:bg-primary/20 dark:bg-primary/20 dark:hover:bg-primary/30 rounded-lg transition-colors">
                                        <i class="fas fa-external-link-alt text-primary"></i>
                                        <span class="text-sm font-semibold text-primary">Game Preview</span>
                                    </a>
                                    {% else %}
                                    <div></div>
                                    {% endif %}
                                    {% if game.broadcast %}
                                    <div class="flex items-center gap-2 ml-auto">
                                        <i class="fas fa-tv text-primary"></i>
                                        <span class="text-sm font-semibold text-text-dark dark:text-white">{{ game.broadcast }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}

                                <!-- Game Status Badge -->
                                {% if game.statusType != 'notstarted' %}
                                <div class="flex items-center justify-center py-2 mt-1 mb-0">
                                    {% if game.statusType|lower == 'inprogress' %}
                                        <span class="px-4 py-1.5 bg-gradient-to-r from-green-600 to-green-700 text-white text-xs font-bold uppercase tracking-wider rounded-full">LIVE</span>
                                    {% elif game.statusType|lower == 'finished' %}
                                        <span class="px-4 py-1.5 bg-gradient-to-r from-blue-600 to-blue-700 text-white text-xs font-bold uppercase tracking-wider rounded-full">FINAL</span>
                                    {% endif %}
                                </div>
                                {% endif %}

                                <!-- Player Picks Section -->
                                {% if picks %}
                                    {% if game.statusType == 'finished' or game.statusType == 'inprogress' %}
                                <div class="border-t border-border-light dark:border-border-subtle mt-3 pt-3">
                                    <div class="px-4">
                                        <div class="flex items-center gap-2 text-sm font-semibold text-text-dark dark:text-white mb-3">
                                            <i class="fas fa-users"></i>
                                            <span>Player Picks</span>
                                        </div>

                                        <!-- Team Picks Grid (Responsive: stacked on mobile, side-by-side on larger screens) -->
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">

                                    <!-- Away Team Picks -->
                                    <div class="space-y-2" data-team="{{ game.awayTeamSlug }}">
                                        <div class="flex items-center gap-2 mb-2">
                                            {% with game.awayTeamSlug|lookuplogo as logo_url %}
                                            <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}"
                                                 alt="{{ game.awayTeamName }} logo"
                                                 class="flex-shrink-0 object-contain"
                                                 style="width: 20px !important; height: 20px !important; max-width: none !important;">
                                            {% endwith %}
                                            <span class="text-sm font-semibold text-text-dark dark:text-white truncate">{{ game.awayTeamName }}</span>
                                        </div>
                                        <div class="flex flex-wrap gap-2">
                                            {% for pick in picks %}
                                                {% if pick.pick == game.awayTeamSlug %}
                                                    {% with pick.uid|lookupname as username %}
                                                    {% with pick.uid|lookupavatar as avatar %}
                                                    {% if game.statusType == 'finished' %}
                                                        {% if game.gameWinner == pick.pick %}
                                                            <div class="flex flex-col items-center gap-1">
                                                                <a href="{% url 'user_profile' pick.uid %}" class="group">
                                                                    <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}"
                                                                         alt="{{ username|default:'Unknown' }}"
                                                                         class="w-10 h-10 rounded-full border-2 border-green-500 dark:border-green-400 hover:scale-110 transition-transform"
                                                                         style="box-shadow: 0 0 12px rgba(40, 167, 69, 0.7), 0 0 24px rgba(40, 167, 69, 0.4);"
                                                                         title="{{ username|default:'Unknown' }} - Correct Pick">
                                                                </a>
                                                                <span class="text-xs text-text-dark dark:text-white font-medium text-center" style="min-width: 80px;">{{ username|default:'Unknown' }}</span>
                                                                {% if pick.tieBreakerScore != None %}
                                                                <span class="text-xs text-text-secondary-light dark:text-text-secondary text-center" style="min-width: 80px;">TB: {{ pick.tieBreakerScore }}/{{ pick.tieBreakerYards }}</span>
                                                                {% endif %}
                                                            </div>
                                                        {% else %}
                                                            <div class="flex flex-col items-center gap-1 opacity-60">
                                                                <a href="{% url 'user_profile' pick.uid %}" class="group">
                                                                    <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}"
                                                                         alt="{{ username|default:'Unknown' }}"
                                                                         class="w-10 h-10 rounded-full border-2 border-red-500 dark:border-red-400 hover:scale-110 transition-transform"
                                                                         style="box-shadow: 0 0 12px rgba(220, 53, 69, 0.7), 0 0 24px rgba(220, 53, 69, 0.4);"
                                                                         title="{{ username|default:'Unknown' }} - Incorrect Pick">
                                                                </a>
                                                                <span class="text-xs text-text-secondary-light dark:text-text-secondary font-medium text-center" style="min-width: 80px;">{{ username|default:'Unknown' }}</span>
                                                                {% if pick.tieBreakerScore != None %}
                                                                <span class="text-xs text-text-secondary-light dark:text-text-secondary text-center" style="min-width: 80px;">TB: {{ pick.tieBreakerScore }}/{{ pick.tieBreakerYards }}</span>
                                                                {% endif %}
                                                            </div>
                                                        {% endif %}
                                                    {% elif game.statusType == 'inprogress' %}
                                                        <div class="flex flex-col items-center gap-1">
                                                            <a href="{% url 'user_profile' pick.uid %}" class="group">
                                                                <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}"
                                                                     alt="{{ username|default:'Unknown' }}"
                                                                     class="w-10 h-10 rounded-full border-2 border-yellow-500 dark:border-yellow-400 hover:scale-110 transition-transform animate-pulse"
                                                                     style="box-shadow: 0 0 12px rgba(255, 193, 7, 0.7), 0 0 24px rgba(255, 193, 7, 0.4);"
                                                                     title="{{ username|default:'Unknown' }} - Game In Progress">
                                                            </a>
                                                            <span class="text-xs text-text-dark dark:text-white font-medium text-center" style="min-width: 80px;">{{ username|default:'Unknown' }}</span>
                                                            {% if pick.tieBreakerScore != None %}
                                                            <span class="text-xs text-text-secondary-light dark:text-text-secondary text-center" style="min-width: 80px;">TB: {{ pick.tieBreakerScore }}/{{ pick.tieBreakerYards }}</span>
                                                            {% endif %}
                                                        </div>
                                                    {% endif %}
                                                    {% endwith %}
                                                    {% endwith %}
                                                {% endif %}
                                            {% empty %}
                                            {% endfor %}
                                            {% if not picks %}
                                                <span class="no-picks-message">No picks available</span>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Home Team Picks -->
                                    <div class="space-y-2" data-team="{{ game.homeTeamSlug }}">
                                        <div class="flex items-center gap-2 mb-2">
                                            {% with game.homeTeamSlug|lookuplogo as logo_url %}
                                            <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}"
                                                 alt="{{ game.homeTeamName }} logo"
                                                 class="flex-shrink-0 object-contain"
                                                 style="width: 20px !important; height: 20px !important; max-width: none !important;">
                                            {% endwith %}
                                            <span class="text-sm font-semibold text-text-dark dark:text-white truncate">{{ game.homeTeamName }}</span>
                                        </div>
                                        <div class="flex flex-wrap gap-2">
                                            {% for pick in picks %}
                                                {% if pick.pick == game.homeTeamSlug %}
                                                    {% with pick.uid|lookupname as username %}
                                                    {% with pick.uid|lookupavatar as avatar %}
                                                    {% if game.statusType == 'finished' %}
                                                        {% if game.gameWinner == pick.pick %}
                                                            <div class="flex flex-col items-center gap-1">
                                                                <a href="{% url 'user_profile' pick.uid %}" class="group">
                                                                    <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}"
                                                                         alt="{{ username|default:'Unknown' }}"
                                                                         class="w-10 h-10 rounded-full border-2 border-green-500 dark:border-green-400 hover:scale-110 transition-transform"
                                                                         style="box-shadow: 0 0 12px rgba(40, 167, 69, 0.7), 0 0 24px rgba(40, 167, 69, 0.4);"
                                                                         title="{{ username|default:'Unknown' }} - Correct Pick">
                                                                </a>
                                                                <span class="text-xs text-text-dark dark:text-white font-medium text-center" style="min-width: 80px;">{{ username|default:'Unknown' }}</span>
                                                                {% if pick.tieBreakerScore != None %}
                                                                <span class="text-xs text-text-secondary-light dark:text-text-secondary text-center" style="min-width: 80px;">TB: {{ pick.tieBreakerScore }}/{{ pick.tieBreakerYards }}</span>
                                                                {% endif %}
                                                            </div>
                                                        {% else %}
                                                            <div class="flex flex-col items-center gap-1 opacity-60">
                                                                <a href="{% url 'user_profile' pick.uid %}" class="group">
                                                                    <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}"
                                                                         alt="{{ username|default:'Unknown' }}"
                                                                         class="w-10 h-10 rounded-full border-2 border-red-500 dark:border-red-400 hover:scale-110 transition-transform"
                                                                         style="box-shadow: 0 0 12px rgba(220, 53, 69, 0.7), 0 0 24px rgba(220, 53, 69, 0.4);"
                                                                         title="{{ username|default:'Unknown' }} - Incorrect Pick">
                                                                </a>
                                                                <span class="text-xs text-text-secondary-light dark:text-text-secondary font-medium text-center" style="min-width: 80px;">{{ username|default:'Unknown' }}</span>
                                                                {% if pick.tieBreakerScore != None %}
                                                                <span class="text-xs text-text-secondary-light dark:text-text-secondary text-center" style="min-width: 80px;">TB: {{ pick.tieBreakerScore }}/{{ pick.tieBreakerYards }}</span>
                                                                {% endif %}
                                                            </div>
                                                        {% endif %}
                                                    {% elif game.statusType == 'inprogress' %}
                                                        <div class="flex flex-col items-center gap-1">
                                                            <a href="{% url 'user_profile' pick.uid %}" class="group">
                                                                <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}"
                                                                     alt="{{ username|default:'Unknown' }}"
                                                                     class="w-10 h-10 rounded-full border-2 border-yellow-500 dark:border-yellow-400 hover:scale-110 transition-transform animate-pulse"
                                                                     style="box-shadow: 0 0 12px rgba(255, 193, 7, 0.7), 0 0 24px rgba(255, 193, 7, 0.4);"
                                                                     title="{{ username|default:'Unknown' }} - Game In Progress">
                                                            </a>
                                                            <span class="text-xs text-text-dark dark:text-white font-medium text-center" style="min-width: 80px;">{{ username|default:'Unknown' }}</span>
                                                            {% if pick.tieBreakerScore != None %}
                                                            <span class="text-xs text-text-secondary-light dark:text-text-secondary text-center" style="min-width: 80px;">TB: {{ pick.tieBreakerScore }}/{{ pick.tieBreakerYards }}</span>
                                                            {% endif %}
                                                        </div>
                                                    {% endif %}
                                                    {% endwith %}
                                                    {% endwith %}
                                                {% endif %}
                                            {% empty %}
                                            {% endfor %}
                                            {% if not picks %}
                                                <span class="no-picks-message">No picks available</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    </div>
                                </div>
                            </div>
                                    {% endif %}
                                {% endif %}

                                <!-- User's Pick Highlight -->
                                {% if picks %}
                                {% for pick in picks %}
                                {% if pick.userEmail == user.email and pick.pick == game.homeTeamSlug or pick.userEmail == user.email and pick.pick == game.awayTeamSlug %}
                                <div class="{% if game.statusType == 'finished' or game.statusType == 'inprogress' %}border-t border-border-light dark:border-border-subtle mt-3 pt-3{% else %}mt-3 pt-3{% endif %}">
                                    <div class="px-4 pb-4">
                                        <div class="flex items-center gap-2 text-sm font-semibold text-text-dark dark:text-white mb-3">
                                            <i class="fas fa-star"></i>
                                            <span>Your Pick</span>
                                        </div>
                                        <div class="flex items-center gap-4">
                                        {% if pick.pick == game.homeTeamSlug %}
                                            {% with game.homeTeamSlug|lookuplogo as logo_url %}
                                            <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}"
                                                 alt="{{ game.homeTeamName }} logo"
                                                 class="w-9 h-9 object-contain flex-shrink-0"
                                                 style="width: 36px !important; height: 36px !important; max-width: none !important;">
                                            {% endwith %}
                                            <span class="text-sm font-semibold text-text-dark dark:text-white">{{ game.homeTeamName }}</span>
                                        {% else %}
                                            {% with game.awayTeamSlug|lookuplogo as logo_url %}
                                            <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}"
                                                 alt="{{ game.awayTeamName }} logo"
                                                 class="w-9 h-9 object-contain flex-shrink-0"
                                                 style="width: 36px !important; height: 36px !important; max-width: none !important;">
                                            {% endwith %}
                                            <span class="text-sm font-semibold text-text-dark dark:text-white">{{ game.awayTeamName }}</span>
                                        {% endif %}

                                        {% if game.statusType == 'finished' %}
                                            {% if game.gameWinner == pick.pick %}
                                                <span class="px-4 py-2 rounded-full text-xs font-bold ml-auto bg-green-600 text-white">
                                                    <i class="fas fa-check-circle mr-1"></i>Correct
                                                </span>
                                            {% else %}
                                                <span class="px-4 py-2 rounded-full text-xs font-bold ml-auto bg-red-600 text-white">
                                                    <i class="fas fa-times-circle mr-1"></i>Incorrect
                                                </span>
                                            {% endif %}
                                        {% endif %}
                                        
                                        {% if pick.tieBreakerScore != None %}
                                        <div class="tiebreaker-display">
                                            <small>Tiebreaker: {{ pick.tieBreakerScore }} pts, {{ pick.tieBreakerYards }} yds</small>
                                        </div>
                                        {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                                {% endif %}

                                <!-- Missing Picks Alert -->
                                {% if game.statusType == 'notstarted' or game.statusType == 'delayed' %}
                                <div class="missing-picks-section" style="display: none;" id="missing-picks-{{ game.id }}">
                                    <div class="missing-picks-header">
                                        <i class="fas fa-exclamation-triangle me-2"></i>Missing Picks
                                    </div>
                                    <div class="missing-picks-list">
                                        {% for player in players_ids %}
                                            {% with player|addstr:"-"|addstr:game.id as gameid %}
                                                {% with gameid|lookuppick as count %}
                                                    {% if count == 0 %}
                                                        {% with player|lookupname as username %}
                                                        {% with player|lookupavatar as avatar %}
                                                            <div class="missing-pick-user">
                                                                <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}" 
                                                                     alt="{{ username|default:'Unknown' }}" 
                                                                     class="missing-pick-avatar" 
                                                                     title="{{ username|default:'Unknown' }} - No Pick">
                                                                <div class="missing-pick-username">{{ username|default:'Unknown' }}</div>
                                                            </div>
                                                        {% endwith %}
                                                        {% endwith %}
                                                    {% endif %}
                                                {% endwith %}
                                            {% endwith %}
                                        {% endfor %}
                                    </div>
                                </div>
                                <script>
                                    // Show missing picks section only if there are missing pick avatars
                                    (function() {
                                        var section = document.getElementById('missing-picks-{{ game.id }}');
                                        var avatars = section.querySelectorAll('.missing-pick-avatar');
                                        if (avatars.length > 0) {
                                            section.style.display = 'block';
                                        }
                                    })();
                                </script>
                                {% endif %}
                            </div>
                            {% endfor %}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="section-container mb-6">
                <div class="flex flex-col items-center justify-center py-12 text-center">
                    <i class="fas fa-calendar-times text-6xl text-text-secondary-light dark:text-text-secondary mb-4"></i>
                    {% if is_default_week %}
                    <h4 class="text-xl font-bold text-text-dark dark:text-white mb-3">Week {{ week }} Games Coming Soon</h4>
                    <p class="text-text-secondary-light dark:text-text-secondary mb-6 max-w-md">NFL Week {{ week }} games will appear here once the schedule is released. Get ready for the season by submitting your picks!</p>
                    <a href="{% url 'game_picks' %}" class="btn-primary px-6 py-3 rounded-xl font-semibold inline-flex items-center gap-2 transition-all hover:shadow-card-hover">
                        <i class="fas fa-edit"></i>
                        <span>Submit Week {{ week }} Picks</span>
                    </a>
                    {% else %}
                    <h4 class="text-xl font-bold text-text-dark dark:text-white mb-3">No games scheduled</h4>
                    <p class="text-text-secondary-light dark:text-text-secondary">Check back later or view other weeks.</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

        <!-- Week Stats Sidebar - Below Games -->
        {% if show_week_stats_sidebar %}
        <div class="row mt-4 hidden">
            <div class="col-lg-6 mb-4">
                <!-- Week Winner Card -->
                {% for player in week_winner %}
                {% if player.id != None %}
                <div class="section-container mb-4">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i class="fas fa-trophy me-2"></i>Week Winner
                        </h3>
                    </div>
                    <div class="winner-showcase">
                        {% with player.userID|lookupname as username %}
                        {% with player.userID|lookupavatar as avatar %}
                        <div class="winner-profile">
                            <a href="{% url 'user_profile' player.userID %}" class="winner-avatar-link">
                                <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}" 
                                     alt="Profile picture for {{ username }}" 
                                     class="winner-avatar">
                            </a>
                            <div class="winner-details">
                                <h4 class="winner-name">{{ username|default:"Unknown Player" }}</h4>
                                <div class="winner-badge">
                                    <i class="fas fa-crown me-1"></i>Champion
                                </div>
                            </div>
                        </div>
                        {% endwith %}
                        {% endwith %}
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Game Filtering and Interactions Script -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
    // Game Filtering Functionality
    const filterButtons = document.querySelectorAll('.filter-btn');
    const gameCards = document.querySelectorAll('.game-score-card');
    
    function filterGames(filterType) {
        gameCards.forEach(card => {
            const gameStatus = card.getAttribute('data-game-status');
            let shouldShow = false;
            
            switch(filterType) {
                case 'all':
                    shouldShow = true;
                    break;
                case 'live':
                    shouldShow = gameStatus === 'inprogress';
                    break;
                case 'final':
                    shouldShow = gameStatus === 'finished';
                    break;
                case 'upcoming':
                    shouldShow = gameStatus === 'notstarted';
                    break;
            }
            
            if (shouldShow) {
                card.style.display = 'block';
                card.style.animation = 'fadeIn 0.3s ease-in';
            } else {
                card.style.display = 'none';
            }
        });
        
        // Hide empty time groups
        const timeGroups = document.querySelectorAll('.games-grid');
        timeGroups.forEach(group => {
            const visibleCards = group.querySelectorAll('.game-score-card[style*="display: block"], .game-score-card:not([style*="display: none"])');
            const parentContainer = group.closest('.section-container');
            
            if (visibleCards.length === 0) {
                parentContainer.style.display = 'none';
            } else {
                parentContainer.style.display = 'block';
            }
        });
    }
    
    // Add click event listeners to filter buttons
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            filterButtons.forEach(btn => btn.classList.remove('active'));
            
            // Add active class to clicked button
            this.classList.add('active');
            
            // Get filter type and apply filter
            const filterType = this.getAttribute('data-filter');
            filterGames(filterType);
            
            // Save filter preference
            localStorage.setItem('scores-filter', filterType);
        });
    });
    
    // Restore saved filter on page load
    const savedFilter = localStorage.getItem('scores-filter');
    if (savedFilter && savedFilter !== 'all') {
        const targetButton = document.querySelector(`[data-filter="${savedFilter}"]`);
        if (targetButton) {
            // Remove active from all buttons
            filterButtons.forEach(btn => btn.classList.remove('active'));
            // Add active to saved filter button
            targetButton.classList.add('active');
            // Apply the filter
            filterGames(savedFilter);
        }
    }
    
    // Add fade-in animation CSS
    const scoresPageStyle = document.createElement('style');
    scoresPageStyle.textContent = `
        /* Avatar styles for picks */
        .pick-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 3px solid #dee2e6;
            object-fit: cover;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 2px;
            display: inline-block;
        }
        
        /* Pick status border colors */
        .pick-avatar.pick-correct {
            border-color: #28a745;
            box-shadow: 0 0 12px rgba(40, 167, 69, 0.7), 0 0 24px rgba(40, 167, 69, 0.4);
        }

        .pick-avatar.pick-incorrect {
            border-color: #dc3545;
            box-shadow: 0 0 12px rgba(220, 53, 69, 0.7), 0 0 24px rgba(220, 53, 69, 0.4);
        }

        .pick-avatar.pick-pending {
            border-color: #ffc107;
            box-shadow: 0 0 12px rgba(255, 193, 7, 0.7), 0 0 24px rgba(255, 193, 7, 0.4);
        }

        .pick-avatar:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .pick-avatar.pick-correct:hover {
            box-shadow: 0 0 16px rgba(40, 167, 69, 0.8), 0 0 32px rgba(40, 167, 69, 0.5), 0 4px 12px rgba(40, 167, 69, 0.6);
        }

        .pick-avatar.pick-incorrect:hover {
            box-shadow: 0 0 16px rgba(220, 53, 69, 0.8), 0 0 32px rgba(220, 53, 69, 0.5), 0 4px 12px rgba(220, 53, 69, 0.6);
        }

        .pick-avatar.pick-pending:hover {
            box-shadow: 0 0 16px rgba(255, 193, 7, 0.8), 0 0 32px rgba(255, 193, 7, 0.5), 0 4px 12px rgba(255, 193, 7, 0.6);
        }
        
        .missing-pick-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 3px solid #dc3545;
            object-fit: cover;
            opacity: 0.7;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 2px;
            display: inline-block;
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.6), 0 0 20px rgba(220, 53, 69, 0.3);
        }

        .missing-pick-avatar:hover {
            opacity: 1;
            transform: scale(1.15);
            box-shadow: 0 0 16px rgba(220, 53, 69, 0.8), 0 0 32px rgba(220, 53, 69, 0.5), 0 4px 12px rgba(220, 53, 69, 0.6);
        }
        
        /* Team picks layout adjustments */
        .team-picks-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            padding: 12px;
            min-height: 60px;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 8px;
            margin-top: 4px;
        }
        
        .team-picks-section {
            margin-bottom: 8px;
        }
        
        .team-picks-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: #ffffff;
            margin-bottom: 4px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        /* Pick player container and username styling */
        .pick-player {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            margin: 0.25rem;
            min-width: 60px;
        }
        
        .pick-username {
            font-size: 0.75rem;
            font-weight: 700;
            color: #2c3e50;
            text-align: center;
            text-transform: uppercase;
            line-height: 1.1;
            max-width: 60px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        /* Pick avatar link styling */
        .pick-avatar-link {
            display: block;
            transition: transform 0.2s ease;
            border-radius: 50%;
        }
        
        .pick-avatar-link:hover {
            transform: scale(1.1);
        }
        
        .pick-avatar-link:focus {
            outline: 2px solid var(--bs-primary);
            outline-offset: 2px;
        }
        
        .tiebreaker-mini {
            font-size: 0.7rem;
            color: #6c757d;
            margin-left: 4px;
            font-weight: 500;
        }
        
        /* Missing picks section improvements */
        .missing-picks-section {
            background: rgba(0, 0, 0, 0.02);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 0 0 12px 12px;
            padding: 12px;
            margin-top: 12px;
        }
        
        .missing-picks-header {
            color: #495057;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }
        
        .missing-picks-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }
        
        .no-picks-message {
            color: #6c757d;
            font-style: italic;
            font-size: 0.9rem;
            padding: 8px;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .filter-btn.active {
            background-color: var(--bs-primary);
            border-color: var(--bs-primary);
            color: white;
        }
        .score-updating {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .live-update-indicator {
            position: fixed;
            top: 70px;
            right: 20px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        .live-update-indicator.show {
            transform: translateX(0);
        }
    `;
    document.head.appendChild(scoresPageStyle);

    // Add immediate dark mode CSS injection
    const immediateDarkModeStyle = document.createElement('style');
    immediateDarkModeStyle.textContent = `
        /* Immediate dark mode fixes for scores page */
        [data-bs-theme="dark"] .game-score-card {
            background: linear-gradient(135deg, #404040 0%, #4a4a4a 50%, #505050 100%) !important;
            background-color: #404040 !important;
            color: #ffffff !important;
            border: 1px solid #555555 !important;
        }
        [data-bs-theme="dark"] .game-status-header {
            background: #2a2a2a !important;
            background-color: #2a2a2a !important;
            color: #ffffff !important;
            border-bottom: 1px solid #555555 !important;
        }
        [data-bs-theme="dark"] .game-info-bar {
            background: #2a2a2a !important;
            background-color: #2a2a2a !important;
            color: #ffffff !important;
        }
        [data-bs-theme="dark"] .game-info-item {
            background: #333333 !important;
            background-color: #333333 !important;
            color: #ffffff !important;
            border: 1px solid #555555 !important;
        }
        [data-bs-theme="dark"] .team-name {
            color: #ffffff !important;
        }
        
        /* Fix total-score class to have light text and strong contrast */
        [data-bs-theme="dark"] .total-score {
            color: #ffffff !important;
            text-shadow: none !important;
            opacity: 1 !important;
            font-weight: 800 !important;
        }
        
        /* Fix LIVE button background - make the container dark */
        [data-bs-theme="dark"] .game-status-display {
            background: #2a2a2a !important;
            background-color: #2a2a2a !important;
            border: 1px solid #555555 !important;
            padding: 0.5rem !important;
        }
        
        /* Force LIVE button itself to have proper styling */
        [data-bs-theme="dark"] .game-status.live {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
            color: #ffffff !important;
            border: 1px solid #1e7e34 !important;
        }
        
        /* Dark mode avatar styles */
        [data-bs-theme="dark"] .pick-avatar {
            border-color: #555555 !important;
        }

        [data-bs-theme="dark"] .pick-avatar.pick-correct {
            border-color: #198754 !important;
            box-shadow: 0 0 12px rgba(25, 135, 84, 0.8), 0 0 24px rgba(25, 135, 84, 0.5) !important;
        }

        [data-bs-theme="dark"] .pick-avatar.pick-incorrect {
            border-color: #dc3545 !important;
            box-shadow: 0 0 12px rgba(220, 53, 69, 0.8), 0 0 24px rgba(220, 53, 69, 0.5) !important;
        }

        [data-bs-theme="dark"] .pick-avatar.pick-pending {
            border-color: #ffc107 !important;
            box-shadow: 0 0 12px rgba(255, 193, 7, 0.8), 0 0 24px rgba(255, 193, 7, 0.5) !important;
        }

        [data-bs-theme="dark"] .pick-avatar.pick-correct:hover {
            box-shadow: 0 0 16px rgba(25, 135, 84, 0.9), 0 0 32px rgba(25, 135, 84, 0.6), 0 4px 16px rgba(25, 135, 84, 0.7) !important;
        }

        [data-bs-theme="dark"] .pick-avatar.pick-incorrect:hover {
            box-shadow: 0 0 16px rgba(220, 53, 69, 0.9), 0 0 32px rgba(220, 53, 69, 0.6), 0 4px 16px rgba(220, 53, 69, 0.7) !important;
        }

        [data-bs-theme="dark"] .pick-avatar.pick-pending:hover {
            box-shadow: 0 0 16px rgba(255, 193, 7, 0.9), 0 0 32px rgba(255, 193, 7, 0.6), 0 4px 16px rgba(255, 193, 7, 0.7) !important;
        }
        
        [data-bs-theme="dark"] .missing-pick-avatar {
            border-color: #dc3545 !important;
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.7), 0 0 20px rgba(220, 53, 69, 0.4) !important;
        }

        [data-bs-theme="dark"] .missing-pick-avatar:hover {
            box-shadow: 0 0 16px rgba(220, 53, 69, 0.9), 0 0 32px rgba(220, 53, 69, 0.6), 0 4px 16px rgba(220, 53, 69, 0.7) !important;
        }
        
        [data-bs-theme="dark"] .tiebreaker-mini {
            color: #adb5bd !important;
        }
        
        /* Dark mode team picks and missing picks */
        [data-bs-theme="dark"] .team-picks-list {
            background: rgba(255, 255, 255, 0.05) !important;
        }
        
        [data-bs-theme="dark"] .team-picks-name {
            color: #ffffff !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8) !important;
        }
        
        [data-bs-theme="dark"] .pick-username {
            color: #e9ecef !important;
        }
        
        [data-bs-theme="dark"] .missing-picks-section {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }
        
        [data-bs-theme="dark"] .missing-picks-header {
            color: #e9ecef !important;
        }
        
        [data-bs-theme="dark"] .no-picks-message {
            color: #adb5bd !important;
        }
        
        /* Mobile responsive styles for pick usernames */
        @media (max-width: 768px) {
            .pick-player {
                min-width: 50px;
                gap: 0.2rem;
                margin: 0.2rem;
            }
            
            .pick-username {
                font-size: 0.7rem;
                max-width: 50px;
            }
            
            .pick-avatar {
                width: 40px;
                height: 40px;
            }
        }
        
    `;
    document.head.appendChild(immediateDarkModeStyle);

    // Live Score Updates
    let updateInterval;
    let lastUpdateTime = Date.now();
    
    function createUpdateIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'live-update-indicator';
        indicator.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Live Updates Active';
        document.body.appendChild(indicator);
        return indicator;
    }
    
    function showUpdateIndicator(indicator, message = 'Updating scores...') {
        indicator.innerHTML = `<i class="fas fa-sync-alt me-1"></i>${message}`;
        indicator.classList.add('show');
        setTimeout(() => {
            indicator.classList.remove('show');
        }, 2000);
    }
    
    function hasLiveGames() {
        return document.querySelectorAll('[data-game-status="inprogress"]').length > 0;
    }
    
    async function updateLiveScores() {
        console.log('updateLiveScores called');
        
        if (!hasLiveGames()) {
            console.log('No live games found, stopping updates');
            return false; // No live games, stop updating
        }
        
        console.log('Live games detected, proceeding with update');
        const indicator = document.querySelector('.live-update-indicator') || createUpdateIndicator();
        
        try {
            // Add visual indication that scores are updating
            const liveCards = document.querySelectorAll('[data-game-status="inprogress"]');
            liveCards.forEach(card => card.classList.add('score-updating'));
            
            showUpdateIndicator(indicator, 'Updating live scores...');
            
            // Fetch updated page content
            const currentUrl = window.location.href;
            console.log('Fetching fresh data from:', currentUrl);
            
            // Add timestamp to prevent caching issues
            const separator = currentUrl.includes('?') ? '&' : '?';
            const fetchUrl = `${currentUrl}${separator}_t=${Date.now()}`;
            
            const response = await fetch(fetchUrl, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                },
                cache: 'no-store',
                credentials: 'same-origin'
            });
            
            console.log('Fetch response status:', response.status, response.statusText);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const html = await response.text();
            const parser = new DOMParser();
            const newDoc = parser.parseFromString(html, 'text/html');
            
            // Update game scores and status
            const currentGames = document.querySelectorAll('.game-score-card');
            const newGames = newDoc.querySelectorAll('.game-score-card');
            
            console.log(`Found ${currentGames.length} current games, ${newGames.length} new games`);
            
            let gamesUpdated = 0;
            let completedGames = 0;
            
            currentGames.forEach((currentGame, index) => {
                if (newGames[index]) {
                    const currentStatus = currentGame.getAttribute('data-game-status');
                    const newStatus = newGames[index].getAttribute('data-game-status');
                    
                    console.log(`\n--- Game ${index} (Status: ${currentStatus} → ${newStatus}) ---`);
                    
                    // Check if game status changed or scores updated
                    const currentScores = currentGame.querySelectorAll('.total-score, .quarter-score');
                    const newScores = newGames[index].querySelectorAll('.total-score, .quarter-score');
                    
                    let scoresChanged = false;
                    console.log(`Game ${index}: Comparing ${currentScores.length} current scores with ${newScores.length} new scores`);
                    
                    currentScores.forEach((score, scoreIndex) => {
                        const currentText = score.textContent.trim();
                        const newText = newScores[scoreIndex] ? newScores[scoreIndex].textContent.trim() : 'N/A';
                        
                        console.log(`  Score ${scoreIndex}: "${currentText}" vs "${newText}"`);
                        
                        if (newScores[scoreIndex] && currentText !== newText) {
                            console.log(`  ✓ Score changed: "${currentText}" → "${newText}"`);
                            scoresChanged = true;
                        }
                    });
                    
                    const statusChanged = currentStatus !== newStatus;
                    if (statusChanged) {
                        console.log(`Status changed: "${currentStatus}" → "${newStatus}"`);
                    }
                    
                    // Update if scores changed or status changed
                    if (scoresChanged || statusChanged) {
                        console.log(`  → Updating game ${index} (scores: ${scoresChanged}, status: ${statusChanged})`);
                        
                        // Update the entire game card content
                        currentGame.innerHTML = newGames[index].innerHTML;
                        currentGame.setAttribute('data-game-status', newStatus);
                        
                        // Re-apply dark mode styles after content update
                        setTimeout(() => {
                            if (typeof forceDarkModeScores === 'function') {
                                forceDarkModeScores();
                            }
                        }, 10);
                        
                        // Add update animation
                        currentGame.style.animation = 'none';
                        currentGame.offsetHeight; // Trigger reflow
                        currentGame.style.animation = 'fadeIn 0.5s ease-in';
                        
                        gamesUpdated++;
                        
                        // Check if game just completed
                        if (currentStatus === 'inprogress' && newStatus === 'finished') {
                            completedGames++;
                            // Add completion effect
                            currentGame.style.border = '2px solid #28a745';
                            setTimeout(() => {
                                currentGame.style.border = '';
                            }, 3000);
                        }
                    } else {
                        console.log(`  → No changes detected for game ${index}`);
                    }
                }
            });
            
            // Update weekly performance stats if user is authenticated
            const currentStats = document.querySelector('.weekly-performance-stats');
            const newStats = newDoc.querySelector('.weekly-performance-stats');
            if (currentStats && newStats && currentStats.innerHTML !== newStats.innerHTML) {
                currentStats.innerHTML = newStats.innerHTML;
                currentStats.style.animation = 'fadeIn 0.5s ease-in';
            }
            
            // Update week points leaderboard
            const currentLeaderboard = document.getElementById('week-points-leaderboard');
            const newLeaderboard = newDoc.getElementById('week-points-leaderboard');
            if (currentLeaderboard && newLeaderboard && currentLeaderboard.innerHTML !== newLeaderboard.innerHTML) {
                currentLeaderboard.innerHTML = newLeaderboard.innerHTML;
                currentLeaderboard.style.animation = 'fadeIn 0.5s ease-in';
                
                // Refresh the Week Points layout after updating leaderboard content
                if (typeof window.weekPointsLayoutManager !== 'undefined') {
                    setTimeout(() => {
                        try {
                            window.weekPointsLayoutManager.refresh();
                            console.log('Week Points layout refreshed successfully');
                        } catch (error) {
                            console.error('Error refreshing Week Points layout:', error);
                        }
                    }, 100); // Small delay to let animation start
                }
            }
            
            // Remove updating animation
            liveCards.forEach(card => card.classList.remove('score-updating'));
            
            // Show appropriate update message
            if (completedGames > 0) {
                showUpdateIndicator(indicator, `${completedGames} game(s) completed! Picks scored.`);
                console.log(`Live update: ${completedGames} game(s) completed`);
            } else if (gamesUpdated > 0) {
                showUpdateIndicator(indicator, `${gamesUpdated} game(s) updated`);
                console.log(`Live update: ${gamesUpdated} game(s) updated`);
            } else {
                console.log('Live update: No changes detected');
            }
            
            lastUpdateTime = Date.now();
            return hasLiveGames(); // Return true if there are still live games
            
        } catch (error) {
            console.error('Error updating live scores:', error);
            console.error('Error details:', {
                message: error.message,
                stack: error.stack,
                url: window.location.href
            });
            
            // Show specific error message
            if (error.message.includes('Failed to fetch')) {
                showUpdateIndicator(indicator, 'Network error - retrying in 30s...');
                console.log('Network error detected - this could be due to CORS, server issues, or connectivity');
            } else {
                showUpdateIndicator(indicator, 'Update failed - retrying...');
            }
            
            // Remove updating animation on error
            const liveCards = document.querySelectorAll('[data-game-status="inprogress"]');
            liveCards.forEach(card => card.classList.remove('score-updating'));
            
            return hasLiveGames();
        }
    }
    
    function startLiveUpdates() {
        if (!hasLiveGames()) {
            return;
        }
        
        const indicator = createUpdateIndicator();
        showUpdateIndicator(indicator, 'Live updates starting...');
        
        // Update every 30 seconds when games are live
        updateInterval = setInterval(async () => {
            const stillHasLiveGames = await updateLiveScores();
            
            if (!stillHasLiveGames) {
                // No more live games, stop updates
                clearInterval(updateInterval);
                const indicator = document.querySelector('.live-update-indicator');
                if (indicator) {
                    showUpdateIndicator(indicator, 'All games completed');
                    setTimeout(() => {
                        indicator.remove();
                    }, 3000);
                }
            }
        }, 30000); // Update every 30 seconds
        
        // Also update when user returns to tab (visibility change)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && hasLiveGames()) {
                // User returned to tab, update immediately if it's been more than 10 seconds
                if (Date.now() - lastUpdateTime > 10000) {
                    updateLiveScores();
                }
            }
        });
    }
    
    // Debug function for manual testing
    window.testLiveUpdate = function() {
        console.log('Manual live update test initiated');
        console.log('Live games present:', hasLiveGames());
        console.log('Live games count:', document.querySelectorAll('[data-game-status="inprogress"]').length);
        updateLiveScores();
    };
    
    // Start live updates when page loads if there are live games
    if (hasLiveGames()) {
        console.log('Live games detected on page load, starting updates in 2 seconds');
        // Initial delay to let page fully load
        setTimeout(startLiveUpdates, 2000);
    } else {
        console.log('No live games detected on page load');
    }
    
    // Restart live updates when filter changes to show live games
    const originalFilterGames = filterGames;
    filterGames = function(filterType) {
        originalFilterGames(filterType);
        
        // If user filters to show live games and there are live games, start updates
        if ((filterType === 'all' || filterType === 'live') && hasLiveGames() && !updateInterval) {
            setTimeout(startLiveUpdates, 1000);
        }
    };
    
    // Force dark mode styling - Focus on existing elements
    function forceDarkModeScores() {
        if (document.documentElement.getAttribute('data-bs-theme') === 'dark') {
            console.log('Applying dark mode fixes to scores page...');
            
            // Target Week Points leaderboard
            // COMMENTED OUT - Using Tailwind CSS backgrounds now
            // const pointsLeaderboard = document.querySelector('#week-points-leaderboard');
            // if (pointsLeaderboard) {
            //     pointsLeaderboard.style.setProperty('background-color', '#404040', 'important');
            //     pointsLeaderboard.style.setProperty('background', '#404040', 'important');
            //     pointsLeaderboard.style.setProperty('color', '#ffffff', 'important');
            // }
            
            // Force Week Points player cards
            const playerCards = document.querySelectorAll('.player-points-card');
            playerCards.forEach(card => {
                card.style.setProperty('background-color', '#404040', 'important');
                card.style.setProperty('background', '#404040', 'important');
                card.style.setProperty('color', '#ffffff', 'important');
                card.style.setProperty('border', '1px solid #555555', 'important');
            });
            
            // Force section containers
            const sectionContainers = document.querySelectorAll('.scores-main-container .section-container');
            sectionContainers.forEach(section => {
                section.style.setProperty('background-color', '#333333', 'important');
                section.style.setProperty('background', '#333333', 'important');
                section.style.setProperty('color', '#ffffff', 'important');
            });
            
            // 1. Fix ALL game score cards - the main issue
            const gameScoreCards = document.querySelectorAll('.game-score-card');
            console.log(`Found ${gameScoreCards.length} game score cards`);
            gameScoreCards.forEach(card => {
                card.style.setProperty('background', 'linear-gradient(135deg, #404040 0%, #4a4a4a 50%, #505050 100%)', 'important');
                card.style.setProperty('background-color', '#404040', 'important');
                card.style.setProperty('color', '#ffffff', 'important');
                card.style.setProperty('border', '1px solid #555555', 'important');
                card.style.removeProperty('background-image');
            });
            
            // 2. Fix game status headers
            const gameStatusHeaders = document.querySelectorAll('.game-status-header');
            console.log(`Found ${gameStatusHeaders.length} game status headers`);
            gameStatusHeaders.forEach(header => {
                header.style.setProperty('background', '#2a2a2a', 'important');
                header.style.setProperty('background-color', '#2a2a2a', 'important');
                header.style.setProperty('color', '#ffffff', 'important');
                header.style.setProperty('border-bottom', '1px solid #555555', 'important');
            });
            
            // 3. Fix game info bars (spread, weather, etc.)
            const gameInfoBars = document.querySelectorAll('.game-info-bar');
            console.log(`Found ${gameInfoBars.length} game info bars`);
            gameInfoBars.forEach(bar => {
                bar.style.setProperty('background', '#2a2a2a', 'important');
                bar.style.setProperty('background-color', '#2a2a2a', 'important');
                bar.style.setProperty('color', '#ffffff', 'important');
            });
            
            // 4. Fix game info items (buttons inside info bar)
            const gameInfoItems = document.querySelectorAll('.game-info-item');
            console.log(`Found ${gameInfoItems.length} game info items`);
            gameInfoItems.forEach(item => {
                item.style.setProperty('background', '#333333', 'important');
                item.style.setProperty('background-color', '#333333', 'important');
                item.style.setProperty('color', '#ffffff', 'important');
                item.style.setProperty('border', '1px solid #555555', 'important');
            });
            
            // 5. Fix team score rows
            const teamScoreRows = document.querySelectorAll('.team-score-row');
            console.log(`Found ${teamScoreRows.length} team score rows`);
            teamScoreRows.forEach(row => {
                row.style.setProperty('background', 'transparent', 'important');
                row.style.setProperty('color', '#ffffff', 'important');
            });
            
            // 6. Fix team names
            const teamNames = document.querySelectorAll('.team-name');
            console.log(`Found ${teamNames.length} team names`);
            teamNames.forEach(name => {
                name.style.setProperty('color', '#ffffff', 'important');
            });
            
            // Remove any dark mode styling from total-score elements to let them use default light mode colors
            const totalScoreElements = document.querySelectorAll('.total-score');
            totalScoreElements.forEach((score) => {
                // Remove any inline styles that might be interfering
                score.removeAttribute('style');
                
                // Remove any dark mode classes
                score.classList.remove('dark-mode-override');
            });
            
            // 7b. Fix LIVE button containers specifically
            const gameStatusDisplays = document.querySelectorAll('.game-status-display');
            console.log(`Found ${gameStatusDisplays.length} game status displays`);
            gameStatusDisplays.forEach(display => {
                display.style.setProperty('background', '#2a2a2a', 'important');
                display.style.setProperty('background-color', '#2a2a2a', 'important');
                display.style.setProperty('border', '1px solid #555555', 'important');
                display.style.setProperty('padding', '0.5rem', 'important');
            });
            
            // 8. Fix live status elements
            const liveElements = document.querySelectorAll('.game-status.live, .status-live');
            liveElements.forEach(el => {
                el.style.setProperty('background', 'linear-gradient(135deg, #28a745 0%, #20c997 100%)', 'important');
                el.style.setProperty('background-color', '#28a745', 'important');
                el.style.setProperty('color', '#ffffff', 'important');
            });
            
            // REMOVED - Let Player Picks sections use transparent background
            
            // REMOVED - Let Your Pick sections use transparent background
            
            // REMOVED - Let Missing Picks sections use transparent background
            
            
            // 11. Force any remaining white elements
            const whiteElements = document.querySelectorAll('.scores-main-container *');
            whiteElements.forEach(el => {
                const styles = window.getComputedStyle(el);
                const rect = el.getBoundingClientRect();
                
                if (styles.backgroundColor === 'rgb(255, 255, 255)' && rect.width > 10 && rect.height > 10) {
                    el.style.setProperty('background-color', '#404040', 'important');
                    el.style.setProperty('background', '#404040', 'important');
                    el.style.setProperty('color', '#ffffff', 'important');
                    el.style.removeProperty('background-image');
                    el.style.removeProperty('background-gradient');
                }
            });
            
            console.log('Dark mode fixes applied to scores page');
        }
    }
    
    // Run immediately and after any dynamic content loads
    document.addEventListener('DOMContentLoaded', forceDarkModeScores);
    setTimeout(forceDarkModeScores, 100);
    setTimeout(forceDarkModeScores, 500);
    setTimeout(forceDarkModeScores, 1000);
    
    // Override layout manager to apply dark mode after it runs
    if (window.weekPointsLayoutManager) {
        const originalApply = window.weekPointsLayoutManager.apply;
        window.weekPointsLayoutManager.apply = function() {
            originalApply.call(this);
            setTimeout(forceDarkModeScores, 50);
        };
        
        const originalRefresh = window.weekPointsLayoutManager.refresh;
        window.weekPointsLayoutManager.refresh = function() {
            originalRefresh.call(this);
            setTimeout(forceDarkModeScores, 50);
        };
    }
    
    // Run when layout manager initializes
    setTimeout(() => {
        if (window.weekPointsLayoutManager) {
            forceDarkModeScores();
        }
    }, 1500);
    
    // Handle hiding empty team pick sections with JavaScript (more reliable than CSS :has())
    function hideEmptyTeamPickSections() {
        const teamPickGroups = document.querySelectorAll('.team-picks-group');
        teamPickGroups.forEach(group => {
            const picksList = group.querySelector('.team-picks-list');
            const pickAvatars = picksList ? picksList.querySelectorAll('.pick-avatar') : [];
            
            // Hide if no pick avatars found
            if (pickAvatars.length === 0) {
                group.style.display = 'none';
            } else {
                group.style.display = 'block';
            }
        });
    }
    
    // Run after page load and after any updates
    hideEmptyTeamPickSections();
    setTimeout(hideEmptyTeamPickSections, 100);
    }); // End DOMContentLoaded

    </script>

    <!-- Alpine.js for collapsible sections -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

{% endblock %}