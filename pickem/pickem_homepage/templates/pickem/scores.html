{% extends 'pickem/base.html' %}
{% load static %}
{% load pickem_homepage_extras %}

{% block mobile_title %}
    <div class="mobile-page-header">
        <h2 class="mobile-title-text">
            <i class="fas fa-chart-line me-2"></i>Live Scores
        </h2>
        <div class="mobile-subtitle">
            {% if competition == 'nfl-preseason' %}
                Preseason - Week {{ week }}
            {% else %}
                Regular Season - Week {{ week }}
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block content %}

<div class="container min-vh-100">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <div class="container standings-main-container">
        <div class="col">
        <!-- Page Header -->
        <div class="page-header-clean text-center d-none d-lg-block mb-4">
            <h2 class="page-title">
                <i class="fas fa-chart-line me-3"></i>Live Scores
            </h2>
            <p class="page-subtitle">
                {% if competition == 'nfl-preseason' %}
                    Preseason - Week {{ week }}
                {% else %}
                    Regular Season - Week {{ week }}
                {% endif %}
            </p>
        </div>


        <!-- Your Weekly Performance Section (Compact) -->
        {% if user.is_authenticated and user_weekly_stats %}
        <div class="section-container mb-4 weekly-performance-compact">
            <div class="weekly-performance-avatar">
                <img src="{{ user.socialaccount_set.all.0.get_avatar_url }}" 
                     alt="Your profile picture" 
                     class="player-avatar">
            </div>
            <div class="weekly-performance-stats">
                <div class="stat-item">
                    <span class="stat-label">Picks Accuracy:</span>
                    <span class="stat-value">{{ user_weekly_stats.accuracy }}% <small>({{ user_weekly_stats.correct_picks }}/{{ user_weekly_stats.total_graded_picks }} Graded)</small></span>
                    <br />
                    <span class="stat-label">Correct Picks:</span>
                    <span class="stat-value">{{ user_weekly_stats.correct_picks }}</span>
                    <br />
                    <span class="stat-label">Week {{ week }} Points:</span>
                    <span class="stat-value">{{ user_weekly_stats.weekly_points }}</span>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="section-container mb-4">
            <div class="filter-controls d-flex flex-wrap gap-2 justify-content-center">
                <button class="btn btn-outline-primary btn-sm filter-btn active" data-filter="all">
                    <i class="fas fa-list me-1"></i>All Games
                </button>
                <button class="btn btn-outline-success btn-sm filter-btn" data-filter="live">
                    <i class="fas fa-circle me-1 pulse-icon"></i>Live
                </button>
                <button class="btn btn-outline-danger btn-sm filter-btn" data-filter="final">
                    <i class="fas fa-flag-checkered me-1"></i>Final
                </button>
                <button class="btn btn-outline-info btn-sm filter-btn" data-filter="upcoming">
                    <i class="fas fa-clock me-1"></i>Upcoming
                </button>
            </div>
        </div>

        

        <!-- Week Stats Sidebar - Moved Above Games -->
        {% if show_week_stats_sidebar %}
        
        <!-- Week Winner Card - Full Width on Top -->
        {% for player in week_winner %}
        {% if player.id != None %}
        <div class="row mt-2 mb-3">
            <div class="col-12">
                <div class="section-container mb-4">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i class="fas fa-trophy me-2"></i>Week Winner
                        </h3>
                    </div>
                    <div class="winner-showcase">
                        {% with player.userID|lookupname as username %}
                        {% with player.userID|lookupavatar as avatar %}
                        <div class="winner-profile">
                            <a href="{% url 'user_profile' player.userID %}" class="winner-avatar-link">
                                <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}" 
                                     alt="Profile picture for {{ username }}" 
                                     class="winner-avatar">
                            </a>
                            <div class="winner-details">
                                <h4 class="winner-name">{{ username|default:"Unknown Player" }}</h4>
                                <div class="winner-badge">
                                    <i class="fas fa-crown me-1"></i>Champion
                                </div>
                            </div>
                        </div>
                        {% endwith %}
                        {% endwith %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
        
        <!-- Week Points Leaderboard - Two Columns on Large Screens -->
        <div class="row mt-2 mb-3">
            <div class="col-12">
                <div class="section-container">
                    <div class="section-header collapsible-header" data-bs-toggle="collapse" data-bs-target="#week-points-leaderboard" aria-expanded="true">
                        <div class="section-header-content">
                            <h3 class="section-title">
                                <i class="fas fa-list-ol me-2"></i>Week Points
                            </h3>
                        </div>
                        <div class="collapse-indicator">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                    <div class="points-leaderboard points-leaderboard-multi-column collapse show" id="week-points-leaderboard">
                        {% for player in user_points %}
                        <div class="player-points-card">
                            {% with player.uid|lookupname as username %}
                            {% with player.uid|lookupavatar as avatar %}
                            <div class="player-info">
                                <a href="{% url 'user_profile' player.uid %}" class="player-mini-avatar-link">
                                    <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}" 
                                         alt="Profile picture for {{ username }}" 
                                         class="player-mini-avatar">
                                </a>
                                <div class="player-details">
                                    <div class="player-name">{{ username|default:"Unknown Player" }}</div>
                                </div>
                            </div>
                            <div class="player-score">
                                <span class="score-value">{{ player.wins }}</span>
                                <span class="score-label">pts</span>
                            </div>
                            {% endwith %}
                            {% endwith %}
                        </div>
                        {% endfor %}

                        {% for player in players_names %}
                        {% if player not in users_w_points %}
                        <div class="player-points-card">
                            {% with player|lookupname as username %}
                            {% with player|lookupavatar as avatar %}
                            <div class="player-info">
                                <a href="{% url 'user_profile' player %}" class="player-mini-avatar-link">
                                    <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}" 
                                         alt="Profile picture for {{ username }}" 
                                         class="player-mini-avatar">
                                </a>
                                <div class="player-details">
                                    <div class="player-name">{{ username|default:"Unknown Player" }}</div>
                                </div>
                            </div>
                            <div class="player-score">
                                <span class="score-value">0</span>
                                <span class="score-label">pts</span>
                            </div>
                            {% endwith %}
                            {% endwith %}
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    <script>
                        // Week Points Leaderboard Layout Manager
                        window.weekPointsLayoutManager = (function() {
                            const CONTAINER_ID = 'week-points-leaderboard';
                            let originalCards = [];
                            
                            function captureOriginalCards() {
                                try {
                                    const container = document.getElementById(CONTAINER_ID);
                                    if (!container) return;
                                    
                                    // Capture cards if we haven't already or if container was reset
                                    if (originalCards.length === 0 || !container.querySelector('.points-column')) {
                                        const playerCards = container.querySelectorAll('.player-points-card');
                                        if (playerCards.length > 0) {
                                            originalCards = Array.from(playerCards).map(card => card.cloneNode(true));
                                        }
                                    }
                                } catch (error) {
                                    console.error('Error capturing original cards:', error);
                                }
                            }
                            
                            function applyColumnLayout() {
                                try {
                                    const container = document.getElementById(CONTAINER_ID);
                                    if (!container) return;
                                    
                                    captureOriginalCards();
                                    const totalCards = originalCards.length;
                                
                                if (window.innerWidth >= 992 && totalCards > 0) {
                                    // Only rebuild if not already in column layout
                                    if (!container.querySelector('.points-column')) {
                                        // Clear container
                                        container.innerHTML = '';
                                        
                                        // Create two columns
                                        const leftColumn = document.createElement('div');
                                        leftColumn.className = 'points-column points-column-left';
                                        const rightColumn = document.createElement('div');
                                        rightColumn.className = 'points-column points-column-right';
                                        
                                        // Calculate split point (first half goes to left, second half to right)
                                        const halfPoint = Math.ceil(totalCards / 2);
                                        
                                        // Distribute cards
                                        for (let i = 0; i < totalCards; i++) {
                                            if (i < halfPoint) {
                                                leftColumn.appendChild(originalCards[i].cloneNode(true));
                                            } else {
                                                rightColumn.appendChild(originalCards[i].cloneNode(true));
                                            }
                                        }
                                        
                                        container.appendChild(leftColumn);
                                        container.appendChild(rightColumn);
                                    }
                                } else {
                                    // Mobile: restore original single-column layout
                                    if (container.querySelector('.points-column')) {
                                        container.innerHTML = '';
                                        originalCards.forEach(card => {
                                            container.appendChild(card.cloneNode(true));
                                        });
                                    }
                                }
                                } catch (error) {
                                    console.error('Error applying column layout:', error);
                                }
                            }
                            
                            function refreshLayout() {
                                // Reset to allow recapture of cards
                                originalCards = [];
                                applyColumnLayout();
                            }
                            
                            // Public interface
                            return {
                                init: function() {
                                    applyColumnLayout();
                                    window.addEventListener('resize', applyColumnLayout);
                                },
                                refresh: refreshLayout,
                                apply: applyColumnLayout
                            };
                        })();
                        
                        // Initialize on page load
                        weekPointsLayoutManager.init();
                    </script>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Games by Start Time - Full Width -->
        {% if game_list %}
            {% regroup game_list by startTimestamp as games_by_time %}
            {% for time_group in games_by_time %}
            <div class="time-group-full-width">
                <div class="section-header collapsible-header" data-bs-toggle="collapse" data-bs-target="#games-{{ time_group.grouper|date:'Y-m-d-Hi' }}" aria-expanded="true">
                    <div class="section-header-content">
                        <h3 class="section-title">
                            <i class="fas fa-calendar me-2"></i>{{ time_group.grouper|date:"l, F j" }}
                        </h3>
                        <span class="game-time-display">{{ time_group.grouper|date:"g:i A" }}</span>
                    </div>
                    <div class="collapse-indicator">
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>

                <div class="games-grid collapse show" id="games-{{ time_group.grouper|date:'Y-m-d-Hi' }}">
                            {% for game in time_group.list %}
                            <div class="game-score-card" data-game-status="{{ game.statusType|lower }}">
                                <!-- Main Game Content (consistent height) -->
                                <div class="game-main-content">
                                    <!-- Game Status Header -->
                                    <div class="game-status-header {% if game.statusType == 'inprogress' %}status-live{% else %}status-standard{% endif %}">
                                        <div class="status-info">
                                            <i class="fas {% if game.statusType == 'inprogress' %}fa-circle status-live-dot{% elif game.statusType == 'finished' %}fa-check-circle{% else %}fa-clock{% endif %} me-2"></i>
                                            {{ game.statusTitle }}
                                        </div>
                                        <div class="game-time">
                                            {{ game.startTimestamp|date:"g:i A" }}
                                        </div>
                                    </div>

                                    <!-- Game Info (Spread, Weather, etc.) -->
                                {% if game.spread or game.overUnder or game.temperature or game.weatherCondition %}
                                <div class="game-info-bar">
                                    {% if game.spread %}
                                    <div class="game-info-item spread-item">
                                        <i class="fas fa-chart-line me-1"></i>
                                        <span class="info-label">Spread:</span>
                                        <span class="info-value spread-value">
                                            {% if game.spread > 0 %}
                                                {% with game.homeTeamSlug|lookuplogo as logo_url %}
                                                <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}" alt="{{ game.homeTeamName }} logo" class="spread-team-logo">
                                                {% endwith %}
                                                -{{ game.spread|floatformat:1 }}
                                            {% else %}
                                                {% with game.awayTeamSlug|lookuplogo as logo_url %}
                                                <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}" alt="{{ game.awayTeamName }} logo" class="spread-team-logo">
                                                {% endwith %}
                                                -{{ game.spread|floatformat:1|cut:"-" }}
                                            {% endif %}
                                        </span>
                                    </div>
                                    {% endif %}
                                    {% if game.overUnder %}
                                    <div class="game-info-item">
                                        <i class="fas fa-calculator me-1"></i>
                                        <span class="info-label">O/U:</span>
                                        <span class="info-value">{{ game.overUnder|floatformat:1 }}</span>
                                    </div>
                                    {% endif %}
                                    {% if game.temperature and game.weatherCondition %}
                                    <div class="game-info-item">
                                        {% if 'Sun' in game.weatherCondition or 'Clear' in game.weatherCondition %}
                                            <i class="fas fa-sun me-1" title="Sunny/Clear"></i>
                                        {% elif 'Cloud' in game.weatherCondition %}
                                            <i class="fas fa-cloud me-1" title="Cloudy"></i>
                                        {% elif 'Rain' in game.weatherCondition or 'Shower' in game.weatherCondition %}
                                            <i class="fas fa-cloud-rain me-1" title="Rainy"></i>
                                        {% elif 'Snow' in game.weatherCondition %}
                                            <i class="fas fa-snowflake me-1" title="Snowy"></i>
                                        {% elif 'Storm' in game.weatherCondition or 'Thunder' in game.weatherCondition %}
                                            <i class="fas fa-bolt me-1" title="Stormy"></i>
                                        {% elif 'Wind' in game.weatherCondition %}
                                            <i class="fas fa-wind me-1" title="Windy"></i>
                                        {% elif 'Fog' in game.weatherCondition %}
                                            <i class="fas fa-smog me-1" title="Foggy"></i>
                                        {% else %}
                                            <i class="fas fa-thermometer-half me-1" title="Weather"></i>
                                        {% endif %}
                                        <span class="info-value">{{ game.temperature }}°F, {{ game.weatherCondition }}</span>
                                    </div>
                                    {% endif %}
                                    {% if game.venueIndoor %}
                                    <div class="game-info-item">
                                        <i class="fas fa-home me-1"></i>
                                        <span class="info-value">Indoor</span>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}

                                <!-- Teams and Scores -->
                                <div class="teams-matchup">
                                    <!-- Away Team -->
                                    <div class="team-score-row {% if game.statusType == 'finished' and game.gameWinner == game.awayTeamSlug %}winning-team{% endif %}">
                                        <div class="team-info">
                                            {% with game.awayTeamSlug|lookuplogo as logo_url %}
                                            <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}" 
                                                 alt="{{ game.awayTeamName }} logo" 
                                                 class="team-logo">
                                            {% endwith %}
                                            <div class="team-details">
                                                <div class="team-name {% if game.statusType == 'finished' and game.gameWinner != game.awayTeamSlug %}text-muted{% endif %}">
                                                    {{ game.awayTeamName }}
                                                    {% if game.statusType == 'finished' and game.gameWinner == game.awayTeamSlug %}
                                                        <i class="fas fa-chevron-right ms-1 winner-indicator"></i>
                                                    {% endif %}
                                                </div>
                                                <div class="team-details">
                                                    <div class="team-record">
                                                        {% for team in wins_losses %}
                                                            {% if team.teamNameSlug == game.awayTeamSlug %}
                                                                {% if team.teamTies > 0 %}
                                                                    ({{ team.teamWins }}-{{ team.teamLosses }}-{{ team.teamTies }})
                                                                {% else %}
                                                                    ({{ team.teamWins }}-{{ team.teamLosses }})
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                    {% if game.awayTeamWinProbability %}
                                                    <div class="performance-item">
                                                        <span class="performance-label">Win Chance</span>
                                                        <div class="progress-container">
                                                            <div class="progress-bar">
                                                                <div class="progress-fill" style="width: {{ game.awayTeamWinProbability|floatformat:0 }}%"></div>
                                                            </div>
                                                            <span class="progress-text">{{ game.awayTeamWinProbability|floatformat:0 }}%</span>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {% if game.statusType != 'notstarted' %}
                                        <div class="score-breakdown">
                                            <div class="quarters">
                                                <span class="quarter-score">{{ game.awayTeamPeriod1|default:"—" }}</span>
                                                <span class="quarter-score">{{ game.awayTeamPeriod2|default:"—" }}</span>
                                                <span class="quarter-score">{{ game.awayTeamPeriod3|default:"—" }}</span>
                                                <span class="quarter-score">{{ game.awayTeamPeriod4|default:"—" }}</span>
                                            </div>
                                            <div class="total-score">{{ game.awayTeamScore|default:"0" }}</div>
                                        </div>
                                        {% endif %}
                                    </div>

                                    <!-- Home Team -->
                                    <div class="team-score-row {% if game.statusType == 'finished' and game.gameWinner == game.homeTeamSlug %}winning-team{% endif %}">
                                        <div class="team-info">
                                            {% with game.homeTeamSlug|lookuplogo as logo_url %}
                                            <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}" 
                                                 alt="{{ game.homeTeamName }} logo" 
                                                 class="team-logo">
                                            {% endwith %}
                                            <div class="team-details">
                                                <div class="team-name {% if game.statusType == 'finished' and game.gameWinner != game.homeTeamSlug %}text-muted{% endif %}">
                                                    {{ game.homeTeamName }}
                                                    {% if game.statusType == 'finished' and game.gameWinner == game.homeTeamSlug %}
                                                        <i class="fas fa-chevron-right ms-1 winner-indicator"></i>
                                                    {% endif %}
                                                </div>
                                                <div class="team-details">
                                                    <div class="team-record">
                                                        {% for team in wins_losses %}
                                                            {% if team.teamNameSlug == game.homeTeamSlug %}
                                                                {% if team.teamTies > 0 %}
                                                                    ({{ team.teamWins }}-{{ team.teamLosses }}-{{ team.teamTies }})
                                                                {% else %}
                                                                    ({{ team.teamWins }}-{{ team.teamLosses }})
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                    {% if game.homeTeamWinProbability %}
                                                    <div class="performance-item">
                                                        <span class="performance-label">Win Chance</span>
                                                        <div class="progress-container">
                                                            <div class="progress-bar">
                                                                <div class="progress-fill" style="width: {{ game.homeTeamWinProbability|floatformat:0 }}%"></div>
                                                            </div>
                                                            <span class="progress-text">{{ game.homeTeamWinProbability|floatformat:0 }}%</span>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {% if game.statusType != 'notstarted' %}
                                        <div class="score-breakdown">
                                            <div class="quarters">
                                                <span class="quarter-score">{{ game.homeTeamPeriod1|default:"—" }}</span>
                                                <span class="quarter-score">{{ game.homeTeamPeriod2|default:"—" }}</span>
                                                <span class="quarter-score">{{ game.homeTeamPeriod3|default:"—" }}</span>
                                                <span class="quarter-score">{{ game.homeTeamPeriod4|default:"—" }}</span>
                                            </div>
                                            <div class="total-score">{{ game.homeTeamScore|default:"0" }}</div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Game Status Badge (Centered between teams) -->
                                {% if game.statusType != 'notstarted' %}
                                <div class="game-status-display">
                                    {% if game.statusType|lower == 'inprogress' %}
                                        <span class="game-status live">LIVE</span>
                                    {% elif game.statusType|lower == 'finished' %}
                                        <span class="game-status final">FINAL</span>
                                    {% elif game.statusType|lower == 'notstarted' %}
                                        <span class="game-status upcoming">UPCOMING</span>
                                    {% endif %}
                                </div>
                                {% endif %}
                                </div>
                                <!-- End Main Game Content -->

                                <!-- Player Picks Section -->
                                {% if picks %}
                                    {% if game.statusType == 'finished' or game.statusType == 'inprogress' %}
                                <div class="picks-section">
                                    <div class="picks-header">
                                        <i class="fas fa-users me-2"></i>Player Picks
                                    </div>
                                    
                                    
                                    <!-- Away Team Picks -->
                                    <div class="team-picks-group away-team-picks" data-team="{{ game.awayTeamSlug }}">
                                        <div class="team-picks-header">
                                            {% with game.awayTeamSlug|lookuplogo as logo_url %}
                                            <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}" 
                                                 alt="{{ game.awayTeamName }} logo" 
                                                 class="team-picks-logo">
                                            {% endwith %}
                                            <span class="team-picks-name">{{ game.awayTeamName }}</span>
                                        </div>
                                        <div class="team-picks-list">
                                            {% for pick in picks %}
                                                {% if pick.pick == game.awayTeamSlug %}
                                                    {% with pick.uid|lookupname as username %}
                                                    {% with pick.uid|lookupavatar as avatar %}
                                                    {% if game.statusType == 'finished' %}
                                                        {% if game.gameWinner == pick.pick %}
                                                            <div class="pick-player">
                                                                <a href="{% url 'user_profile' pick.uid %}" class="pick-avatar-link">
                                                                    <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}" 
                                                                         alt="{{ username|default:'Unknown' }}" 
                                                                         class="pick-avatar pick-correct" 
                                                                         title="{{ username|default:'Unknown' }} - Correct Pick">
                                                                </a>
                                                                <span class="pick-username">{{ username|default:'Unknown' }}</span>
                                                            </div>
                                                        {% else %}
                                                            <div class="pick-player">
                                                                <a href="{% url 'user_profile' pick.uid %}" class="pick-avatar-link">
                                                                    <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}" 
                                                                         alt="{{ username|default:'Unknown' }}" 
                                                                         class="pick-avatar pick-incorrect" 
                                                                         title="{{ username|default:'Unknown' }} - Incorrect Pick">
                                                                </a>
                                                                <span class="pick-username">{{ username|default:'Unknown' }}</span>
                                                            </div>
                                                        {% endif %}
                                                    {% elif game.statusType == 'inprogress' %}
                                                        <div class="pick-player">
                                                            <a href="{% url 'user_profile' pick.uid %}" class="pick-avatar-link">
                                                                <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}" 
                                                                     alt="{{ username|default:'Unknown' }}" 
                                                                     class="pick-avatar pick-pending" 
                                                                     title="{{ username|default:'Unknown' }} - Game In Progress">
                                                            </a>
                                                            <span class="pick-username">{{ username|default:'Unknown' }}</span>
                                                        </div>
                                                    {% endif %}
                                                        {% if pick.tieBreakerScore != None %}
                                                        <small class="tiebreaker-mini">({{ pick.tieBreakerScore }}/{{ pick.tieBreakerYards }})</small>
                                                        {% endif %}
                                                    {% endwith %}
                                                    {% endwith %}
                                                {% endif %}
                                            {% empty %}
                                            {% endfor %}
                                            {% if not picks %}
                                                <span class="no-picks-message">No picks available</span>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Home Team Picks -->
                                    <div class="team-picks-group home-team-picks" data-team="{{ game.homeTeamSlug }}">
                                        <div class="team-picks-header">
                                            {% with game.homeTeamSlug|lookuplogo as logo_url %}
                                            <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}" 
                                                 alt="{{ game.homeTeamName }} logo" 
                                                 class="team-picks-logo">
                                            {% endwith %}
                                            <span class="team-picks-name">{{ game.homeTeamName }}</span>
                                        </div>
                                        <div class="team-picks-list">
                                            {% for pick in picks %}
                                                {% if pick.pick == game.homeTeamSlug %}
                                                    {% with pick.uid|lookupname as username %}
                                                    {% with pick.uid|lookupavatar as avatar %}
                                                    {% if game.statusType == 'finished' %}
                                                        {% if game.gameWinner == pick.pick %}
                                                            <div class="pick-player">
                                                                <a href="{% url 'user_profile' pick.uid %}" class="pick-avatar-link">
                                                                    <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}" 
                                                                         alt="{{ username|default:'Unknown' }}" 
                                                                         class="pick-avatar pick-correct" 
                                                                         title="{{ username|default:'Unknown' }} - Correct Pick">
                                                                </a>
                                                                <span class="pick-username">{{ username|default:'Unknown' }}</span>
                                                            </div>
                                                        {% else %}
                                                            <div class="pick-player">
                                                                <a href="{% url 'user_profile' pick.uid %}" class="pick-avatar-link">
                                                                    <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}" 
                                                                         alt="{{ username|default:'Unknown' }}" 
                                                                         class="pick-avatar pick-incorrect" 
                                                                         title="{{ username|default:'Unknown' }} - Incorrect Pick">
                                                                </a>
                                                                <span class="pick-username">{{ username|default:'Unknown' }}</span>
                                                            </div>
                                                        {% endif %}
                                                    {% elif game.statusType == 'inprogress' %}
                                                        <div class="pick-player">
                                                            <a href="{% url 'user_profile' pick.uid %}" class="pick-avatar-link">
                                                                <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}" 
                                                                     alt="{{ username|default:'Unknown' }}" 
                                                                     class="pick-avatar pick-pending" 
                                                                     title="{{ username|default:'Unknown' }} - Game In Progress">
                                                            </a>
                                                            <span class="pick-username">{{ username|default:'Unknown' }}</span>
                                                        </div>
                                                    {% endif %}
                                                        {% if pick.tieBreakerScore != None %}
                                                        <small class="tiebreaker-mini">({{ pick.tieBreakerScore }}/{{ pick.tieBreakerYards }})</small>
                                                        {% endif %}
                                                    {% endwith %}
                                                    {% endwith %}
                                                {% endif %}
                                            {% empty %}
                                            {% endfor %}
                                            {% if not picks %}
                                                <span class="no-picks-message">No picks available</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                    {% endif %}
                                {% endif %}

                                <!-- User's Pick Highlight -->
                                {% if picks %}
                                {% for pick in picks %}
                                {% if pick.userEmail == user.email and pick.pick == game.homeTeamSlug or pick.userEmail == user.email and pick.pick == game.awayTeamSlug %}
                                <div class="user-pick-section">
                                    <div class="user-pick-header">
                                        <i class="fas fa-star me-2"></i>Your Pick
                                    </div>
                                    <div class="user-pick-display">
                                        {% if pick.pick == game.homeTeamSlug %}
                                            {% with game.homeTeamSlug|lookuplogo as logo_url %}
                                            <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}" 
                                                 alt="{{ game.homeTeamName }} logo" 
                                                 class="user-pick-logo">
                                            {% endwith %}
                                            <span class="user-pick-team">{{ game.homeTeamName }}</span>
                                        {% else %}
                                            {% with game.awayTeamSlug|lookuplogo as logo_url %}
                                            <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}" 
                                                 alt="{{ game.awayTeamName }} logo" 
                                                 class="user-pick-logo">
                                            {% endwith %}
                                            <span class="user-pick-team">{{ game.awayTeamName }}</span>
                                        {% endif %}
                                        
                                        {% if game.statusType == 'finished' %}
                                            {% if game.gameWinner == pick.pick %}
                                                <span class="pick-result pick-correct">
                                                    <i class="fas fa-check-circle me-1"></i>Correct
                                                </span>
                                            {% else %}
                                                <span class="pick-result pick-incorrect">
                                                    <i class="fas fa-times-circle me-1"></i>Incorrect
                                                </span>
                                            {% endif %}
                                        {% endif %}
                                        
                                        {% if pick.tieBreakerScore != None %}
                                        <div class="tiebreaker-display">
                                            <small>Tiebreaker: {{ pick.tieBreakerScore }} pts, {{ pick.tieBreakerYards }} yds</small>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                                {% endif %}

                                <!-- Missing Picks Alert -->
                                {% if current_week == True and game.statusType == 'notstarted' or current_week == True and game.statusType == 'delayed' %}
                                <div class="missing-picks-section" style="display: none;" id="missing-picks-{{ game.id }}">
                                    <div class="missing-picks-header">
                                        <i class="fas fa-exclamation-triangle me-2"></i>Missing Picks
                                    </div>
                                    <div class="missing-picks-list">
                                        {% for player in players_ids %}
                                            {% with player|addstr:"-"|addstr:game.id as gameid %}
                                                {% with gameid|lookuppick as count %}
                                                    {% if count == 0 %}
                                                        {% with player|lookupname as username %}
                                                        {% with player|lookupavatar as avatar %}
                                                            <div class="missing-pick-user">
                                                                <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}" 
                                                                     alt="{{ username|default:'Unknown' }}" 
                                                                     class="missing-pick-avatar" 
                                                                     title="{{ username|default:'Unknown' }} - No Pick">
                                                                <div class="missing-pick-username">{{ username|default:'Unknown' }}</div>
                                                            </div>
                                                        {% endwith %}
                                                        {% endwith %}
                                                    {% endif %}
                                                {% endwith %}
                                            {% endwith %}
                                        {% endfor %}
                                    </div>
                                </div>
                                <script>
                                    // Show missing picks section only if there are missing pick avatars
                                    (function() {
                                        var section = document.getElementById('missing-picks-{{ game.id }}');
                                        var avatars = section.querySelectorAll('.missing-pick-avatar');
                                        if (avatars.length > 0) {
                                            section.style.display = 'block';
                                        }
                                    })();
                                </script>
                                {% endif %}
                                                         </div>
                             {% endfor %}
                         </div>
                     </div>
                     {% endfor %}
                {% else %}
                <div class="section-container">
                    <div class="no-games-message text-center">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        {% if is_default_week %}
                        <h4 class="text-muted">Week {{ week }} Games Coming Soon</h4>
                        <p class="text-muted">NFL Week {{ week }} games will appear here once the schedule is released. Get ready for the season by submitting your picks!</p>
                        <div class="mt-3">
                            <a href="{% url 'game_picks' %}" class="btn btn-primary">
                                <i class="fas fa-edit me-2"></i>Submit Week {{ week }} Picks
                            </a>
                        </div>
                        {% else %}
                        <h4 class="text-muted">No games scheduled</h4>
                        <p class="text-muted">Check back later or view other weeks.</p>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

        <!-- Week Stats Sidebar - Below Games -->
        {% if show_week_stats_sidebar %}
        <div class="row mt-4 d-none">
            <div class="col-lg-6 mb-4">
                <!-- Week Winner Card -->
                {% for player in week_winner %}
                {% if player.id != None %}
                <div class="section-container mb-4">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i class="fas fa-trophy me-2"></i>Week Winner
                        </h3>
                    </div>
                    <div class="winner-showcase">
                        {% with player.userID|lookupname as username %}
                        {% with player.userID|lookupavatar as avatar %}
                        <div class="winner-profile">
                            <a href="{% url 'user_profile' player.userID %}" class="winner-avatar-link">
                                <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}" 
                                     alt="Profile picture for {{ username }}" 
                                     class="winner-avatar">
                            </a>
                            <div class="winner-details">
                                <h4 class="winner-name">{{ username|default:"Unknown Player" }}</h4>
                                <div class="winner-badge">
                                    <i class="fas fa-crown me-1"></i>Champion
                                </div>
                            </div>
                        </div>
                        {% endwith %}
                        {% endwith %}
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            
            <div class="col-lg-6 mb-4">
                <!-- Week Points Leaderboard -->
                <div class="section-container">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i class="fas fa-list-ol me-2"></i>Week Points
                        </h3>
                    </div>
                    <div class="points-leaderboard">
                        {% for player in user_points %}
                        <div class="player-points-card">
                            {% with player.uid|lookupname as username %}
                            {% with player.uid|lookupavatar as avatar %}
                            <div class="player-info">
                                <a href="{% url 'user_profile' player.uid %}" class="player-mini-avatar-link">
                                    <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}" 
                                         alt="Profile picture for {{ username }}" 
                                         class="player-mini-avatar">
                                </a>
                                <div class="player-details">
                                    <div class="player-name">{{ username|default:"Unknown Player" }}</div>
                                </div>
                            </div>
                            <div class="player-score">
                                <span class="score-value">{{ player.wins }}</span>
                                <span class="score-label">pts</span>
                            </div>
                            {% endwith %}
                            {% endwith %}
                        </div>
                        {% endfor %}

                        {% for player in players_names %}
                        {% if player not in users_w_points %}
                        <div class="player-points-card">
                            {% with player|lookupname as username %}
                            {% with player|lookupavatar as avatar %}
                            <div class="player-info">
                                <a href="{% url 'user_profile' player %}" class="player-mini-avatar-link">
                                    <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}" 
                                         alt="Profile picture for {{ username }}" 
                                         class="player-mini-avatar">
                                </a>
                                <div class="player-details">
                                    <div class="player-name">{{ username|default:"Unknown Player" }}</div>
                                </div>
                            </div>
                            <div class="player-score">
                                <span class="score-value">0</span>
                                <span class="score-label">pts</span>
                            </div>
                            {% endwith %}
                            {% endwith %}
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Collapsible Enhancement Script -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const collapsibleHeaders = document.querySelectorAll('.collapsible-header');
        
        // Restore saved states from localStorage on page load
        function restoreCollapseStates() {
            collapsibleHeaders.forEach(header => {
                const target = header.getAttribute('data-bs-target');
                const targetElement = document.querySelector(target);
                const savedState = localStorage.getItem('collapse-state-' + target);
                
                console.log('Restoring state for', target, ':', savedState); // Debug log
                
                if (savedState === 'collapsed' && targetElement) {
                    // Remove the 'show' class to collapse it
                    targetElement.classList.remove('show');
                    header.setAttribute('aria-expanded', 'false');
                } else if (savedState === 'expanded' && targetElement) {
                    // Ensure it's expanded
                    targetElement.classList.add('show');
                    header.setAttribute('aria-expanded', 'true');
                }
            });
        }
        
        // Save state when toggled
        function saveCollapseState(target, isExpanded) {
            const state = isExpanded ? 'expanded' : 'collapsed';
            localStorage.setItem('collapse-state-' + target, state);
            console.log('Saved state for', target, ':', state); // Debug log
        }
        
        // Set up event listeners for state saving
        collapsibleHeaders.forEach(header => {
            const target = header.getAttribute('data-bs-target');
            const targetElement = document.querySelector(target);
            
            // Listen for Bootstrap collapse events
            targetElement.addEventListener('shown.bs.collapse', function() {
                saveCollapseState(target, true);
                header.setAttribute('aria-expanded', 'true');
            });
            
            targetElement.addEventListener('hidden.bs.collapse', function() {
                saveCollapseState(target, false);
                header.setAttribute('aria-expanded', 'false');
            });
            
            // Add smooth scroll when expanding sections
            targetElement.addEventListener('shown.bs.collapse', function() {
                setTimeout(() => {
                    header.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 100);
            });
        });
        
        // Add keyboard support
        collapsibleHeaders.forEach(header => {
            header.setAttribute('tabindex', '0');
            header.setAttribute('role', 'button');
            
            header.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
        });
        
        // Restore states after a small delay to ensure Bootstrap is ready
        setTimeout(restoreCollapseStates, 100);
        
        // Debug: Add button to clear all saved states (remove this if not needed)
        if (localStorage.getItem('scores-debug-mode')) {
            const debugBtn = document.createElement('button');
            debugBtn.textContent = 'Clear Collapse States';
            debugBtn.style.position = 'fixed';
            debugBtn.style.top = '10px';
            debugBtn.style.right = '10px';
            debugBtn.style.zIndex = '9999';
            debugBtn.onclick = function() {
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('collapse-state-')) {
                        localStorage.removeItem(key);
                    }
                });
                location.reload();
            };
            document.body.appendChild(debugBtn);
        }
    });

    // Game Filtering Functionality
    const filterButtons = document.querySelectorAll('.filter-btn');
    const gameCards = document.querySelectorAll('.game-score-card');
    
    function filterGames(filterType) {
        gameCards.forEach(card => {
            const gameStatus = card.getAttribute('data-game-status');
            let shouldShow = false;
            
            switch(filterType) {
                case 'all':
                    shouldShow = true;
                    break;
                case 'live':
                    shouldShow = gameStatus === 'inprogress';
                    break;
                case 'final':
                    shouldShow = gameStatus === 'finished';
                    break;
                case 'upcoming':
                    shouldShow = gameStatus === 'notstarted';
                    break;
            }
            
            if (shouldShow) {
                card.style.display = 'block';
                card.style.animation = 'fadeIn 0.3s ease-in';
            } else {
                card.style.display = 'none';
            }
        });
        
        // Hide empty time groups
        const timeGroups = document.querySelectorAll('.games-grid');
        timeGroups.forEach(group => {
            const visibleCards = group.querySelectorAll('.game-score-card[style*="display: block"], .game-score-card:not([style*="display: none"])');
            const parentContainer = group.closest('.section-container');
            
            if (visibleCards.length === 0) {
                parentContainer.style.display = 'none';
            } else {
                parentContainer.style.display = 'block';
            }
        });
    }
    
    // Add click event listeners to filter buttons
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            filterButtons.forEach(btn => btn.classList.remove('active'));
            
            // Add active class to clicked button
            this.classList.add('active');
            
            // Get filter type and apply filter
            const filterType = this.getAttribute('data-filter');
            filterGames(filterType);
            
            // Save filter preference
            localStorage.setItem('scores-filter', filterType);
        });
    });
    
    // Restore saved filter on page load
    const savedFilter = localStorage.getItem('scores-filter');
    if (savedFilter && savedFilter !== 'all') {
        const targetButton = document.querySelector(`[data-filter="${savedFilter}"]`);
        if (targetButton) {
            // Remove active from all buttons
            filterButtons.forEach(btn => btn.classList.remove('active'));
            // Add active to saved filter button
            targetButton.classList.add('active');
            // Apply the filter
            filterGames(savedFilter);
        }
    }
    
    // Add fade-in animation CSS
    const scoresPageStyle = document.createElement('style');
    scoresPageStyle.textContent = `
        /* Avatar styles for picks */
        .pick-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 3px solid #dee2e6;
            object-fit: cover;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 2px;
            display: inline-block;
        }
        
        /* Pick status border colors */
        .pick-avatar.pick-correct {
            border-color: #28a745;
            box-shadow: 0 0 6px rgba(40, 167, 69, 0.4);
        }
        
        .pick-avatar.pick-incorrect {
            border-color: #dc3545;
            box-shadow: 0 0 6px rgba(220, 53, 69, 0.4);
        }
        
        .pick-avatar.pick-pending {
            border-color: #ffc107;
            box-shadow: 0 0 6px rgba(255, 193, 7, 0.4);
        }
        
        .pick-avatar:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .pick-avatar.pick-correct:hover {
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.6);
        }
        
        .pick-avatar.pick-incorrect:hover {
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.6);
        }
        
        .pick-avatar.pick-pending:hover {
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.6);
        }
        
        .missing-pick-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 3px solid #dc3545;
            object-fit: cover;
            opacity: 0.7;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 2px;
            display: inline-block;
        }
        
        .missing-pick-avatar:hover {
            opacity: 1;
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.5);
        }
        
        /* Team picks layout adjustments */
        .team-picks-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            padding: 12px;
            min-height: 60px;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 8px;
            margin-top: 4px;
        }
        
        .team-picks-section {
            margin-bottom: 8px;
        }
        
        .team-picks-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: #ffffff;
            margin-bottom: 4px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        /* Pick player container and username styling */
        .pick-player {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            margin: 0.25rem;
            min-width: 60px;
        }
        
        .pick-username {
            font-size: 0.75rem;
            font-weight: 700;
            color: #2c3e50;
            text-align: center;
            text-transform: uppercase;
            line-height: 1.1;
            max-width: 60px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        /* Pick avatar link styling */
        .pick-avatar-link {
            display: block;
            transition: transform 0.2s ease;
            border-radius: 50%;
        }
        
        .pick-avatar-link:hover {
            transform: scale(1.1);
        }
        
        .pick-avatar-link:focus {
            outline: 2px solid var(--bs-primary);
            outline-offset: 2px;
        }
        
        .tiebreaker-mini {
            font-size: 0.7rem;
            color: #6c757d;
            margin-left: 4px;
            font-weight: 500;
        }
        
        /* Missing picks section improvements */
        .missing-picks-section {
            background: rgba(0, 0, 0, 0.02);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 0 0 12px 12px;
            padding: 12px;
            margin-top: 12px;
        }
        
        .missing-picks-header {
            color: #495057;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }
        
        .missing-picks-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }
        
        .no-picks-message {
            color: #6c757d;
            font-style: italic;
            font-size: 0.9rem;
            padding: 8px;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .filter-btn.active {
            background-color: var(--bs-primary);
            border-color: var(--bs-primary);
            color: white;
        }
        .score-updating {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .live-update-indicator {
            position: fixed;
            top: 70px;
            right: 20px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        .live-update-indicator.show {
            transform: translateX(0);
        }
    `;
    document.head.appendChild(scoresPageStyle);

    // Add immediate dark mode CSS injection
    const immediateDarkModeStyle = document.createElement('style');
    immediateDarkModeStyle.textContent = `
        /* Immediate dark mode fixes for scores page */
        [data-bs-theme="dark"] .game-score-card {
            background: linear-gradient(135deg, #404040 0%, #4a4a4a 50%, #505050 100%) !important;
            background-color: #404040 !important;
            color: #ffffff !important;
            border: 1px solid #555555 !important;
        }
        [data-bs-theme="dark"] .game-status-header {
            background: #2a2a2a !important;
            background-color: #2a2a2a !important;
            color: #ffffff !important;
            border-bottom: 1px solid #555555 !important;
        }
        [data-bs-theme="dark"] .game-info-bar {
            background: #2a2a2a !important;
            background-color: #2a2a2a !important;
            color: #ffffff !important;
        }
        [data-bs-theme="dark"] .game-info-item {
            background: #333333 !important;
            background-color: #333333 !important;
            color: #ffffff !important;
            border: 1px solid #555555 !important;
        }
        [data-bs-theme="dark"] .team-name {
            color: #ffffff !important;
        }
        
        /* Fix total-score class to have light text and strong contrast */
        [data-bs-theme="dark"] .total-score {
            color: #ffffff !important;
            text-shadow: none !important;
            opacity: 1 !important;
            font-weight: 800 !important;
        }
        
        /* Fix LIVE button background - make the container dark */
        [data-bs-theme="dark"] .game-status-display {
            background: #2a2a2a !important;
            background-color: #2a2a2a !important;
            border: 1px solid #555555 !important;
            padding: 0.5rem !important;
        }
        
        /* Force LIVE button itself to have proper styling */
        [data-bs-theme="dark"] .game-status.live {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
            color: #ffffff !important;
            border: 1px solid #1e7e34 !important;
        }
        
        /* Dark mode avatar styles */
        [data-bs-theme="dark"] .pick-avatar {
            border-color: #555555 !important;
        }
        
        [data-bs-theme="dark"] .pick-avatar.pick-correct {
            border-color: #198754 !important;
            box-shadow: 0 0 8px rgba(25, 135, 84, 0.5) !important;
        }
        
        [data-bs-theme="dark"] .pick-avatar.pick-incorrect {
            border-color: #dc3545 !important;
            box-shadow: 0 0 8px rgba(220, 53, 69, 0.5) !important;
        }
        
        [data-bs-theme="dark"] .pick-avatar.pick-pending {
            border-color: #ffc107 !important;
            box-shadow: 0 0 8px rgba(255, 193, 7, 0.5) !important;
        }
        
        [data-bs-theme="dark"] .pick-avatar.pick-correct:hover {
            box-shadow: 0 4px 16px rgba(25, 135, 84, 0.7) !important;
        }
        
        [data-bs-theme="dark"] .pick-avatar.pick-incorrect:hover {
            box-shadow: 0 4px 16px rgba(220, 53, 69, 0.7) !important;
        }
        
        [data-bs-theme="dark"] .pick-avatar.pick-pending:hover {
            box-shadow: 0 4px 16px rgba(255, 193, 7, 0.7) !important;
        }
        
        [data-bs-theme="dark"] .missing-pick-avatar {
            border-color: #dc3545 !important;
        }
        
        [data-bs-theme="dark"] .missing-pick-avatar:hover {
            box-shadow: 0 4px 16px rgba(220, 53, 69, 0.6) !important;
        }
        
        [data-bs-theme="dark"] .tiebreaker-mini {
            color: #adb5bd !important;
        }
        
        /* Dark mode team picks and missing picks */
        [data-bs-theme="dark"] .team-picks-list {
            background: rgba(255, 255, 255, 0.05) !important;
        }
        
        [data-bs-theme="dark"] .team-picks-name {
            color: #ffffff !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8) !important;
        }
        
        [data-bs-theme="dark"] .pick-username {
            color: #e9ecef !important;
        }
        
        [data-bs-theme="dark"] .missing-picks-section {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }
        
        [data-bs-theme="dark"] .missing-picks-header {
            color: #e9ecef !important;
        }
        
        [data-bs-theme="dark"] .no-picks-message {
            color: #adb5bd !important;
        }
        
        /* Mobile responsive styles for pick usernames */
        @media (max-width: 768px) {
            .pick-player {
                min-width: 50px;
                gap: 0.2rem;
                margin: 0.2rem;
            }
            
            .pick-username {
                font-size: 0.7rem;
                max-width: 50px;
            }
            
            .pick-avatar {
                width: 40px;
                height: 40px;
            }
        }
        
    `;
    document.head.appendChild(immediateDarkModeStyle);

    // Live Score Updates
    let updateInterval;
    let lastUpdateTime = Date.now();
    
    function createUpdateIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'live-update-indicator';
        indicator.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Live Updates Active';
        document.body.appendChild(indicator);
        return indicator;
    }
    
    function showUpdateIndicator(indicator, message = 'Updating scores...') {
        indicator.innerHTML = `<i class="fas fa-sync-alt me-1"></i>${message}`;
        indicator.classList.add('show');
        setTimeout(() => {
            indicator.classList.remove('show');
        }, 2000);
    }
    
    function hasLiveGames() {
        return document.querySelectorAll('[data-game-status="inprogress"]').length > 0;
    }
    
    async function updateLiveScores() {
        console.log('updateLiveScores called');
        
        if (!hasLiveGames()) {
            console.log('No live games found, stopping updates');
            return false; // No live games, stop updating
        }
        
        console.log('Live games detected, proceeding with update');
        const indicator = document.querySelector('.live-update-indicator') || createUpdateIndicator();
        
        try {
            // Add visual indication that scores are updating
            const liveCards = document.querySelectorAll('[data-game-status="inprogress"]');
            liveCards.forEach(card => card.classList.add('score-updating'));
            
            showUpdateIndicator(indicator, 'Updating live scores...');
            
            // Fetch updated page content
            const currentUrl = window.location.href;
            console.log('Fetching fresh data from:', currentUrl);
            
            // Add timestamp to prevent caching issues
            const separator = currentUrl.includes('?') ? '&' : '?';
            const fetchUrl = `${currentUrl}${separator}_t=${Date.now()}`;
            
            const response = await fetch(fetchUrl, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                },
                cache: 'no-store',
                credentials: 'same-origin'
            });
            
            console.log('Fetch response status:', response.status, response.statusText);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const html = await response.text();
            const parser = new DOMParser();
            const newDoc = parser.parseFromString(html, 'text/html');
            
            // Update game scores and status
            const currentGames = document.querySelectorAll('.game-score-card');
            const newGames = newDoc.querySelectorAll('.game-score-card');
            
            console.log(`Found ${currentGames.length} current games, ${newGames.length} new games`);
            
            let gamesUpdated = 0;
            let completedGames = 0;
            
            currentGames.forEach((currentGame, index) => {
                if (newGames[index]) {
                    const currentStatus = currentGame.getAttribute('data-game-status');
                    const newStatus = newGames[index].getAttribute('data-game-status');
                    
                    console.log(`\n--- Game ${index} (Status: ${currentStatus} → ${newStatus}) ---`);
                    
                    // Check if game status changed or scores updated
                    const currentScores = currentGame.querySelectorAll('.total-score, .quarter-score');
                    const newScores = newGames[index].querySelectorAll('.total-score, .quarter-score');
                    
                    let scoresChanged = false;
                    console.log(`Game ${index}: Comparing ${currentScores.length} current scores with ${newScores.length} new scores`);
                    
                    currentScores.forEach((score, scoreIndex) => {
                        const currentText = score.textContent.trim();
                        const newText = newScores[scoreIndex] ? newScores[scoreIndex].textContent.trim() : 'N/A';
                        
                        console.log(`  Score ${scoreIndex}: "${currentText}" vs "${newText}"`);
                        
                        if (newScores[scoreIndex] && currentText !== newText) {
                            console.log(`  ✓ Score changed: "${currentText}" → "${newText}"`);
                            scoresChanged = true;
                        }
                    });
                    
                    const statusChanged = currentStatus !== newStatus;
                    if (statusChanged) {
                        console.log(`Status changed: "${currentStatus}" → "${newStatus}"`);
                    }
                    
                    // Update if scores changed or status changed
                    if (scoresChanged || statusChanged) {
                        console.log(`  → Updating game ${index} (scores: ${scoresChanged}, status: ${statusChanged})`);
                        
                        // Update the entire game card content
                        currentGame.innerHTML = newGames[index].innerHTML;
                        currentGame.setAttribute('data-game-status', newStatus);
                        
                        // Re-apply dark mode styles after content update
                        setTimeout(() => {
                            if (typeof forceDarkModeScores === 'function') {
                                forceDarkModeScores();
                            }
                        }, 10);
                        
                        // Add update animation
                        currentGame.style.animation = 'none';
                        currentGame.offsetHeight; // Trigger reflow
                        currentGame.style.animation = 'fadeIn 0.5s ease-in';
                        
                        gamesUpdated++;
                        
                        // Check if game just completed
                        if (currentStatus === 'inprogress' && newStatus === 'finished') {
                            completedGames++;
                            // Add completion effect
                            currentGame.style.border = '2px solid #28a745';
                            setTimeout(() => {
                                currentGame.style.border = '';
                            }, 3000);
                        }
                    } else {
                        console.log(`  → No changes detected for game ${index}`);
                    }
                }
            });
            
            // Update weekly performance stats if user is authenticated
            const currentStats = document.querySelector('.weekly-performance-stats');
            const newStats = newDoc.querySelector('.weekly-performance-stats');
            if (currentStats && newStats && currentStats.innerHTML !== newStats.innerHTML) {
                currentStats.innerHTML = newStats.innerHTML;
                currentStats.style.animation = 'fadeIn 0.5s ease-in';
            }
            
            // Update week points leaderboard
            const currentLeaderboard = document.getElementById('week-points-leaderboard');
            const newLeaderboard = newDoc.getElementById('week-points-leaderboard');
            if (currentLeaderboard && newLeaderboard && currentLeaderboard.innerHTML !== newLeaderboard.innerHTML) {
                currentLeaderboard.innerHTML = newLeaderboard.innerHTML;
                currentLeaderboard.style.animation = 'fadeIn 0.5s ease-in';
                
                // Refresh the Week Points layout after updating leaderboard content
                if (typeof window.weekPointsLayoutManager !== 'undefined') {
                    setTimeout(() => {
                        try {
                            window.weekPointsLayoutManager.refresh();
                            console.log('Week Points layout refreshed successfully');
                        } catch (error) {
                            console.error('Error refreshing Week Points layout:', error);
                        }
                    }, 100); // Small delay to let animation start
                }
            }
            
            // Remove updating animation
            liveCards.forEach(card => card.classList.remove('score-updating'));
            
            // Show appropriate update message
            if (completedGames > 0) {
                showUpdateIndicator(indicator, `${completedGames} game(s) completed! Picks scored.`);
                console.log(`Live update: ${completedGames} game(s) completed`);
            } else if (gamesUpdated > 0) {
                showUpdateIndicator(indicator, `${gamesUpdated} game(s) updated`);
                console.log(`Live update: ${gamesUpdated} game(s) updated`);
            } else {
                console.log('Live update: No changes detected');
            }
            
            lastUpdateTime = Date.now();
            return hasLiveGames(); // Return true if there are still live games
            
        } catch (error) {
            console.error('Error updating live scores:', error);
            console.error('Error details:', {
                message: error.message,
                stack: error.stack,
                url: window.location.href
            });
            
            // Show specific error message
            if (error.message.includes('Failed to fetch')) {
                showUpdateIndicator(indicator, 'Network error - retrying in 30s...');
                console.log('Network error detected - this could be due to CORS, server issues, or connectivity');
            } else {
                showUpdateIndicator(indicator, 'Update failed - retrying...');
            }
            
            // Remove updating animation on error
            const liveCards = document.querySelectorAll('[data-game-status="inprogress"]');
            liveCards.forEach(card => card.classList.remove('score-updating'));
            
            return hasLiveGames();
        }
    }
    
    function startLiveUpdates() {
        if (!hasLiveGames()) {
            return;
        }
        
        const indicator = createUpdateIndicator();
        showUpdateIndicator(indicator, 'Live updates starting...');
        
        // Update every 30 seconds when games are live
        updateInterval = setInterval(async () => {
            const stillHasLiveGames = await updateLiveScores();
            
            if (!stillHasLiveGames) {
                // No more live games, stop updates
                clearInterval(updateInterval);
                const indicator = document.querySelector('.live-update-indicator');
                if (indicator) {
                    showUpdateIndicator(indicator, 'All games completed');
                    setTimeout(() => {
                        indicator.remove();
                    }, 3000);
                }
            }
        }, 30000); // Update every 30 seconds
        
        // Also update when user returns to tab (visibility change)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && hasLiveGames()) {
                // User returned to tab, update immediately if it's been more than 10 seconds
                if (Date.now() - lastUpdateTime > 10000) {
                    updateLiveScores();
                }
            }
        });
    }
    
    // Debug function for manual testing
    window.testLiveUpdate = function() {
        console.log('Manual live update test initiated');
        console.log('Live games present:', hasLiveGames());
        console.log('Live games count:', document.querySelectorAll('[data-game-status="inprogress"]').length);
        updateLiveScores();
    };
    
    // Start live updates when page loads if there are live games
    if (hasLiveGames()) {
        console.log('Live games detected on page load, starting updates in 2 seconds');
        // Initial delay to let page fully load
        setTimeout(startLiveUpdates, 2000);
    } else {
        console.log('No live games detected on page load');
    }
    
    // Restart live updates when filter changes to show live games
    const originalFilterGames = filterGames;
    filterGames = function(filterType) {
        originalFilterGames(filterType);
        
        // If user filters to show live games and there are live games, start updates
        if ((filterType === 'all' || filterType === 'live') && hasLiveGames() && !updateInterval) {
            setTimeout(startLiveUpdates, 1000);
        }
    };
    
    // Force dark mode styling - Focus on existing elements
    function forceDarkModeScores() {
        if (document.documentElement.getAttribute('data-bs-theme') === 'dark') {
            console.log('Applying dark mode fixes to scores page...');
            
            // Target Week Points leaderboard
            const pointsLeaderboard = document.querySelector('#week-points-leaderboard');
            if (pointsLeaderboard) {
                pointsLeaderboard.style.setProperty('background-color', '#404040', 'important');
                pointsLeaderboard.style.setProperty('background', '#404040', 'important');
                pointsLeaderboard.style.setProperty('color', '#ffffff', 'important');
            }
            
            // Force Week Points player cards
            const playerCards = document.querySelectorAll('.player-points-card');
            playerCards.forEach(card => {
                card.style.setProperty('background-color', '#404040', 'important');
                card.style.setProperty('background', '#404040', 'important');
                card.style.setProperty('color', '#ffffff', 'important');
                card.style.setProperty('border', '1px solid #555555', 'important');
            });
            
            // Force section containers
            const sectionContainers = document.querySelectorAll('.scores-main-container .section-container');
            sectionContainers.forEach(section => {
                section.style.setProperty('background-color', '#333333', 'important');
                section.style.setProperty('background', '#333333', 'important');
                section.style.setProperty('color', '#ffffff', 'important');
            });
            
            // 1. Fix ALL game score cards - the main issue
            const gameScoreCards = document.querySelectorAll('.game-score-card');
            console.log(`Found ${gameScoreCards.length} game score cards`);
            gameScoreCards.forEach(card => {
                card.style.setProperty('background', 'linear-gradient(135deg, #404040 0%, #4a4a4a 50%, #505050 100%)', 'important');
                card.style.setProperty('background-color', '#404040', 'important');
                card.style.setProperty('color', '#ffffff', 'important');
                card.style.setProperty('border', '1px solid #555555', 'important');
                card.style.removeProperty('background-image');
            });
            
            // 2. Fix game status headers
            const gameStatusHeaders = document.querySelectorAll('.game-status-header');
            console.log(`Found ${gameStatusHeaders.length} game status headers`);
            gameStatusHeaders.forEach(header => {
                header.style.setProperty('background', '#2a2a2a', 'important');
                header.style.setProperty('background-color', '#2a2a2a', 'important');
                header.style.setProperty('color', '#ffffff', 'important');
                header.style.setProperty('border-bottom', '1px solid #555555', 'important');
            });
            
            // 3. Fix game info bars (spread, weather, etc.)
            const gameInfoBars = document.querySelectorAll('.game-info-bar');
            console.log(`Found ${gameInfoBars.length} game info bars`);
            gameInfoBars.forEach(bar => {
                bar.style.setProperty('background', '#2a2a2a', 'important');
                bar.style.setProperty('background-color', '#2a2a2a', 'important');
                bar.style.setProperty('color', '#ffffff', 'important');
            });
            
            // 4. Fix game info items (buttons inside info bar)
            const gameInfoItems = document.querySelectorAll('.game-info-item');
            console.log(`Found ${gameInfoItems.length} game info items`);
            gameInfoItems.forEach(item => {
                item.style.setProperty('background', '#333333', 'important');
                item.style.setProperty('background-color', '#333333', 'important');
                item.style.setProperty('color', '#ffffff', 'important');
                item.style.setProperty('border', '1px solid #555555', 'important');
            });
            
            // 5. Fix team score rows
            const teamScoreRows = document.querySelectorAll('.team-score-row');
            console.log(`Found ${teamScoreRows.length} team score rows`);
            teamScoreRows.forEach(row => {
                row.style.setProperty('background', 'transparent', 'important');
                row.style.setProperty('color', '#ffffff', 'important');
            });
            
            // 6. Fix team names
            const teamNames = document.querySelectorAll('.team-name');
            console.log(`Found ${teamNames.length} team names`);
            teamNames.forEach(name => {
                name.style.setProperty('color', '#ffffff', 'important');
            });
            
            // Remove any dark mode styling from total-score elements to let them use default light mode colors
            const totalScoreElements = document.querySelectorAll('.total-score');
            totalScoreElements.forEach((score) => {
                // Remove any inline styles that might be interfering
                score.removeAttribute('style');
                
                // Remove any dark mode classes
                score.classList.remove('dark-mode-override');
            });
            
            // 7b. Fix LIVE button containers specifically
            const gameStatusDisplays = document.querySelectorAll('.game-status-display');
            console.log(`Found ${gameStatusDisplays.length} game status displays`);
            gameStatusDisplays.forEach(display => {
                display.style.setProperty('background', '#2a2a2a', 'important');
                display.style.setProperty('background-color', '#2a2a2a', 'important');
                display.style.setProperty('border', '1px solid #555555', 'important');
                display.style.setProperty('padding', '0.5rem', 'important');
            });
            
            // 8. Fix live status elements
            const liveElements = document.querySelectorAll('.game-status.live, .status-live');
            liveElements.forEach(el => {
                el.style.setProperty('background', 'linear-gradient(135deg, #28a745 0%, #20c997 100%)', 'important');
                el.style.setProperty('background-color', '#28a745', 'important');
                el.style.setProperty('color', '#ffffff', 'important');
            });
            
            // REMOVED - Let Player Picks sections use transparent background
            
            // REMOVED - Let Your Pick sections use transparent background
            
            // REMOVED - Let Missing Picks sections use transparent background
            
            
            // 11. Force any remaining white elements
            const whiteElements = document.querySelectorAll('.scores-main-container *');
            whiteElements.forEach(el => {
                const styles = window.getComputedStyle(el);
                const rect = el.getBoundingClientRect();
                
                if (styles.backgroundColor === 'rgb(255, 255, 255)' && rect.width > 10 && rect.height > 10) {
                    el.style.setProperty('background-color', '#404040', 'important');
                    el.style.setProperty('background', '#404040', 'important');
                    el.style.setProperty('color', '#ffffff', 'important');
                    el.style.removeProperty('background-image');
                    el.style.removeProperty('background-gradient');
                }
            });
            
            console.log('Dark mode fixes applied to scores page');
        }
    }
    
    // Run immediately and after any dynamic content loads
    document.addEventListener('DOMContentLoaded', forceDarkModeScores);
    setTimeout(forceDarkModeScores, 100);
    setTimeout(forceDarkModeScores, 500);
    setTimeout(forceDarkModeScores, 1000);
    
    // Override layout manager to apply dark mode after it runs
    if (window.weekPointsLayoutManager) {
        const originalApply = window.weekPointsLayoutManager.apply;
        window.weekPointsLayoutManager.apply = function() {
            originalApply.call(this);
            setTimeout(forceDarkModeScores, 50);
        };
        
        const originalRefresh = window.weekPointsLayoutManager.refresh;
        window.weekPointsLayoutManager.refresh = function() {
            originalRefresh.call(this);
            setTimeout(forceDarkModeScores, 50);
        };
    }
    
    // Run when layout manager initializes
    setTimeout(() => {
        if (window.weekPointsLayoutManager) {
            forceDarkModeScores();
        }
    }, 1500);
    
    // Handle hiding empty team pick sections with JavaScript (more reliable than CSS :has())
    function hideEmptyTeamPickSections() {
        const teamPickGroups = document.querySelectorAll('.team-picks-group');
        teamPickGroups.forEach(group => {
            const picksList = group.querySelector('.team-picks-list');
            const pickAvatars = picksList ? picksList.querySelectorAll('.pick-avatar') : [];
            
            // Hide if no pick avatars found
            if (pickAvatars.length === 0) {
                group.style.display = 'none';
            } else {
                group.style.display = 'block';
            }
        });
    }
    
    // Run after page load and after any updates
    document.addEventListener('DOMContentLoaded', hideEmptyTeamPickSections);
    setTimeout(hideEmptyTeamPickSections, 100);
    
    </script>

{% endblock %}