{% extends 'pickem/base.html' %}
{% load static %}
{% load pickem_homepage_extras %}

{% block mobile_title %}
    <div class="mobile-page-header">
        <h2 class="mobile-title-text">
            <i class="fas fa-chart-line me-2"></i>Live Scores
        </h2>
        <div class="mobile-subtitle">
            {% if competition == 'nfl-preseason' %}
                Preseason - Week {{ week }}
            {% else %}
                Regular Season - Week {{ week }}
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block content %}

<div class="container min-vh-100">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <div class="container standings-main-container">
        <div class="col">
        <!-- Page Header -->
        <div class="page-header-clean text-center d-none d-lg-block mb-4">
            <h2 class="page-title">
                <i class="fas fa-chart-line me-3"></i>Live Scores
            </h2>
            <p class="page-subtitle">
                {% if competition == 'nfl-preseason' %}
                    Preseason - Week {{ week }}
                {% else %}
                    Regular Season - Week {{ week }}
                {% endif %}
            </p>
        </div>

        <!-- Your Weekly Performance Section (Compact) -->
        {% if user.is_authenticated and user_weekly_stats %}
        <div class="section-container mb-4 weekly-performance-compact">
            <div class="weekly-performance-avatar">
                <img src="{{ user.socialaccount_set.all.0.get_avatar_url }}" 
                     alt="Your profile picture" 
                     class="player-avatar">
            </div>
            <div class="weekly-performance-stats">
                <div class="stat-item">
                    <span class="stat-label">Picks Accuracy:</span>
                    <span class="stat-value">{{ user_weekly_stats.accuracy }}% <small>({{ user_weekly_stats.correct_picks }}/{{ user_weekly_stats.total_graded_picks }} Graded)</small></span>
                    <br />
                    <span class="stat-label">Correct Picks:</span>
                    <span class="stat-value">{{ user_weekly_stats.correct_picks }}</span>
                    <br />
                    <span class="stat-label">Week {{ week }} Points:</span>
                    <span class="stat-value">{{ user_weekly_stats.weekly_points }}</span>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="section-container mb-4">
            <div class="filter-controls d-flex flex-wrap gap-2 justify-content-center">
                <button class="btn btn-outline-primary btn-sm filter-btn active" data-filter="all">
                    <i class="fas fa-list me-1"></i>All Games
                </button>
                <button class="btn btn-outline-success btn-sm filter-btn" data-filter="live">
                    <i class="fas fa-circle me-1 pulse-icon"></i>Live
                </button>
                <button class="btn btn-outline-danger btn-sm filter-btn" data-filter="final">
                    <i class="fas fa-flag-checkered me-1"></i>Final
                </button>
                <button class="btn btn-outline-info btn-sm filter-btn" data-filter="upcoming">
                    <i class="fas fa-clock me-1"></i>Upcoming
                </button>
            </div>
        </div>

        

        <!-- Week Stats Sidebar - Moved Above Games -->
        {% if show_week_stats_sidebar %}
        
        <!-- Week Winner Card - Full Width on Top -->
        {% for player in week_winner %}
        {% if player.id != None %}
        <div class="row mt-2 mb-3">
            <div class="col-12">
                <div class="section-container mb-4">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i class="fas fa-trophy me-2"></i>Week Winner
                        </h3>
                    </div>
                    <div class="winner-showcase">
                        {% with player.userID|lookupname as username %}
                        {% with player.userID|lookupavatar as avatar %}
                        <div class="winner-profile">
                            <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}" 
                                 alt="Profile picture for {{ username }}" 
                                 class="winner-avatar">
                            <div class="winner-details">
                                <h4 class="winner-name">{{ username|default:"Unknown Player" }}</h4>
                                <div class="winner-badge">
                                    <i class="fas fa-crown me-1"></i>Champion
                                </div>
                            </div>
                        </div>
                        {% endwith %}
                        {% endwith %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
        
        <!-- Week Points Leaderboard - Two Columns on Large Screens -->
        <div class="row mt-2 mb-3">
            <div class="col-12">
                <div class="section-container">
                    <div class="section-header collapsible-header" data-bs-toggle="collapse" data-bs-target="#week-points-leaderboard" aria-expanded="true">
                        <div class="section-header-content">
                            <h3 class="section-title">
                                <i class="fas fa-list-ol me-2"></i>Week Points
                            </h3>
                        </div>
                        <div class="collapse-indicator">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                    <div class="points-leaderboard points-leaderboard-multi-column collapse show" id="week-points-leaderboard">
                        {% for player in user_points %}
                        <div class="player-points-card">
                            {% with player.uid|lookupname as username %}
                            {% with player.uid|lookupavatar as avatar %}
                            <div class="player-info">
                                <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}" 
                                     alt="Profile picture for {{ username }}" 
                                     class="player-mini-avatar">
                                <div class="player-details">
                                    <div class="player-name">{{ username|default:"Unknown Player" }}</div>
                                </div>
                            </div>
                            <div class="player-score">
                                <span class="score-value">{{ player.wins }}</span>
                                <span class="score-label">pts</span>
                            </div>
                            {% endwith %}
                            {% endwith %}
                        </div>
                        {% endfor %}

                        {% for player in players_names %}
                        {% if player not in users_w_points %}
                        <div class="player-points-card">
                            {% with player|lookupname as username %}
                            {% with player|lookupavatar as avatar %}
                            <div class="player-info">
                                <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}" 
                                     alt="Profile picture for {{ username }}" 
                                     class="player-mini-avatar">
                                <div class="player-details">
                                    <div class="player-name">{{ username|default:"Unknown Player" }}</div>
                                </div>
                            </div>
                            <div class="player-score">
                                <span class="score-value">0</span>
                                <span class="score-label">pts</span>
                            </div>
                            {% endwith %}
                            {% endwith %}
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    <script>
                        // Week Points Leaderboard Layout Manager
                        window.weekPointsLayoutManager = (function() {
                            const CONTAINER_ID = 'week-points-leaderboard';
                            let originalCards = [];
                            
                            function captureOriginalCards() {
                                const container = document.getElementById(CONTAINER_ID);
                                if (!container) return;
                                
                                // Capture cards if we haven't already or if container was reset
                                if (originalCards.length === 0 || !container.querySelector('.points-column')) {
                                    originalCards = Array.from(container.querySelectorAll('.player-points-card')).map(card => card.cloneNode(true));
                                }
                            }
                            
                            function applyColumnLayout() {
                                const container = document.getElementById(CONTAINER_ID);
                                if (!container) return;
                                
                                captureOriginalCards();
                                const totalCards = originalCards.length;
                                
                                if (window.innerWidth >= 992 && totalCards > 0) {
                                    // Only rebuild if not already in column layout
                                    if (!container.querySelector('.points-column')) {
                                        // Clear container
                                        container.innerHTML = '';
                                        
                                        // Create two columns
                                        const leftColumn = document.createElement('div');
                                        leftColumn.className = 'points-column points-column-left';
                                        const rightColumn = document.createElement('div');
                                        rightColumn.className = 'points-column points-column-right';
                                        
                                        // Calculate split point (first half goes to left, second half to right)
                                        const halfPoint = Math.ceil(totalCards / 2);
                                        
                                        // Distribute cards
                                        for (let i = 0; i < totalCards; i++) {
                                            if (i < halfPoint) {
                                                leftColumn.appendChild(originalCards[i].cloneNode(true));
                                            } else {
                                                rightColumn.appendChild(originalCards[i].cloneNode(true));
                                            }
                                        }
                                        
                                        container.appendChild(leftColumn);
                                        container.appendChild(rightColumn);
                                    }
                                } else {
                                    // Mobile: restore original single-column layout
                                    if (container.querySelector('.points-column')) {
                                        container.innerHTML = '';
                                        originalCards.forEach(card => {
                                            container.appendChild(card.cloneNode(true));
                                        });
                                    }
                                }
                            }
                            
                            function refreshLayout() {
                                // Reset to allow recapture of cards
                                originalCards = [];
                                applyColumnLayout();
                            }
                            
                            // Public interface
                            return {
                                init: function() {
                                    applyColumnLayout();
                                    window.addEventListener('resize', applyColumnLayout);
                                },
                                refresh: refreshLayout,
                                apply: applyColumnLayout
                            };
                        })();
                        
                        // Initialize on page load
                        weekPointsLayoutManager.init();
                    </script>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Games by Start Time - Full Width -->
        {% if game_list %}
            {% regroup game_list by startTimestamp as games_by_time %}
            {% for time_group in games_by_time %}
            <div class="time-group-full-width">
                <div class="section-header collapsible-header" data-bs-toggle="collapse" data-bs-target="#games-{{ time_group.grouper|date:'Y-m-d-Hi' }}" aria-expanded="true">
                    <div class="section-header-content">
                        <h3 class="section-title">
                            <i class="fas fa-calendar me-2"></i>{{ time_group.grouper|date:"l, F j" }}
                            <span class="game-time-display">{{ time_group.grouper|date:"g:i A" }}</span>
                        </h3>
                    </div>
                    <div class="collapse-indicator">
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>

                <div class="games-grid collapse show" id="games-{{ time_group.grouper|date:'Y-m-d-Hi' }}">
                            {% for game in time_group.list %}
                            <div class="game-score-card" data-game-status="{{ game.statusType|lower }}">
                                <!-- Game Status Header -->
                                <div class="game-status-header {% if game.statusType == 'inprogress' %}status-live{% else %}status-standard{% endif %}">
                                    <div class="status-info">
                                        <i class="fas {% if game.statusType == 'inprogress' %}fa-circle status-live-dot{% elif game.statusType == 'finished' %}fa-check-circle{% else %}fa-clock{% endif %} me-2"></i>
                                        {{ game.statusTitle }}
                                    </div>
                                    <div class="game-time">
                                        {{ game.startTimestamp|date:"g:i A" }}
                                    </div>
                                </div>

                                <!-- Game Info (Spread, Weather, etc.) -->
                                {% if game.spread or game.overUnder or game.temperature or game.weatherCondition %}
                                <div class="game-info-bar">
                                    {% if game.spread %}
                                    <div class="game-info-item spread-item">
                                        <i class="fas fa-chart-line me-1"></i>
                                        <span class="info-label">Spread:</span>
                                        <span class="info-value spread-value">
                                            {% if game.spread > 0 %}
                                                {% with game.homeTeamSlug|lookuplogo as logo_url %}
                                                <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}" alt="{{ game.homeTeamName }} logo" class="spread-team-logo">
                                                {% endwith %}
                                                -{{ game.spread|floatformat:1 }}
                                            {% else %}
                                                {% with game.awayTeamSlug|lookuplogo as logo_url %}
                                                <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}" alt="{{ game.awayTeamName }} logo" class="spread-team-logo">
                                                {% endwith %}
                                                -{{ game.spread|floatformat:1|cut:"-" }}
                                            {% endif %}
                                        </span>
                                    </div>
                                    {% endif %}
                                    {% if game.overUnder %}
                                    <div class="game-info-item">
                                        <i class="fas fa-calculator me-1"></i>
                                        <span class="info-label">O/U:</span>
                                        <span class="info-value">{{ game.overUnder|floatformat:1 }}</span>
                                    </div>
                                    {% endif %}
                                    {% if game.temperature and game.weatherCondition %}
                                    <div class="game-info-item">
                                        {% if 'Sun' in game.weatherCondition or 'Clear' in game.weatherCondition %}
                                            <i class="fas fa-sun me-1" title="Sunny/Clear"></i>
                                        {% elif 'Cloud' in game.weatherCondition %}
                                            <i class="fas fa-cloud me-1" title="Cloudy"></i>
                                        {% elif 'Rain' in game.weatherCondition or 'Shower' in game.weatherCondition %}
                                            <i class="fas fa-cloud-rain me-1" title="Rainy"></i>
                                        {% elif 'Snow' in game.weatherCondition %}
                                            <i class="fas fa-snowflake me-1" title="Snowy"></i>
                                        {% elif 'Storm' in game.weatherCondition or 'Thunder' in game.weatherCondition %}
                                            <i class="fas fa-bolt me-1" title="Stormy"></i>
                                        {% elif 'Wind' in game.weatherCondition %}
                                            <i class="fas fa-wind me-1" title="Windy"></i>
                                        {% elif 'Fog' in game.weatherCondition %}
                                            <i class="fas fa-smog me-1" title="Foggy"></i>
                                        {% else %}
                                            <i class="fas fa-thermometer-half me-1" title="Weather"></i>
                                        {% endif %}
                                        <span class="info-value">{{ game.temperature }}°F, {{ game.weatherCondition }}</span>
                                    </div>
                                    {% endif %}
                                    {% if game.venueIndoor %}
                                    <div class="game-info-item">
                                        <i class="fas fa-home me-1"></i>
                                        <span class="info-value">Indoor</span>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}

                                <!-- Teams and Scores -->
                                <div class="teams-matchup">
                                    <!-- Away Team -->
                                    <div class="team-score-row {% if game.statusType == 'finished' and game.gameWinner == game.awayTeamSlug %}winning-team{% endif %}">
                                        <div class="team-info">
                                            {% with game.awayTeamSlug|lookuplogo as logo_url %}
                                            <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}" 
                                                 alt="{{ game.awayTeamName }} logo" 
                                                 class="team-logo">
                                            {% endwith %}
                                            <div class="team-details">
                                                <div class="team-name {% if game.statusType == 'finished' and game.gameWinner != game.awayTeamSlug %}text-muted{% endif %}">
                                                    {{ game.awayTeamName }}
                                                    {% if game.statusType == 'finished' and game.gameWinner == game.awayTeamSlug %}
                                                        <i class="fas fa-chevron-right ms-1 winner-indicator"></i>
                                                    {% endif %}
                                                </div>
                                                <div class="team-details">
                                                    <div class="team-record">
                                                        {% for team in wins_losses %}
                                                            {% if team.teamNameSlug == game.awayTeamSlug %}
                                                                {% if team.teamTies > 0 %}
                                                                    ({{ team.teamWins }}-{{ team.teamLosses }}-{{ team.teamTies }})
                                                                {% else %}
                                                                    ({{ team.teamWins }}-{{ team.teamLosses }})
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                    {% if game.awayTeamWinProbability %}
                                                    <div class="performance-item">
                                                        <span class="performance-label">Win Chance</span>
                                                        <div class="progress-container">
                                                            <div class="progress-bar">
                                                                <div class="progress-fill" style="width: {{ game.awayTeamWinProbability|floatformat:0 }}%"></div>
                                                            </div>
                                                            <span class="progress-text">{{ game.awayTeamWinProbability|floatformat:0 }}%</span>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {% if game.statusType != 'notstarted' %}
                                        <div class="score-breakdown">
                                            <div class="quarters">
                                                <span class="quarter-score">{{ game.awayTeamPeriod1|default:"—" }}</span>
                                                <span class="quarter-score">{{ game.awayTeamPeriod2|default:"—" }}</span>
                                                <span class="quarter-score">{{ game.awayTeamPeriod3|default:"—" }}</span>
                                                <span class="quarter-score">{{ game.awayTeamPeriod4|default:"—" }}</span>
                                            </div>
                                            <div class="total-score">{{ game.awayTeamScore|default:"0" }}</div>
                                        </div>
                                        {% endif %}
                                    </div>

                                    <!-- Home Team -->
                                    <div class="team-score-row {% if game.statusType == 'finished' and game.gameWinner == game.homeTeamSlug %}winning-team{% endif %}">
                                        <div class="team-info">
                                            {% with game.homeTeamSlug|lookuplogo as logo_url %}
                                            <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}" 
                                                 alt="{{ game.homeTeamName }} logo" 
                                                 class="team-logo">
                                            {% endwith %}
                                            <div class="team-details">
                                                <div class="team-name {% if game.statusType == 'finished' and game.gameWinner != game.homeTeamSlug %}text-muted{% endif %}">
                                                    {{ game.homeTeamName }}
                                                    {% if game.statusType == 'finished' and game.gameWinner == game.homeTeamSlug %}
                                                        <i class="fas fa-chevron-right ms-1 winner-indicator"></i>
                                                    {% endif %}
                                                </div>
                                                <div class="team-details">
                                                    <div class="team-record">
                                                        {% for team in wins_losses %}
                                                            {% if team.teamNameSlug == game.homeTeamSlug %}
                                                                {% if team.teamTies > 0 %}
                                                                    ({{ team.teamWins }}-{{ team.teamLosses }}-{{ team.teamTies }})
                                                                {% else %}
                                                                    ({{ team.teamWins }}-{{ team.teamLosses }})
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                    {% if game.homeTeamWinProbability %}
                                                    <div class="performance-item">
                                                        <span class="performance-label">Win Chance</span>
                                                        <div class="progress-container">
                                                            <div class="progress-bar">
                                                                <div class="progress-fill" style="width: {{ game.homeTeamWinProbability|floatformat:0 }}%"></div>
                                                            </div>
                                                            <span class="progress-text">{{ game.homeTeamWinProbability|floatformat:0 }}%</span>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {% if game.statusType != 'notstarted' %}
                                        <div class="score-breakdown">
                                            <div class="quarters">
                                                <span class="quarter-score">{{ game.homeTeamPeriod1|default:"—" }}</span>
                                                <span class="quarter-score">{{ game.homeTeamPeriod2|default:"—" }}</span>
                                                <span class="quarter-score">{{ game.homeTeamPeriod3|default:"—" }}</span>
                                                <span class="quarter-score">{{ game.homeTeamPeriod4|default:"—" }}</span>
                                            </div>
                                            <div class="total-score">{{ game.homeTeamScore|default:"0" }}</div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Game Status Badge (Centered between teams) -->
                                {% if game.statusType != 'notstarted' %}
                                <div class="game-status-display">
                                    {% if game.statusType|lower == 'inprogress' %}
                                        <span class="game-status live">LIVE</span>
                                    {% elif game.statusType|lower == 'finished' %}
                                        <span class="game-status final">FINAL</span>
                                    {% elif game.statusType|lower == 'notstarted' %}
                                        <span class="game-status upcoming">UPCOMING</span>
                                    {% endif %}
                                </div>
                                {% endif %}

                                <!-- Player Picks Section -->
                                {% if picks and game.statusType != 'notstarted' %}
                                <div class="picks-section">
                                    <div class="picks-header">
                                        <i class="fas fa-users me-2"></i>Player Picks
                                    </div>
                                    
                                    <!-- Away Team Picks -->
                                    <div class="team-picks-group away-team-picks" data-team="{{ game.awayTeamSlug }}">
                                        <div class="team-picks-header">
                                            {% with game.awayTeamSlug|lookuplogo as logo_url %}
                                            <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}" 
                                                 alt="{{ game.awayTeamName }} logo" 
                                                 class="team-picks-logo">
                                            {% endwith %}
                                            <span class="team-picks-name">{{ game.awayTeamName }}</span>
                                        </div>
                                        <div class="team-picks-list">
                                            {% for pick in picks %}
                                                {% if pick.pick == game.awayTeamSlug %}
                                                    {% if game.statusType == 'finished' %}
                                                        {% if game.gameWinner == pick.pick %}
                                                            <span class="player-pick-badge pick-win">
                                                        {% else %}
                                                            <span class="player-pick-badge pick-loss">
                                                        {% endif %}
                                                    {% elif game.statusType == 'inprogress' %}
                                                        <span class="player-pick-badge pick-pending">
                                                    {% endif %}
                                                        {% with pick.uid|lookupname as username %}
                                                        {{ username|default:"Unknown" }}
                                                        {% endwith %}
                                                        {% if pick.tieBreakerScore != None %}
                                                        <small class="tiebreaker-mini">({{ pick.tieBreakerScore }}/{{ pick.tieBreakerYards }})</small>
                                                        {% endif %}
                                                    </span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>

                                    <!-- Home Team Picks -->
                                    <div class="team-picks-group home-team-picks" data-team="{{ game.homeTeamSlug }}">
                                        <div class="team-picks-header">
                                            {% with game.homeTeamSlug|lookuplogo as logo_url %}
                                            <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}" 
                                                 alt="{{ game.homeTeamName }} logo" 
                                                 class="team-picks-logo">
                                            {% endwith %}
                                            <span class="team-picks-name">{{ game.homeTeamName }}</span>
                                        </div>
                                        <div class="team-picks-list">
                                            {% for pick in picks %}
                                                {% if pick.pick == game.homeTeamSlug %}
                                                    {% if game.statusType == 'finished' %}
                                                        {% if game.gameWinner == pick.pick %}
                                                            <span class="player-pick-badge pick-win">
                                                        {% else %}
                                                            <span class="player-pick-badge pick-loss">
                                                        {% endif %}
                                                    {% elif game.statusType == 'inprogress' %}
                                                        <span class="player-pick-badge pick-pending">
                                                    {% endif %}
                                                        {% with pick.uid|lookupname as username %}
                                                        {{ username|default:"Unknown" }}
                                                        {% endwith %}
                                                        {% if pick.tieBreakerScore != None %}
                                                        <small class="tiebreaker-mini">({{ pick.tieBreakerScore }}/{{ pick.tieBreakerYards }})</small>
                                                        {% endif %}
                                                    </span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- User's Pick Highlight -->
                                {% if picks %}
                                {% for pick in picks %}
                                {% if pick.userEmail == user.email and pick.pick == game.homeTeamSlug or pick.userEmail == user.email and pick.pick == game.awayTeamSlug %}
                                <div class="user-pick-section">
                                    <div class="user-pick-header">
                                        <i class="fas fa-star me-2"></i>Your Pick
                                    </div>
                                    <div class="user-pick-display">
                                        {% if pick.pick == game.homeTeamSlug %}
                                            {% with game.homeTeamSlug|lookuplogo as logo_url %}
                                            <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}" 
                                                 alt="{{ game.homeTeamName }} logo" 
                                                 class="user-pick-logo">
                                            {% endwith %}
                                            <span class="user-pick-team">{{ game.homeTeamName }}</span>
                                        {% else %}
                                            {% with game.awayTeamSlug|lookuplogo as logo_url %}
                                            <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}" 
                                                 alt="{{ game.awayTeamName }} logo" 
                                                 class="user-pick-logo">
                                            {% endwith %}
                                            <span class="user-pick-team">{{ game.awayTeamName }}</span>
                                        {% endif %}
                                        
                                        {% if game.statusType == 'finished' %}
                                            {% if game.gameWinner == pick.pick %}
                                                <span class="pick-result pick-correct">
                                                    <i class="fas fa-check-circle me-1"></i>Correct
                                                </span>
                                            {% else %}
                                                <span class="pick-result pick-incorrect">
                                                    <i class="fas fa-times-circle me-1"></i>Incorrect
                                                </span>
                                            {% endif %}
                                        {% endif %}
                                        
                                        {% if pick.tieBreakerScore != None %}
                                        <div class="tiebreaker-display">
                                            <small>Tiebreaker: {{ pick.tieBreakerScore }} pts, {{ pick.tieBreakerYards }} yds</small>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                                {% endif %}

                                <!-- Missing Picks Alert -->
                                {% if game.statusType == 'notstarted' and current_week == True %}
                                <div class="missing-picks-section" style="display: none;" id="missing-picks-{{ game.id }}">
                                    <div class="missing-picks-header">
                                        <i class="fas fa-exclamation-triangle me-2"></i>Missing Picks
                                    </div>
                                    <div class="missing-picks-list">
                                        {% for player in players_ids %}
                                            {% with player|addstr:"-"|addstr:game.id as gameid %}
                                                {% with gameid|lookuppick as count %}
                                                    {% if count == 0 %}
                                                        {% with player|lookupname as username %}
                                                            <span class="missing-pick-badge">{{ username|default:"Unknown" }}</span>
                                                        {% endwith %}
                                                    {% endif %}
                                                {% endwith %}
                                            {% endwith %}
                                        {% endfor %}
                                    </div>
                                </div>
                                <script>
                                    // Show missing picks section only if there are missing pick badges
                                    (function() {
                                        var section = document.getElementById('missing-picks-{{ game.id }}');
                                        var badges = section.querySelectorAll('.missing-pick-badge');
                                        if (badges.length > 0) {
                                            section.style.display = 'block';
                                        }
                                    })();
                                </script>
                                {% endif %}
                                                         </div>
                             {% endfor %}
                         </div>
                     </div>
                     {% endfor %}
                {% else %}
                <div class="section-container">
                    <div class="no-games-message text-center">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        {% if is_default_week %}
                        <h4 class="text-muted">Week {{ week }} Games Coming Soon</h4>
                        <p class="text-muted">NFL Week {{ week }} games will appear here once the schedule is released. Get ready for the season by submitting your picks!</p>
                        <div class="mt-3">
                            <a href="{% url 'game_picks' %}" class="btn btn-primary">
                                <i class="fas fa-edit me-2"></i>Submit Week {{ week }} Picks
                            </a>
                        </div>
                        {% else %}
                        <h4 class="text-muted">No games scheduled</h4>
                        <p class="text-muted">Check back later or view other weeks.</p>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

        <!-- Week Stats Sidebar - Below Games -->
        {% if show_week_stats_sidebar %}
        <div class="row mt-4 d-none">
            <div class="col-lg-6 mb-4">
                <!-- Week Winner Card -->
                {% for player in week_winner %}
                {% if player.id != None %}
                <div class="section-container mb-4">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i class="fas fa-trophy me-2"></i>Week Winner
                        </h3>
                    </div>
                    <div class="winner-showcase">
                        {% with player.userID|lookupname as username %}
                        {% with player.userID|lookupavatar as avatar %}
                        <div class="winner-profile">
                            <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}" 
                                 alt="Profile picture for {{ username }}" 
                                 class="winner-avatar">
                            <div class="winner-details">
                                <h4 class="winner-name">{{ username|default:"Unknown Player" }}</h4>
                                <div class="winner-badge">
                                    <i class="fas fa-crown me-1"></i>Champion
                                </div>
                            </div>
                        </div>
                        {% endwith %}
                        {% endwith %}
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            
            <div class="col-lg-6 mb-4">
                <!-- Week Points Leaderboard -->
                <div class="section-container">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i class="fas fa-list-ol me-2"></i>Week Points
                        </h3>
                    </div>
                    <div class="points-leaderboard">
                        {% for player in user_points %}
                        <div class="player-points-card">
                            {% with player.uid|lookupname as username %}
                            {% with player.uid|lookupavatar as avatar %}
                            <div class="player-info">
                                <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}" 
                                     alt="Profile picture for {{ username }}" 
                                     class="player-mini-avatar">
                                <div class="player-details">
                                    <div class="player-name">{{ username|default:"Unknown Player" }}</div>
                                </div>
                            </div>
                            <div class="player-score">
                                <span class="score-value">{{ player.wins }}</span>
                                <span class="score-label">pts</span>
                            </div>
                            {% endwith %}
                            {% endwith %}
                        </div>
                        {% endfor %}

                        {% for player in players_names %}
                        {% if player not in users_w_points %}
                        <div class="player-points-card">
                            {% with player|lookupname as username %}
                            {% with player|lookupavatar as avatar %}
                            <div class="player-info">
                                <img src="{{ avatar|default:'https://www.wmata.com/systemimages/icons/menu-car-icon.png' }}" 
                                     alt="Profile picture for {{ username }}" 
                                     class="player-mini-avatar">
                                <div class="player-details">
                                    <div class="player-name">{{ username|default:"Unknown Player" }}</div>
                                </div>
                            </div>
                            <div class="player-score">
                                <span class="score-value">0</span>
                                <span class="score-label">pts</span>
                            </div>
                            {% endwith %}
                            {% endwith %}
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Collapsible Enhancement Script -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const collapsibleHeaders = document.querySelectorAll('.collapsible-header');
        
        // Restore saved states from localStorage on page load
        function restoreCollapseStates() {
            collapsibleHeaders.forEach(header => {
                const target = header.getAttribute('data-bs-target');
                const targetElement = document.querySelector(target);
                const savedState = localStorage.getItem('collapse-state-' + target);
                
                console.log('Restoring state for', target, ':', savedState); // Debug log
                
                if (savedState === 'collapsed' && targetElement) {
                    // Remove the 'show' class to collapse it
                    targetElement.classList.remove('show');
                    header.setAttribute('aria-expanded', 'false');
                } else if (savedState === 'expanded' && targetElement) {
                    // Ensure it's expanded
                    targetElement.classList.add('show');
                    header.setAttribute('aria-expanded', 'true');
                }
            });
        }
        
        // Save state when toggled
        function saveCollapseState(target, isExpanded) {
            const state = isExpanded ? 'expanded' : 'collapsed';
            localStorage.setItem('collapse-state-' + target, state);
            console.log('Saved state for', target, ':', state); // Debug log
        }
        
        // Set up event listeners for state saving
        collapsibleHeaders.forEach(header => {
            const target = header.getAttribute('data-bs-target');
            const targetElement = document.querySelector(target);
            
            // Listen for Bootstrap collapse events
            targetElement.addEventListener('shown.bs.collapse', function() {
                saveCollapseState(target, true);
                header.setAttribute('aria-expanded', 'true');
            });
            
            targetElement.addEventListener('hidden.bs.collapse', function() {
                saveCollapseState(target, false);
                header.setAttribute('aria-expanded', 'false');
            });
            
            // Add smooth scroll when expanding sections
            targetElement.addEventListener('shown.bs.collapse', function() {
                setTimeout(() => {
                    header.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 100);
            });
        });
        
        // Add keyboard support
        collapsibleHeaders.forEach(header => {
            header.setAttribute('tabindex', '0');
            header.setAttribute('role', 'button');
            
            header.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
        });
        
        // Restore states after a small delay to ensure Bootstrap is ready
        setTimeout(restoreCollapseStates, 100);
        
        // Debug: Add button to clear all saved states (remove this if not needed)
        if (localStorage.getItem('scores-debug-mode')) {
            const debugBtn = document.createElement('button');
            debugBtn.textContent = 'Clear Collapse States';
            debugBtn.style.position = 'fixed';
            debugBtn.style.top = '10px';
            debugBtn.style.right = '10px';
            debugBtn.style.zIndex = '9999';
            debugBtn.onclick = function() {
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('collapse-state-')) {
                        localStorage.removeItem(key);
                    }
                });
                location.reload();
            };
            document.body.appendChild(debugBtn);
        }
    });

    // Game Filtering Functionality
    const filterButtons = document.querySelectorAll('.filter-btn');
    const gameCards = document.querySelectorAll('.game-score-card');
    
    function filterGames(filterType) {
        gameCards.forEach(card => {
            const gameStatus = card.getAttribute('data-game-status');
            let shouldShow = false;
            
            switch(filterType) {
                case 'all':
                    shouldShow = true;
                    break;
                case 'live':
                    shouldShow = gameStatus === 'inprogress';
                    break;
                case 'final':
                    shouldShow = gameStatus === 'finished';
                    break;
                case 'upcoming':
                    shouldShow = gameStatus === 'notstarted';
                    break;
            }
            
            if (shouldShow) {
                card.style.display = 'block';
                card.style.animation = 'fadeIn 0.3s ease-in';
            } else {
                card.style.display = 'none';
            }
        });
        
        // Hide empty time groups
        const timeGroups = document.querySelectorAll('.games-grid');
        timeGroups.forEach(group => {
            const visibleCards = group.querySelectorAll('.game-score-card[style*="display: block"], .game-score-card:not([style*="display: none"])');
            const parentContainer = group.closest('.section-container');
            
            if (visibleCards.length === 0) {
                parentContainer.style.display = 'none';
            } else {
                parentContainer.style.display = 'block';
            }
        });
    }
    
    // Add click event listeners to filter buttons
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            filterButtons.forEach(btn => btn.classList.remove('active'));
            
            // Add active class to clicked button
            this.classList.add('active');
            
            // Get filter type and apply filter
            const filterType = this.getAttribute('data-filter');
            filterGames(filterType);
            
            // Save filter preference
            localStorage.setItem('scores-filter', filterType);
        });
    });
    
    // Restore saved filter on page load
    const savedFilter = localStorage.getItem('scores-filter');
    if (savedFilter && savedFilter !== 'all') {
        const targetButton = document.querySelector(`[data-filter="${savedFilter}"]`);
        if (targetButton) {
            // Remove active from all buttons
            filterButtons.forEach(btn => btn.classList.remove('active'));
            // Add active to saved filter button
            targetButton.classList.add('active');
            // Apply the filter
            filterGames(savedFilter);
        }
    }
    
    // Add fade-in animation CSS
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .filter-btn.active {
            background-color: var(--bs-primary);
            border-color: var(--bs-primary);
            color: white;
        }
        .score-updating {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .live-update-indicator {
            position: fixed;
            top: 70px;
            right: 20px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        .live-update-indicator.show {
            transform: translateX(0);
        }
    `;
    document.head.appendChild(style);

    // Live Score Updates
    let updateInterval;
    let lastUpdateTime = Date.now();
    
    function createUpdateIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'live-update-indicator';
        indicator.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Live Updates Active';
        document.body.appendChild(indicator);
        return indicator;
    }
    
    function showUpdateIndicator(indicator, message = 'Updating scores...') {
        indicator.innerHTML = `<i class="fas fa-sync-alt me-1"></i>${message}`;
        indicator.classList.add('show');
        setTimeout(() => {
            indicator.classList.remove('show');
        }, 2000);
    }
    
    function hasLiveGames() {
        return document.querySelectorAll('[data-game-status="inprogress"]').length > 0;
    }
    
    async function updateLiveScores() {
        if (!hasLiveGames()) {
            return false; // No live games, stop updating
        }
        
        const indicator = document.querySelector('.live-update-indicator') || createUpdateIndicator();
        
        try {
            // Add visual indication that scores are updating
            const liveCards = document.querySelectorAll('[data-game-status="inprogress"]');
            liveCards.forEach(card => card.classList.add('score-updating'));
            
            showUpdateIndicator(indicator, 'Updating live scores...');
            
            // Fetch updated page content
            const response = await fetch(window.location.href, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Cache-Control': 'no-cache'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const html = await response.text();
            const parser = new DOMParser();
            const newDoc = parser.parseFromString(html, 'text/html');
            
            // Update game scores and status
            const currentGames = document.querySelectorAll('.game-score-card');
            const newGames = newDoc.querySelectorAll('.game-score-card');
            
            let gamesUpdated = 0;
            let completedGames = 0;
            
            currentGames.forEach((currentGame, index) => {
                if (newGames[index]) {
                    const currentStatus = currentGame.getAttribute('data-game-status');
                    const newStatus = newGames[index].getAttribute('data-game-status');
                    
                    // Check if game status changed or scores updated
                    const currentScores = currentGame.querySelectorAll('.total-score, .quarter-score');
                    const newScores = newGames[index].querySelectorAll('.total-score, .quarter-score');
                    
                    let scoresChanged = false;
                    currentScores.forEach((score, scoreIndex) => {
                        if (newScores[scoreIndex] && score.textContent !== newScores[scoreIndex].textContent) {
                            scoresChanged = true;
                        }
                    });
                    
                    // Update if scores changed or status changed
                    if (scoresChanged || currentStatus !== newStatus) {
                        // Update the entire game card content
                        currentGame.innerHTML = newGames[index].innerHTML;
                        currentGame.setAttribute('data-game-status', newStatus);
                        
                        // Add update animation
                        currentGame.style.animation = 'none';
                        currentGame.offsetHeight; // Trigger reflow
                        currentGame.style.animation = 'fadeIn 0.5s ease-in';
                        
                        gamesUpdated++;
                        
                        // Check if game just completed
                        if (currentStatus === 'inprogress' && newStatus === 'finished') {
                            completedGames++;
                            // Add completion effect
                            currentGame.style.border = '2px solid #28a745';
                            setTimeout(() => {
                                currentGame.style.border = '';
                            }, 3000);
                        }
                    }
                }
            });
            
            // Update weekly performance stats if user is authenticated
            const currentStats = document.querySelector('.weekly-performance-stats');
            const newStats = newDoc.querySelector('.weekly-performance-stats');
            if (currentStats && newStats && currentStats.innerHTML !== newStats.innerHTML) {
                currentStats.innerHTML = newStats.innerHTML;
                currentStats.style.animation = 'fadeIn 0.5s ease-in';
            }
            
            // Update week points leaderboard
            const currentLeaderboard = document.querySelector('.points-leaderboard');
            const newLeaderboard = newDoc.querySelector('.points-leaderboard');
            if (currentLeaderboard && newLeaderboard && currentLeaderboard.innerHTML !== newLeaderboard.innerHTML) {
                currentLeaderboard.innerHTML = newLeaderboard.innerHTML;
                currentLeaderboard.style.animation = 'fadeIn 0.5s ease-in';
                
                // Refresh the Week Points layout after updating leaderboard content
                if (typeof window.weekPointsLayoutManager !== 'undefined') {
                    setTimeout(() => {
                        window.weekPointsLayoutManager.refresh();
                    }, 100); // Small delay to let animation start
                }
            }
            
            // Remove updating animation
            liveCards.forEach(card => card.classList.remove('score-updating'));
            
            // Show appropriate update message
            if (completedGames > 0) {
                showUpdateIndicator(indicator, `${completedGames} game(s) completed! Picks scored.`);
            } else if (gamesUpdated > 0) {
                showUpdateIndicator(indicator, `${gamesUpdated} game(s) updated`);
            }
            
            lastUpdateTime = Date.now();
            return hasLiveGames(); // Return true if there are still live games
            
        } catch (error) {
            console.error('Error updating live scores:', error);
            showUpdateIndicator(indicator, 'Update failed - retrying...');
            
            // Remove updating animation on error
            const liveCards = document.querySelectorAll('[data-game-status="inprogress"]');
            liveCards.forEach(card => card.classList.remove('score-updating'));
            
            return hasLiveGames();
        }
    }
    
    function startLiveUpdates() {
        if (!hasLiveGames()) {
            return;
        }
        
        const indicator = createUpdateIndicator();
        showUpdateIndicator(indicator, 'Live updates starting...');
        
        // Update every 30 seconds when games are live
        updateInterval = setInterval(async () => {
            const stillHasLiveGames = await updateLiveScores();
            
            if (!stillHasLiveGames) {
                // No more live games, stop updates
                clearInterval(updateInterval);
                const indicator = document.querySelector('.live-update-indicator');
                if (indicator) {
                    showUpdateIndicator(indicator, 'All games completed');
                    setTimeout(() => {
                        indicator.remove();
                    }, 3000);
                }
            }
        }, 30000); // Update every 30 seconds
        
        // Also update when user returns to tab (visibility change)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && hasLiveGames()) {
                // User returned to tab, update immediately if it's been more than 10 seconds
                if (Date.now() - lastUpdateTime > 10000) {
                    updateLiveScores();
                }
            }
        });
    }
    
    // Start live updates when page loads if there are live games
    if (hasLiveGames()) {
        // Initial delay to let page fully load
        setTimeout(startLiveUpdates, 2000);
    }
    
    // Restart live updates when filter changes to show live games
    const originalFilterGames = filterGames;
    filterGames = function(filterType) {
        originalFilterGames(filterType);
        
        // If user filters to show live games and there are live games, start updates
        if ((filterType === 'all' || filterType === 'live') && hasLiveGames() && !updateInterval) {
            setTimeout(startLiveUpdates, 1000);
        }
    };
    
    </script>

{% endblock %}