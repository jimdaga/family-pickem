{% extends 'pickem/base.html' %}
{% load static %}
{% load pickem_homepage_extras %}

{% block mobile_title %}
    <div class="mobile-page-header">
        <h2 class="mobile-title-text">
            <i class="fas fa-edit me-2"></i>Submit Your Picks
        </h2>
        <div class="mobile-subtitle">
            {% if competition == 'nfl-preseason' %}
                Preseason - Week {{ week }}
            {% else %}
                Regular Season - Week {{ week }}
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block content %}
    <div class="container picks-main-container">
        <div class="col">
            <!-- Page Header -->
            <div class="page-header-clean text-center d-none d-lg-block mb-4">
                <h2 class="page-title">
                    <i class="fas fa-edit me-2"></i>Submit Your Picks
                </h2>
                <p class="page-subtitle">
                    {% if competition == 'nfl-preseason' %}
                        Preseason - Week {{ week }}
                    {% else %}
                        Regular Season - Week {{ week }}
                    {% endif %}
                </p>
            </div>            

            <!-- Pick Progress Summary -->
            <div class="section-container mb-4">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-chart-pie me-2"></i>Your Progress
                    </h3>
                </div>
                
                <div class="progress-summary">
                    {% with game_list|length as total_games %}
                    {% with pick_slugs|length as submitted_picks %}
                    <div class="progress-stats">
                        <div class="progress-stat-item">
                            <div class="progress-stat-value">{{ submitted_picks }}</div>
                            <div class="progress-stat-label">Picks Submitted</div>
                        </div>
                        <div class="progress-stat-divider">/</div>
                        <div class="progress-stat-item">
                            <div class="progress-stat-value">{{ total_games }}</div>
                            <div class="progress-stat-label">Total Games</div>
                        </div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" style="width: {% widthratio submitted_picks total_games 100 %}%"></div>
                    </div>
                    <div class="progress-percentage">
                        {% widthratio submitted_picks total_games 100 %}% Complete
                    </div>
                    {% endwith %}
                    {% endwith %}
                </div>
            </div>

            <!-- Available Games Section -->
            {% if auth_required %}
            <div class="section-container text-center">
                <i class="fas fa-lock fa-3x text-muted mb-3"></i>
                <h4 class="mb-2">Sign in to submit your picks</h4>
                <p class="text-muted">You need to be logged in to make or edit picks. Please sign in and try again.</p>
                <a href="/accounts/google/login/" class="btn btn-primary mt-2">
                    <i class="fab fa-google me-2"></i>Sign in with Google
                </a>
            </div>
            {% elif game_list %}
            <div class="section-container mb-4">
                <div class="section-header">
                    <h3 class="section-title">
                        {% with game_list|length as total_games %}
                        {% with pick_slugs|length as submitted_picks %}
                        {% if total_games == submitted_picks and total_games > 0 %}
                            <i class="fas fa-check-circle me-2"></i>You've submitted all your picks!
                        {% else %}
                            <i class="fas fa-football-ball me-2"></i>Make Your Picks
                            <span class="games-remaining-badge">
                                {{ total_games|sub:submitted_picks }} remaining
                            </span>
                        {% endif %}
                        {% endwith %}
                        {% endwith %}
                    </h3>
                </div>
                
                <div class="games-grid">
                    {% for game in game_list %}
                     {% if game.slug not in pick_slugs %}
                        {% with user.id|addstr:"-"|addstr:game.id as template %}
                            {% if template not in pick_ids %}
                                <div class="game-card {% if auth_required %}disabled-card{% endif %}" data-game-id="{{ game.id }}">
                                    <!-- Game Header -->
                                    <div class="game-header">
                                        <div class="game-date">
                                            <i class="fas fa-calendar me-2"></i>
                                            {{ game.startTimestamp|date:"D, M d" }}
                                        </div>
                                        <div class="game-time">
                                            {{ game.startTimestamp|date:"g:i A" }}
                                        </div>
                                        {% if game.statusType != 'notstarted' %}
                                        <div class="game-status locked">
                                            <i class="fas fa-lock me-1"></i>
                                            Game Started
                                        </div>
                                        {% else %}
                                        <div class="game-status available">
                                            <i class="fas fa-check-circle me-1"></i>
                                            Available
                                        </div>
                                        {% endif %}
                                    </div>

                                    <!-- Game Info (Spread, Weather, etc.) -->
                                    {% if game.spread or game.overUnder or game.temperature or game.weatherCondition %}
                                    <div class="game-info-bar">
                                        {% if game.spread %}
                                        <div class="game-info-item spread-item">
                                            <i class="fas fa-chart-line me-1"></i>
                                            <span class="info-label">Spread:</span>
                                            <span class="info-value spread-value">
                                                {% if game.spread > 0 %}
                                                    {% with game.homeTeamSlug|lookuplogo as logo_url %}
                                                    <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}" alt="{{ game.homeTeamName }} logo" class="spread-team-logo">
                                                    {% endwith %}
                                                    -{{ game.spread|floatformat:1 }}
                                                {% else %}
                                                    {% with game.awayTeamSlug|lookuplogo as logo_url %}
                                                    <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}" alt="{{ game.awayTeamName }} logo" class="spread-team-logo">
                                                    {% endwith %}
                                                    -{{ game.spread|floatformat:1|cut:"-" }}
                                                {% endif %}
                                            </span>
                                        </div>
                                        {% endif %}
                                        {% if game.overUnder %}
                                        <div class="game-info-item">
                                            <i class="fas fa-calculator me-1"></i>
                                            <span class="info-label">O/U:</span>
                                            <span class="info-value">{{ game.overUnder|floatformat:1 }}</span>
                                        </div>
                                        {% endif %}
                                        {% if game.temperature and game.weatherCondition %}
                                        <div class="game-info-item">
                                            {% if 'Sun' in game.weatherCondition or 'Clear' in game.weatherCondition %}
                                                <i class="fas fa-sun me-1" title="Sunny/Clear"></i>
                                            {% elif 'Cloud' in game.weatherCondition %}
                                                <i class="fas fa-cloud me-1" title="Cloudy"></i>
                                            {% elif 'Rain' in game.weatherCondition or 'Shower' in game.weatherCondition %}
                                                <i class="fas fa-cloud-rain me-1" title="Rainy"></i>
                                            {% elif 'Snow' in game.weatherCondition %}
                                                <i class="fas fa-snowflake me-1" title="Snowy"></i>
                                            {% elif 'Storm' in game.weatherCondition or 'Thunder' in game.weatherCondition %}
                                                <i class="fas fa-bolt me-1" title="Stormy"></i>
                                            {% elif 'Wind' in game.weatherCondition %}
                                                <i class="fas fa-wind me-1" title="Windy"></i>
                                            {% elif 'Fog' in game.weatherCondition %}
                                                <i class="fas fa-smog me-1" title="Foggy"></i>
                                            {% else %}
                                                <i class="fas fa-thermometer-half me-1" title="Weather"></i>
                                            {% endif %}
                                            <span class="info-value">{{ game.temperature }}°F, {{ game.weatherCondition }}</span>
                                        </div>
                                        {% endif %}
                                        {% if game.venueIndoor %}
                                        <div class="game-info-item">
                                            <i class="fas fa-home me-1"></i>
                                            <span class="info-value">Indoor</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}

                                    <!-- Team Selection -->
                                    <div class="team-selection">
                                        <!-- Away Team -->
                                        <div class="team-option {% if game.statusType != 'notstarted' or auth_required %}disabled{% endif %}"
                                             data-team="{{ game.awayTeamSlug }}"
                                             data-team-name="{{ game.awayTeamName }}">
                                            <div class="team-logo-container">
                                                {% with game.awayTeamSlug|lookuplogo as logo_url %}
                                                <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}" 
                                                     alt="{{ game.awayTeamName }} logo" 
                                                     class="team-logo">
                                                {% endwith %}
                                            </div>
                                            <div class="team-info">
                                                <div class="team-name">{{ game.awayTeamName }}</div>
                                                <div class="team-details">
                                                    <div class="team-record">
                                                        {% for team in wins_losses %}
                                                            {% if team.teamNameSlug == game.awayTeamSlug %}
                                                                {% if team.teamTies > 0 %}
                                                                    ({{ team.teamWins }}-{{ team.teamLosses }}-{{ team.teamTies }})
                                                                {% else %}
                                                                    ({{ team.teamWins }}-{{ team.teamLosses }})
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                    {% if game.awayTeamWinProbability %}
                                                    <div class="win-probability">
                                                        <i class="fas fa-percentage me-1"></i>{{ game.awayTeamWinProbability|floatformat:0 }}% chance
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="team-selection-indicator">
                                                <i class="fas fa-check"></i>
                                            </div>
                                        </div>

                                        <!-- VS Divider -->
                                        <div class="vs-divider">
                                            <span class="vs-text">VS</span>
                                            <div class="at-indicator">@</div>
                                        </div>

                                        <!-- Home Team -->
                                        <div class="team-option {% if game.statusType != 'notstarted' or auth_required %}disabled{% endif %}"
                                             data-team="{{ game.homeTeamSlug }}"
                                             data-team-name="{{ game.homeTeamName }}">
                                            <div class="team-logo-container">
                                                {% with game.homeTeamSlug|lookuplogo as logo_url %}
                                                <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}" 
                                                     alt="{{ game.homeTeamName }} logo" 
                                                     class="team-logo">
                                                {% endwith %}
                                            </div>
                                            <div class="team-info">
                                                <div class="team-name">{{ game.homeTeamName }}</div>
                                                <div class="team-details">
                                                    <div class="team-record">
                                                        {% for team in wins_losses %}
                                                            {% if team.teamNameSlug == game.homeTeamSlug %}
                                                                {% if team.teamTies > 0 %}
                                                                    ({{ team.teamWins }}-{{ team.teamLosses }}-{{ team.teamTies }})
                                                                {% else %}
                                                                    ({{ team.teamWins }}-{{ team.teamLosses }})
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                    {% if game.homeTeamWinProbability %}
                                                    <div class="win-probability">
                                                        <i class="fas fa-percentage me-1"></i>{{ game.homeTeamWinProbability|floatformat:0 }}% chance
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="team-selection-indicator">
                                                <i class="fas fa-check"></i>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Tiebreaker Section -->
                                    {% if game.tieBreakerGame %}
                                    <div class="tiebreaker-section">
                                        <div class="tiebreaker-header">
                                            <i class="fas fa-balance-scale me-2"></i>
                                            Tiebreakers Required
                                        </div>
                                        <div class="tiebreaker-inputs">
                                            <div class="tiebreaker-input-group">
                                                <label for="tiebreaker1-{{ game.id }}">Total Points Scored</label>
                                                <input type="number" 
                                                       id="tiebreaker1-{{ game.id }}" 
                                                       name="tieBreakerScore" 
                                                       placeholder="e.g. 45"
                                                       min="0" 
                                                       max="200"
                                                       {% if game.statusType != 'notstarted' %}disabled{% endif %}>
                                            </div>
                                            <div class="tiebreaker-input-group">
                                                <label for="tiebreaker2-{{ game.id }}">Total Yards</label>
                                                <input type="number" 
                                                       id="tiebreaker2-{{ game.id }}" 
                                                       name="tieBreakerYards" 
                                                       placeholder="e.g. 750"
                                                       min="0" 
                                                       max="2000"
                                                       {% if game.statusType != 'notstarted' %}disabled{% endif %}>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}

                                    <!-- Locked Game Message -->
                                    {% if game.statusType != 'notstarted' %}
                                    <div class="locked-message">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>Pick Missed - Game already started!</strong>
                                    </div>
                                    {% endif %}

                                    <!-- Hidden Form Data -->
                                    <form class="pick-form" style="display: none;">
                                        {% csrf_token %}
                                        <input type="hidden" name="id" value="{{ user.id }}-{{ game.id }}">
                                        <input type="hidden" name="userEmail" value="{{ user.email }}">
                                        <input type="hidden" name="userID" value="{{ user.id }}">
                                        <input type="hidden" name="uid" value="{{ user.id }}">
                                        <input type="hidden" name="slug" value="{{ game.slug }}">
                                        <input type="hidden" name="competition" value="{{ game.competition }}">
                                        <input type="hidden" name="gameWeek" value="{{ game.gameWeek }}">
                                        <input type="hidden" name="gameyear" value="{{ game.gameyear }}">
                                        <input type="hidden" name="gameseason" value="{{ game.gameseason }}">
                                        <input type="hidden" name="pick_game_id" value="{{ game.id }}">
                                        <input type="hidden" name="pick" value="">
                                        <input type="hidden" name="tieBreakerScore" value="">
                                        <input type="hidden" name="tieBreakerYards" value="">
                                    </form>

                                    <!-- Save Status Indicator -->
                                    <div class="save-status" style="display: none;">
                                        <div class="save-indicator saving">
                                            <i class="fas fa-spinner fa-spin me-2"></i>
                                            Saving...
                                        </div>
                                        <div class="save-indicator success">
                                            <i class="fas fa-check-circle me-2"></i>
                                            Saved!
                                        </div>
                                        <div class="save-indicator error">
                                            <i class="fas fa-exclamation-circle me-2"></i>
                                            Error saving
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endwith %}
                    {% endif %}
                    {% endfor %}
                </div>
            </div>

            <!-- Submitted Picks Section -->
            <div class="section-container">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-check-square me-2"></i>Submitted Picks
                        <span class="submitted-count-badge">{{ pick_slugs|length }}</span>
                    </h3>
                </div>
                
                <div class="submitted-picks-grid">
                    {% if pick_slugs and not auth_required %}
                        {% for game in game_list %}
                        {% if game.slug in pick_slugs %}
                            {% with user.id|addstr:"-"|addstr:game.id as template %}
                                {% if template in pick_ids %}
                                <div class="submitted-game-card">
                                    <div class="submitted-game-header">
                                        <div class="game-date-small">
                                            {{ game.startTimestamp|date:"M d @ g:i A" }}
                                        </div>
                                        <div class="submitted-header-actions">
                                            <div class="submitted-badge">
                                                <i class="fas fa-check me-1"></i>
                                                Submitted
                                            </div>
                                        </div>
                                    </div>

                                    <div class="submitted-matchup">
                                        {% for p in picks %}
                                            {% if p.slug == game.slug %}
                                                <!-- Away Team -->
                                                <div class="submitted-team {% if p.pick != game.awayTeamSlug %}not-selected{% endif %}">
                                                    {% with game.awayTeamSlug|lookuplogo as logo_url %}
                                                    <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}" 
                                                         alt="{{ game.awayTeamName }} logo" 
                                                         class="submitted-team-logo">
                                                    {% endwith %}
                                                    <div class="submitted-team-info">
                                                        <div class="submitted-team-name">{{ game.awayTeamName }}</div>
                                                        {% if p.pick == game.awayTeamSlug %}
                                                            <div class="your-pick-indicator">
                                                                <i class="fas fa-star me-1"></i>Your Pick
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>

                                                <!-- VS -->
                                                <div class="submitted-vs">@</div>

                                                <!-- Home Team -->
                                                <div class="submitted-team {% if p.pick != game.homeTeamSlug %}not-selected{% endif %}">
                                                    {% with game.homeTeamSlug|lookuplogo as logo_url %}
                                                    <img src="{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}" 
                                                         alt="{{ game.homeTeamName }} logo" 
                                                         class="submitted-team-logo">
                                                    {% endwith %}
                                                    <div class="submitted-team-info">
                                                        <div class="submitted-team-name">{{ game.homeTeamName }}</div>
                                                        {% if p.pick == game.homeTeamSlug %}
                                                            <div class="your-pick-indicator">
                                                                <i class="fas fa-star me-1"></i>Your Pick
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>

                                                <!-- Tiebreaker Info -->
                                                {% if game.tieBreakerGame and p.tieBreakerScore and p.tieBreakerYards %}
                                                <div class="tiebreaker-info">
                                                    <div class="tiebreaker-item">
                                                        <span class="tiebreaker-label">Points:</span>
                                                        <span class="tiebreaker-value">{{ p.tieBreakerScore }}</span>
                                                    </div>
                                                    <div class="tiebreaker-item">
                                                        <span class="tiebreaker-label">Yards:</span>
                                                        <span class="tiebreaker-value">{{ p.tieBreakerYards }}</span>
                                                    </div>
                                                </div>
                                                {% endif %}


                                            {% endif %}
                                        {% endfor %}
                                    </div>

                                    <!-- Edit/Lock Actions - Always at bottom -->
                                    <div class="submitted-pick-actions">
                                        {% if not game|is_game_locked %}
                                        {% for p in picks %}
                                            {% if p.slug == game.slug %}
                                        <button class="edit-pick-btn" 
                                                data-game-id="{{ game.id }}" 
                                                data-pick-id="{{ p.id }}"
                                                data-game-slug="{{ game.slug }}"
                                                data-current-pick="{{ p.pick }}"
                                                data-away-team="{{ game.awayTeamSlug }}"
                                                data-away-name="{{ game.awayTeamName }}"
                                                data-home-team="{{ game.homeTeamSlug }}"
                                                data-home-name="{{ game.homeTeamName }}"
                                                data-away-logo="{% with game.awayTeamSlug|lookuplogo as logo_url %}{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}{% endwith %}"
                                                data-home-logo="{% with game.homeTeamSlug|lookuplogo as logo_url %}{{ logo_url.teamLogo|default:'/static/images/nfl.svg' }}{% endwith %}"
                                                data-is-tiebreaker="{{ game.tieBreakerGame|yesno:'true,false' }}"
                                                data-tiebreaker-score="{{ p.tieBreakerScore|default:'' }}"
                                                data-tiebreaker-yards="{{ p.tieBreakerYards|default:'' }}"
                                                data-spread="{{ game.spread|default:'' }}"
                                                data-over-under="{{ game.overUnder|default:'' }}"
                                                data-temperature="{{ game.temperature|default:'' }}"
                                                data-weather-condition="{{ game.weatherCondition|default:'' }}"
                                                data-venue-indoor="{{ game.venueIndoor|yesno:'true,false' }}"
                                                data-home-win-probability="{{ game.homeTeamWinProbability|default:'' }}"
                                                data-away-win-probability="{{ game.awayTeamWinProbability|default:'' }}">
                                            <i class="fas fa-edit me-1"></i>
                                            Edit Pick
                                        </button>
                                            {% endif %}
                                        {% endfor %}
                                        {% else %}
                                        <div class="pick-locked-indicator">
                                            <i class="fas fa-lock me-1"></i>
                                            Pick Locked - {{ game|game_lock_reason }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            {% endwith %}
                        {% endif %}
                        {% endfor %}
                    {% else %}
                        <div class="no-picks-message">
                            <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No picks submitted yet. Get started above!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="section-container">
                <div class="no-games-message text-center">
                    <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                    {% if is_default_week %}
                    <h4 class="text-primary">Ready for Week {{ week }}?</h4>
                    <p class="text-muted mb-4">The NFL schedule for Week {{ week }} is being finalized. Games will appear here once released, but you can check back soon to start making your picks!</p>
                    <div class="season-prep-info">
                        <div class="prep-card">
                            <i class="fas fa-trophy fa-2x text-warning mb-2"></i>
                            <h6>Get Ready</h6>
                            <p class="small text-muted">Review team stats and prepare your strategy for the upcoming season.</p>
                        </div>
                        <div class="prep-card">
                            <i class="fas fa-users fa-2x text-info mb-2"></i>
                            <h6>Join the Competition</h6>
                            <p class="small text-muted">Week {{ week }} picks will be available as soon as games are scheduled.</p>
                        </div>
                        <div class="prep-card">
                            <i class="fas fa-chart-line fa-2x text-success mb-2"></i>
                            <h6>Track Progress</h6>
                            <p class="small text-muted">Check the scores page for live updates once the season begins.</p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <a href="{% url 'scores' %}" class="btn btn-outline-primary me-2">
                            <i class="fas fa-chart-line me-1"></i>View Scores
                        </a>
                        <a href="{% url 'standings' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-trophy me-1"></i>Standings
                        </a>
                    </div>
                    {% else %}
                    <h4 class="text-muted">No games available for this week</h4>
                    <p class="text-muted">Check back later or view other weeks.</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Edit Pick Modal -->
    <div class="modal fade" id="editPickModal" tabindex="-1" aria-labelledby="editPickModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editPickModalLabel">
                        <i class="fas fa-edit me-2"></i>Edit Your Pick
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editPickForm">
                        {% csrf_token %}
                        <input type="hidden" id="editPickId" name="pick_id">
                        <input type="hidden" id="editGameId" name="game_id">
                        <input type="hidden" id="editGameSlug" name="slug">
                        <input type="hidden" name="userEmail" value="{{ user.email }}">
                        <input type="hidden" name="userID" value="{{ user.id }}">
                        <input type="hidden" name="uid" value="{{ user.id }}">

                        <!-- Game Info -->
                        <div class="edit-game-info mb-4">
                            <h6 class="game-title" id="editGameTitle"></h6>
                            <div class="game-time" id="editGameTime"></div>
                        </div>

                        <!-- Game Stats (Spread, Weather, etc.) -->
                        <div id="editGameStatsBar" class="game-info-bar mb-4" style="display: none;">
                            <div id="editSpreadInfo" class="game-info-item" style="display: none;">
                                <i class="fas fa-chart-line me-1"></i>
                                <span class="info-label">Spread:</span>
                                <span class="info-value" id="editSpreadValue"></span>
                            </div>
                            <div id="editOverUnderInfo" class="game-info-item" style="display: none;">
                                <i class="fas fa-calculator me-1"></i>
                                <span class="info-label">O/U:</span>
                                <span class="info-value" id="editOverUnderValue"></span>
                            </div>
                            <div id="editWeatherInfo" class="game-info-item" style="display: none;">
                                <i class="fas fa-thermometer-half me-1"></i>
                                <span class="info-value" id="editWeatherValue"></span>
                            </div>
                            <div id="editVenueInfo" class="game-info-item" style="display: none;">
                                <i class="fas fa-home me-1"></i>
                                <span class="info-value">Indoor</span>
                            </div>
                        </div>

                        <!-- Team Selection -->
                        <div class="edit-team-selection mb-4">
                            <h6 class="mb-3">Select Your Pick:</h6>
                            <div class="team-options-edit">
                                <div class="team-option-edit" id="editAwayTeam">
                                    <div class="team-logo-container">
                                        <img id="editAwayLogo" src="" alt="" class="team-logo-edit">
                                    </div>
                                    <div class="team-name-edit" id="editAwayName"></div>
                                    <div id="editAwayWinProb" class="win-probability" style="display: none;">
                                        <i class="fas fa-percentage me-1"></i><span id="editAwayWinProbValue"></span>% chance
                                    </div>
                                    <div class="selection-indicator">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </div>
                                <div class="vs-divider-edit">VS</div>
                                <div class="team-option-edit" id="editHomeTeam">
                                    <div class="team-logo-container">
                                        <img id="editHomeLogo" src="" alt="" class="team-logo-edit">
                                    </div>
                                    <div class="team-name-edit" id="editHomeName"></div>
                                    <div id="editHomeWinProb" class="win-probability" style="display: none;">
                                        <i class="fas fa-percentage me-1"></i><span id="editHomeWinProbValue"></span>% chance
                                    </div>
                                    <div class="selection-indicator">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tiebreaker Section -->
                        <div id="editTiebreakerSection" class="edit-tiebreaker-section mb-4" style="display: none;">
                            <h6 class="mb-3">
                                <i class="fas fa-balance-scale me-2"></i>Tiebreakers
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="editTiebreakerScore">Total Points Scored</label>
                                        <input type="number" id="editTiebreakerScore" name="tieBreakerScore" 
                                               class="form-control" placeholder="e.g. 45" min="0" max="200">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="editTiebreakerYards">Total Yards</label>
                                        <input type="number" id="editTiebreakerYards" name="tieBreakerYards" 
                                               class="form-control" placeholder="e.g. 750" min="0" max="2000">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-primary" id="saveEditPickBtn">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Auto-save JavaScript -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle team selection clicks
        document.querySelectorAll('.team-option:not(.disabled)').forEach(option => {
            option.addEventListener('click', function() {
                const gameCard = this.closest('.game-card');
                const gameId = gameCard.dataset.gameId;
                const selectedTeam = this.dataset.team;
                const teamName = this.dataset.teamName;
                
                // Remove selection from all teams in this game
                gameCard.querySelectorAll('.team-option').forEach(team => {
                    team.classList.remove('selected');
                });
                
                // Add selection to clicked team
                this.classList.add('selected');
                
                // Auto-save the pick
                savePick(gameCard, selectedTeam);
            });
        });

        // Handle tiebreaker input changes
        document.querySelectorAll('.tiebreaker-section input').forEach(input => {
            input.addEventListener('change', function() {
                const gameCard = this.closest('.game-card');
                const selectedTeam = gameCard.querySelector('.team-option.selected');
                
                if (selectedTeam) {
                    savePick(gameCard, selectedTeam.dataset.team);
                }
            });
        });

        function savePick(gameCard, selectedTeam) {
            console.log('savePick called with:', selectedTeam);
            const form = gameCard.querySelector('.pick-form');
            const saveStatus = gameCard.querySelector('.save-status');
            const tiebreakerScore = gameCard.querySelector('input[name="tieBreakerScore"]');
            const tiebreakerYards = gameCard.querySelector('input[name="tieBreakerYards"]');
            
            console.log('Form found:', form);
            console.log('Save status found:', saveStatus);
            
            if (!form) {
                console.error('Form not found in game card');
                return;
            }
            if (!saveStatus) {
                console.error('Save status not found in game card');
                return;
            }
            
            // Check if this is a tiebreaker game and validate
            const tiebreakerSection = gameCard.querySelector('.tiebreaker-section');
            if (tiebreakerSection) {
                // This is a tiebreaker game - validate both fields are filled
                const scoreValue = tiebreakerScore ? tiebreakerScore.value.trim() : '';
                const yardsValue = tiebreakerYards ? tiebreakerYards.value.trim() : '';
                
                // For tiebreaker games, both fields must be filled
                if (!scoreValue || !yardsValue) {
                    // Show validation message
                    let validationMsg = tiebreakerSection.querySelector('.tiebreaker-validation');
                    
                    if (!validationMsg) {
                        validationMsg = document.createElement('div');
                        validationMsg.className = 'tiebreaker-validation text-warning mt-2';
                        validationMsg.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Both tiebreaker fields are required to save';
                        tiebreakerSection.appendChild(validationMsg);
                    }
                    
                    // Remove validation message after 3 seconds
                    setTimeout(() => {
                        if (validationMsg.parentNode) {
                            validationMsg.remove();
                        }
                    }, 3000);
                    
                    return; // Don't save if tiebreaker is incomplete
                }
            }
            
            // Update form data
            const pickInput = form.querySelector('input[name="pick"]');
            console.log('Pick input found:', pickInput);
            if (pickInput) {
                pickInput.value = selectedTeam;
                console.log('Set pick value to:', selectedTeam);
            }
            
            if (tiebreakerScore) {
                const tiebreakerScoreInput = form.querySelector('input[name="tieBreakerScore"]');
                if (tiebreakerScoreInput) {
                    tiebreakerScoreInput.value = tiebreakerScore.value || '';
                }
            }
            if (tiebreakerYards) {
                const tiebreakerYardsInput = form.querySelector('input[name="tieBreakerYards"]');
                if (tiebreakerYardsInput) {
                    tiebreakerYardsInput.value = tiebreakerYards.value || '';
                }
            }
            
            // Show saving indicator
            saveStatus.style.display = 'block';
            saveStatus.querySelector('.saving').style.display = 'flex';
            saveStatus.querySelector('.success').style.display = 'none';
            saveStatus.querySelector('.error').style.display = 'none';
            
            // Prepare form data
            const formData = new FormData(form);
            console.log('About to submit form data:', formData);
            
            // Submit the pick
            fetch('/picks/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
            .then(response => {
                console.log('Response received:', response);
                if (response.ok) {
                    console.log('Save successful');
                    // Show success indicator briefly
                    saveStatus.querySelector('.saving').style.display = 'none';
                    saveStatus.querySelector('.success').style.display = 'flex';
                    
                    // Quick reload to update the page and move card to submitted section
                    setTimeout(() => {
                        window.location.reload();
                    }, 300);
                } else {
                    console.error('Save failed with status:', response.status);
                    throw new Error('Save failed');
                }
            })
            .catch(error => {
                // Show error indicator
                saveStatus.querySelector('.saving').style.display = 'none';
                saveStatus.querySelector('.error').style.display = 'flex';
                
                // Hide error after 3 seconds
                setTimeout(() => {
                    saveStatus.style.display = 'none';
                }, 3000);
                
                console.error('Error saving pick:', error);
            });
        }

        // Edit Pick Functionality
        document.querySelectorAll('.edit-pick-btn').forEach(button => {
            button.addEventListener('click', function() {
                const gameId = this.dataset.gameId;
                const pickId = this.dataset.pickId;
                const gameSlug = this.dataset.gameSlug;
                const currentPick = this.dataset.currentPick;
                const awayTeam = this.dataset.awayTeam;
                const awayName = this.dataset.awayName;
                const homeTeam = this.dataset.homeTeam;
                const homeName = this.dataset.homeName;
                const awayLogo = this.dataset.awayLogo;
                const homeLogo = this.dataset.homeLogo;
                const isTiebreaker = this.dataset.isTiebreaker === 'true';
                const tiebreakerScore = this.dataset.tiebreakerScore;
                const tiebreakerYards = this.dataset.tiebreakerYards;
                const spread = this.dataset.spread;
                const overUnder = this.dataset.overUnder;
                const temperature = this.dataset.temperature;
                const weatherCondition = this.dataset.weatherCondition;
                const venueIndoor = this.dataset.venueIndoor === 'true';
                const homeWinProbability = this.dataset.homeWinProbability;
                const awayWinProbability = this.dataset.awayWinProbability;

                // Populate modal with game data
                document.getElementById('editPickId').value = pickId;
                document.getElementById('editGameId').value = gameId;
                document.getElementById('editGameSlug').value = gameSlug;
                document.getElementById('editGameTitle').textContent = `${awayName} @ ${homeName}`;
                
                // Set team information
                document.getElementById('editAwayName').textContent = awayName;
                document.getElementById('editHomeName').textContent = homeName;
                document.getElementById('editAwayTeam').dataset.team = awayTeam;
                document.getElementById('editHomeTeam').dataset.team = homeTeam;
                
                // Set team logos
                document.getElementById('editAwayLogo').src = awayLogo;
                document.getElementById('editAwayLogo').alt = `${awayName} logo`;
                document.getElementById('editHomeLogo').src = homeLogo;
                document.getElementById('editHomeLogo').alt = `${homeName} logo`;

                // Set win probabilities
                const awayWinProbElement = document.getElementById('editAwayWinProb');
                const homeWinProbElement = document.getElementById('editHomeWinProb');
                
                if (awayWinProbability && awayWinProbability !== '') {
                    document.getElementById('editAwayWinProbValue').textContent = Math.round(parseFloat(awayWinProbability));
                    awayWinProbElement.style.display = 'flex';
                } else {
                    awayWinProbElement.style.display = 'none';
                }
                
                if (homeWinProbability && homeWinProbability !== '') {
                    document.getElementById('editHomeWinProbValue').textContent = Math.round(parseFloat(homeWinProbability));
                    homeWinProbElement.style.display = 'flex';
                } else {
                    homeWinProbElement.style.display = 'none';
                }

                // Set current selection
                document.querySelectorAll('.team-option-edit').forEach(option => {
                    option.classList.remove('selected');
                });
                
                if (currentPick === awayTeam) {
                    document.getElementById('editAwayTeam').classList.add('selected');
                } else if (currentPick === homeTeam) {
                    document.getElementById('editHomeTeam').classList.add('selected');
                }

                // Handle tiebreaker
                const tiebreakerSection = document.getElementById('editTiebreakerSection');
                if (isTiebreaker) {
                    tiebreakerSection.style.display = 'block';
                    document.getElementById('editTiebreakerScore').value = tiebreakerScore || '';
                    document.getElementById('editTiebreakerYards').value = tiebreakerYards || '';
                } else {
                    tiebreakerSection.style.display = 'none';
                }

                // Handle game stats bar
                const statsBar = document.getElementById('editGameStatsBar');
                const spreadInfo = document.getElementById('editSpreadInfo');
                const overUnderInfo = document.getElementById('editOverUnderInfo');
                const weatherInfo = document.getElementById('editWeatherInfo');
                const venueInfo = document.getElementById('editVenueInfo');
                
                let hasStats = false;

                // Show spread if available
                if (spread && spread !== '') {
                    const spreadValue = parseFloat(spread);
                    const spreadElement = document.getElementById('editSpreadValue');
                    
                    if (spreadValue > 0) {
                        spreadElement.innerHTML = `<img src="${homeLogo}" alt="${homeName} logo" class="spread-team-logo"> -${Math.abs(spreadValue).toFixed(1)}`;
                    } else {
                        spreadElement.innerHTML = `<img src="${awayLogo}" alt="${awayName} logo" class="spread-team-logo"> -${Math.abs(spreadValue).toFixed(1)}`;
                    }
                    spreadInfo.style.display = 'flex';
                    hasStats = true;
                } else {
                    spreadInfo.style.display = 'none';
                }

                // Show over/under if available
                if (overUnder && overUnder !== '') {
                    document.getElementById('editOverUnderValue').textContent = parseFloat(overUnder).toFixed(1);
                    overUnderInfo.style.display = 'flex';
                    hasStats = true;
                } else {
                    overUnderInfo.style.display = 'none';
                }

                // Show weather if available
                if (temperature && weatherCondition) {
                    document.getElementById('editWeatherValue').textContent = `${temperature}°F, ${weatherCondition}`;
                    weatherInfo.style.display = 'flex';
                    hasStats = true;
                } else {
                    weatherInfo.style.display = 'none';
                }

                // Show venue if indoor
                if (venueIndoor) {
                    venueInfo.style.display = 'flex';
                    hasStats = true;
                } else {
                    venueInfo.style.display = 'none';
                }

                // Show/hide the entire stats bar
                statsBar.style.display = hasStats ? 'flex' : 'none';

                // Show modal
                new bootstrap.Modal(document.getElementById('editPickModal')).show();
            });
        });

        // Edit modal team selection
        document.querySelectorAll('.team-option-edit').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.team-option-edit').forEach(opt => {
                    opt.classList.remove('selected');
                });
                this.classList.add('selected');
            });
        });

        // Save edited pick
        document.getElementById('saveEditPickBtn').addEventListener('click', function() {
            const form = document.getElementById('editPickForm');
            const selectedTeam = document.querySelector('.team-option-edit.selected');
            
            if (!selectedTeam) {
                alert('Please select a team');
                return;
            }

            const formData = new FormData(form);
            formData.set('pick', selectedTeam.dataset.team);

            // Validate tiebreaker if required
            const tiebreakerSection = document.getElementById('editTiebreakerSection');
            if (tiebreakerSection.style.display !== 'none') {
                const score = document.getElementById('editTiebreakerScore').value;
                const yards = document.getElementById('editTiebreakerYards').value;
                
                if (!score || !yards) {
                    alert('Please fill in both tiebreaker fields');
                    return;
                }
            }

            // Show loading state
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

            // Submit update
            fetch('/picks/edit/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
            .then(response => {
                if (response.ok) {
                    // Close modal and reload page
                    bootstrap.Modal.getInstance(document.getElementById('editPickModal')).hide();
                    window.location.reload();
                } else {
                    throw new Error('Update failed');
                }
            })
            .catch(error => {
                alert('Error updating pick. Please try again.');
                console.error('Error updating pick:', error);
            })
            .finally(() => {
                // Reset button state
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-save me-1"></i>Save Changes';
            });
        });
    });
    </script>

{% endblock %}